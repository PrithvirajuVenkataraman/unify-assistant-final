<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Unify Voice Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=jQZ2zpcE"></script>
    <style>
        @keyframes waveform {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.5); }
        }
        .wave-bar {
            animation: waveform 0.8s ease-in-out infinite;
        }
        body.dark {
            background: #000;
        }
        body.light {
            background: linear-gradient(to bottom right, #fce7f3, #e9d5ff, #c7d2fe);
        }
        
        /* Light Switch Styles */
        .light-switch-container {
            position: relative;
            width: 80px;
            height: 140px;
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1),
                        inset 0 1px 0 rgba(255,255,255,0.8);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .light-switch {
            width: 40px;
            height: 70px;
            background: #fff;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .switch-toggle {
            width: 36px;
            height: 32px;
            background: linear-gradient(145deg, #f0f0f0, #d9d9d9);
            border-radius: 3px;
            position: absolute;
            left: 2px;
            top: 2px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3),
                        inset 0 1px 0 rgba(255,255,255,0.8);
        }
        
        .switch-toggle::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 3px;
            background: #999;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 2px;
        }
        
        .light-switch.on .switch-toggle {
            top: 36px;
            background: linear-gradient(145deg, #d9d9d9, #c9c9c9);
        }
        
        /* Tube Light */
        .tube-light-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            pointer-events: none;
        }
        
        .tube-light {
            width: 200px;
            height: 30px;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.1),
                rgba(200, 200, 200, 0.2),
                rgba(255, 255, 255, 0.1));
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .tube-light::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%);
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .tube-light.on {
            background: linear-gradient(to bottom,
                rgba(255, 255, 255, 0.95),
                rgba(240, 248, 255, 1),
                rgba(255, 255, 255, 0.95));
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                        0 0 40px rgba(200, 220, 255, 0.6),
                        inset 0 2px 5px rgba(255,255,255,0.5);
        }
        
        .tube-light.on::before {
            opacity: 1;
            animation: tube-flicker 0.1s ease-in-out 2;
        }
        
        .tube-light-glow {
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: radial-gradient(ellipse at center,
                rgba(255, 255, 255, 0.4) 0%,
                transparent 70%);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        
        .tube-light.on + .tube-light-glow {
            opacity: 1;
        }
        
        @keyframes tube-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes tube-startup {
            0% { opacity: 0; }
            10% { opacity: 0.3; }
            20% { opacity: 0; }
            30% { opacity: 0.6; }
            40% { opacity: 0.2; }
            50% { opacity: 0.8; }
            60% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .tube-light.starting {
            animation: tube-startup 0.8s ease-in-out;
        }
        
        /* Alarm notification styles */
        .alarm-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-5deg); }
            75% { transform: translate(-50%, -50%) rotate(5deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Weather Background Effects */
        .weather-effect {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Snowflakes */
        @keyframes snowfall {
            0% {
                transform: translateY(-10px) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) translateX(50px);
                opacity: 0.3;
            }
        }
        
        .snowflake {
            position: absolute;
            top: -10px;
            color: white;
            font-size: 1em;
            animation: snowfall linear infinite;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
        }
        
        /* Rain */
        @keyframes rainfall {
            0% {
                transform: translateY(-10px);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh);
                opacity: 0.3;
            }
        }
        
        .raindrop {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(174, 194, 224, 0.8), rgba(174, 194, 224, 0.3));
            animation: rainfall linear infinite;
        }
        
        /* Sun */
        @keyframes sunPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        .sun {
            position: absolute;
            top: 80px;
            right: 100px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 70%, transparent 70%);
            border-radius: 50%;
            animation: sunPulse 4s ease-in-out infinite;
            box-shadow: 0 0 60px #FFD700, 0 0 100px #FFA500;
        }
        
        .sun::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: sunPulse 4s ease-in-out infinite;
        }
        
        /* Clouds */
        @keyframes cloudFloat {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(calc(100vw + 100px)); }
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 100px;
            animation: cloudFloat linear infinite;
        }
        
        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 100px;
        }
        
        .cloud-1 {
            width: 100px;
            height: 40px;
            top: 100px;
            animation-duration: 40s;
        }
        
        .cloud-1::before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }
        
        .cloud-1::after {
            width: 60px;
            height: 40px;
            top: -15px;
            right: 10px;
        }
        
        .cloud-2 {
            width: 120px;
            height: 50px;
            top: 150px;
            animation-duration: 50s;
            animation-delay: -10s;
        }
        
        .cloud-2::before {
            width: 60px;
            height: 60px;
            top: -30px;
            left: 15px;
        }
        
        .cloud-2::after {
            width: 70px;
            height: 50px;
            top: -20px;
            right: 15px;
        }
        
        .cloud-3 {
            width: 90px;
            height: 35px;
            top: 200px;
            animation-duration: 45s;
            animation-delay: -25s;
        }
        
        .cloud-3::before {
            width: 45px;
            height: 45px;
            top: -20px;
            left: 10px;
        }
        
        .cloud-3::after {
            width: 50px;
            height: 35px;
            top: -12px;
            right: 10px;
        }
        
        /* Thunder effect */
        @keyframes lightning {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .lightning {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            animation: lightning 0.2s ease-in-out;
        }
        
        /* Hot day shimmer */
        @keyframes heatShimmer {
            0%, 100% { transform: translateY(0) scaleY(1); }
            50% { transform: translateY(-5px) scaleY(1.1); }
        }
        
        .heat-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(to top, rgba(255, 200, 100, 0.3), transparent);
            animation: heatShimmer 3s ease-in-out infinite;
        }
        
        /* Shopping List Receipt */
        .shopping-receipt {
            position: fixed;
            right: 20px;
            top: 120px;
            width: 280px;
            max-height: calc(100vh - 200px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 20px;
            font-family: 'Courier New', monospace;
            z-index: 50;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        .shopping-receipt.dark-mode {
            background: #1F2937;
            color: #F3F4F6;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #333;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        .receipt-store {
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: #4F46E5;
        }
        
        .receipt-divider {
            font-size: 12px;
            color: #999;
            letter-spacing: 1px;
            margin: 10px 0;
        }
        
        .receipt-thank-you {
            text-align: center;
            font-size: 11px;
            font-style: italic;
            color: #666;
            margin: 10px 0;
        }
        
        .receipt-count-number {
            font-size: 18px;
            font-weight: bold;
            color: #4F46E5;
        }
        
        .shopping-receipt.dark-mode .receipt-header {
            border-bottom-color: #4B5563;
        }
        
        .receipt-title {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .receipt-subtitle {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .shopping-receipt.dark-mode .receipt-subtitle {
            color: #9CA3AF;
        }
        
        .receipt-items {
            margin: 15px 0;
        }
        
        .receipt-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #ddd;
            font-size: 14px;
        }
        
        .shopping-receipt.dark-mode .receipt-item {
            border-bottom-color: #374151;
        }
        
        .receipt-item:last-child {
            border-bottom: none;
        }
        
        .receipt-item-text {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .receipt-bullet {
            color: #8B5CF6;
            font-weight: bold;
        }
        
        .receipt-delete {
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .receipt-delete:hover {
            background: #DC2626;
            transform: scale(1.05);
        }
        
        .receipt-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #333;
            text-align: center;
            font-size: 12px;
        }
        
        .shopping-receipt.dark-mode .receipt-footer {
            border-top-color: #4B5563;
        }
        
        .receipt-total {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .receipt-clear-btn {
            background: #8B5CF6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .receipt-clear-btn:hover {
            background: #7C3AED;
            transform: translateY(-2px);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .shopping-receipt {
                right: 10px;
                top: 100px;
                width: calc(100vw - 20px);
                max-width: 320px;
                max-height: 50vh;
            }
            
            .tube-light-container {
                top: 10px;
            }
            
            .tube-light {
                width: 150px;
                height: 25px;
            }
            
            .light-switch-container {
                width: 60px;
                height: 110px;
                padding: 10px;
            }
            
            .light-switch {
                width: 35px;
                height: 60px;
            }
            
            .switch-toggle {
                width: 31px;
                height: 27px;
            }
            
            .light-switch.on .switch-toggle {
                top: 31px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            
            #main-card {
                padding: 16px;
            }
            
            #chat-container {
                max-height: 250px;
            }
        }
        
        /* Quick Reply Suggestions */
        .quick-reply-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: white;
            border: 2px solid #E5E7EB;
            border-radius: 20px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .quick-reply-btn:hover {
            border-color: #8B5CF6;
            color: #8B5CF6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* Thinking Indicator Animation */
        .thinking-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 12px 20px;
            background: #F3F4F6;
            border-radius: 20px;
            margin: 8px 0;
        }
        
        .thinking-dot {
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            animation: thinking-bounce 1.4s infinite ease-in-out both;
        }
        
        .thinking-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .thinking-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes thinking-bounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        /* Simple Loading Spinner (no overlay) */
        .simple-loading {
            position: fixed;
            top: 50%;
            right: 24px;
            transform: translateY(-50%);
            z-index: 9999;
        }
        
        .simple-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #E5E7EB;
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Direction Buttons & Fast Food Section */
        .direction-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);
        }
        
        .direction-btn:hover {
            background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        
        .direction-btn:active {
            transform: translateY(0);
        }
        
        .fast-food-section {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-radius: 12px;
            border: 2px solid #F59E0B;
        }
        
        .fast-food-section h3 {
            margin: 0 0 12px 0;
            color: #92400E;
            font-size: 18px;
            font-weight: bold;
        }
        
        .fast-food-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .fast-food-btn {
            padding: 10px 16px;
            background: white;
            color: #92400E;
            border: 2px solid #F59E0B;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }
        
        .fast-food-btn:hover {
            background: #F59E0B;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .restaurant-entry {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .restaurant-entry:last-child {
            border-bottom: none;
        }
        
        /* Hotel/Restaurant Name Links */
        .hotel-link {
            color: #7C3AED;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }
        
        .hotel-link:hover {
            color: #6D28D9;
            border-bottom: 2px solid #7C3AED;
        }
    </style>
</head>
<body class="light min-h-screen transition-all duration-500">
    <!-- Help & Tips Overlay -->
    <div id="help-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-8">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">‚ÑπÔ∏è Help & Tips</h2>
                
                <div class="space-y-6">
                    <!-- How to Use -->
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-600">üé§ How to Use Unify</h3>
                        <ul class="space-y-2 text-gray-700">
                            <li>‚Ä¢ Click the microphone button and speak naturally</li>
                            <li>‚Ä¢ Or type your question in the text box</li>
                            <li>‚Ä¢ Speak clearly and wait for my response</li>
                            <li>‚Ä¢ You can interrupt me anytime!</li>
                        </ul>
                    </div>
                    
                    <!-- Capabilities -->
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-600">‚ú® What I Can Do</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900">üå§Ô∏è Weather</p>
                                <p class="text-sm text-gray-600">"What's the weather?"</p>
                                <p class="text-sm text-gray-600">"Will it rain today?"</p>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900">‚úàÔ∏è Travel Planning</p>
                                <p class="text-sm text-gray-600">"Plan a trip to Paris"</p>
                                <p class="text-sm text-gray-600">"3-day itinerary for Tokyo"</p>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900">üè® Hotels</p>
                                <p class="text-sm text-gray-600">"Hotels in Chennai"</p>
                                <p class="text-sm text-gray-600">"Best places to stay"</p>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900">üçΩÔ∏è Restaurants</p>
                                <p class="text-sm text-gray-600">"Best restaurants nearby"</p>
                                <p class="text-sm text-gray-600">"Pure veg options"</p>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900">üõí Shopping Lists</p>
                                <p class="text-sm text-gray-600">"Add milk to my list"</p>
                                <p class="text-sm text-gray-600">"Show shopping list"</p>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900">‚è∞ Reminders</p>
                                <p class="text-sm text-gray-600">"Remind me at 5pm"</p>
                                <p class="text-sm text-gray-600">"Set a reminder"</p>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900">üí≠ Memory</p>
                                <p class="text-sm text-gray-600">"My keys are on the desk"</p>
                                <p class="text-sm text-gray-600">"Where are my keys?"</p>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-gray-900">üí¨ Casual Chat</p>
                                <p class="text-sm text-gray-600">Ask me anything!</p>
                                <p class="text-sm text-gray-600">I'm here to help</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tips -->
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-600">üí° Pro Tips</h3>
                        <ul class="space-y-2 text-gray-700">
                            <li>‚Ä¢ <strong>Be specific:</strong> "Weather in Mason, Ohio" works better than just "weather"</li>
                            <li>‚Ä¢ <strong>Natural language:</strong> Talk to me like you would to a friend</li>
                            <li>‚Ä¢ <strong>Follow-ups:</strong> I remember context, so you can ask follow-up questions</li>
                            <li>‚Ä¢ <strong>Speaker button:</strong> Click the speaker icon on any message to hear it again</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Close Button -->
                <button onclick="hideHelpOverlay()" class="mt-8 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Chat
                </button>
            </div>
        </div>
    </div>
    
    <!-- Weather Effects Container -->
    <div id="weather-effects" class="weather-effect"></div>
    
    <!-- Shopping List Receipt -->
    <div id="shopping-receipt" class="shopping-receipt hidden">
        <div class="receipt-header">
            <div class="receipt-store">üõí UNIFY MARKET</div>
            <div class="receipt-title">SHOPPING LIST</div>
            <div class="receipt-subtitle" id="receipt-date">---</div>
            <div class="receipt-divider">- - - - - - - - - - - - - - - -</div>
        </div>
        <div id="receipt-items" class="receipt-items">
            <div style="text-align: center; color: #999; font-size: 12px; padding: 20px;">
                No items yet
            </div>
        </div>
        <div class="receipt-footer">
            <div class="receipt-divider">- - - - - - - - - - - - - - - -</div>
            <div class="receipt-total">
                <span>TOTAL ITEMS:</span>
                <span id="receipt-count" class="receipt-count-number">0</span>
            </div>
            <div class="receipt-thank-you">Thank you for shopping!</div>
            <button onclick="clearShoppingList()" class="receipt-clear-btn">üóëÔ∏è Clear All</button>
        </div>
    </div>
    
    <!-- Tube Light -->
    <div class="tube-light-container">
        <div id="tube-light" class="tube-light"></div>
        <div class="tube-light-glow"></div>
    </div>

    <!-- Alarm Notification Overlay -->
    <div id="alarm-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50"></div>
    <div id="alarm-notification" class="hidden"></div>

    <div class="min-h-screen pb-32">
        <div id="bg-effects" class="fixed inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-20 left-20 w-72 h-72 bg-slate-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
            <div class="absolute bottom-20 right-20 w-72 h-72 bg-indigo-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-delay: 1s;"></div>
            <div class="absolute top-1/2 left-1/2 w-72 h-72 bg-violet-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-delay: 2s;"></div>
        </div>

        <div class="max-w-4xl mx-auto relative z-10 p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <div class="p-3 rounded-2xl bg-gradient-to-r from-indigo-600 to-violet-600 shadow-lg">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 id="title" class="text-4xl font-black text-gray-900">Unify</h1>
                        <p id="subtitle" class="text-sm text-gray-600">Your AI Voice Assistant</p>
                    </div>
                </div>
                
                <!-- Light Switch -->
                <div class="light-switch-container" onclick="toggleDarkMode()">
                    <div id="light-switch" class="light-switch on">
                        <div class="switch-toggle"></div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="main-card" class="bg-white bg-opacity-80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white border-opacity-50 mb-6">
                
                <!-- Chat History -->
                <div id="chat-container" class="bg-gray-50 rounded-2xl p-4 max-h-96 overflow-y-auto space-y-3 mb-6">
                    <!-- Welcome message -->
                </div>

                <!-- Weather Card -->
                <div id="weather-card" class="hidden bg-gradient-to-r from-blue-400 to-cyan-500 text-white p-6 rounded-2xl shadow-lg mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                            </svg>
                            <div>
                                <h2 class="text-xl font-bold">Weather</h2>
                                <p id="location-name" class="text-sm text-blue-100">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <p id="temperature" class="text-5xl font-bold mb-2">--¬∞F / --¬∞C</p>
                    <p id="weather-advice" class="text-blue-50 text-lg"></p>
                </div>

                <!-- Reminders List -->
                <div id="reminders-section" class="hidden bg-gray-50 p-6 rounded-2xl mb-6">
                    <div class="flex items-center gap-2 mb-4">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <h2 class="text-xl font-bold text-gray-800">Your Reminders</h2>
                    </div>
                    <div id="reminders-list" class="space-y-3"></div>
                </div>

                <!-- Suggestion Buttons -->
                <div class="bg-purple-50 p-6 rounded-2xl">
                    <h3 class="font-bold text-gray-900 mb-3">Try asking me:</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button onclick="processSuggestion('What\'s the weather like today?')" class="text-left bg-white hover:bg-purple-100 text-purple-800 p-3 rounded-xl text-sm font-medium shadow-sm border border-purple-200 transition-all">
                            ‚òÄÔ∏è What's the weather?
                        </button>
                        <button onclick="processSuggestion('Add 2 pounds of chicken to my shopping list')" class="text-left bg-white hover:bg-purple-100 text-purple-800 p-3 rounded-xl text-sm font-medium shadow-sm border border-purple-200 transition-all">
                            üõí Add 2 lbs chicken to list
                        </button>
                        <button onclick="processSuggestion('Remind me to call mom at 5pm')" class="text-left bg-white hover:bg-purple-100 text-purple-800 p-3 rounded-xl text-sm font-medium shadow-sm border border-purple-200 transition-all">
                            ‚è∞ Remind me to call mom
                        </button>
                        <button onclick="processSuggestion('My car keys are on the counter')" class="text-left bg-white hover:bg-purple-100 text-purple-800 p-3 rounded-xl text-sm font-medium shadow-sm border border-purple-200 transition-all">
                            üîë My keys are on counter
                        </button>
                        <button onclick="processSuggestion('What can you do?')" class="text-left bg-white hover:bg-purple-100 text-purple-800 p-3 rounded-xl text-sm font-medium shadow-sm border border-purple-200 transition-all">
                            ‚ùì What can you do?
                        </button>
                        <button onclick="processSuggestion('Plan a weekend trip to Paris')" class="text-left bg-white hover:bg-purple-100 text-purple-800 p-3 rounded-xl text-sm font-medium shadow-sm border border-purple-200 transition-all">
                            ‚úàÔ∏è Plan a trip to Paris
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Reply Suggestions -->
    <div id="quick-replies" class="fixed bottom-24 left-0 right-0 z-30 hidden">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <!-- Suggestions will be added here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Processing...</div>
        </div>
    </div>

    <!-- ChatGPT-style Input at Bottom -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
        <div class="max-w-4xl mx-auto p-4">
            <div class="flex items-center gap-3 bg-gray-50 rounded-full border-2 border-gray-200 px-4 py-3 hover:border-purple-300 transition-all">
                <button onclick="showHelpOverlay()" class="flex-shrink-0 relative group" title="Help & Tips">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600 hover:text-purple-600 transition-all">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <!-- Tooltip -->
                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        Help & Tips
                    </div>
                </button>
                
                <input 
                    type="text" 
                    id="text-input"
                    placeholder="Ask anything..."
                    class="flex-1 bg-transparent outline-none text-gray-900 placeholder-gray-500"
                    onkeypress="if(event.key === 'Enter') sendTextInput()"
                    oninput="toggleSendButton()"
                />
                
                <!-- Send Button (shows when typing) -->
                <button onclick="sendTextInput()" id="send-btn" class="hidden flex-shrink-0 p-2 rounded-full bg-indigo-600 hover:bg-indigo-700 transition-all">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
                
                <!-- Voice Button (shows when not typing) -->
                <button onclick="toggleListening()" id="voice-btn" class="flex-shrink-0 p-2 rounded-full bg-gray-900 hover:bg-gray-800 transition-all">
                    <svg id="mic-icon-bottom" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                    <div id="waveform-bottom" class="hidden flex items-center gap-1">
                        <div class="w-1 h-4 bg-white rounded-full wave-bar" style="animation-delay: 0s;"></div>
                        <div class="w-1 h-4 bg-white rounded-full wave-bar" style="animation-delay: 0.1s;"></div>
                        <div class="w-1 h-4 bg-white rounded-full wave-bar" style="animation-delay: 0.2s;"></div>
                    </div>
                </button>
            </div>
            <p class="text-xs text-gray-500 text-center mt-2">Unify can make mistakes. Check important info.</p>
        </div>
    </div>

    <!-- Fixed Buttons - Right Side Stack -->
    <!-- History Button (Higher) -->
    <button 
        onclick="showHistoryPanel()" 
        class="fixed bottom-16 right-6 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-full shadow-lg transition-all text-sm font-medium flex items-center gap-2 z-50 hover:scale-105"
        title="View Conversation History">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        History
    </button>
    
    <!-- Feature Request Button (Lower) -->
    <button 
        onclick="openFeatureRequest()" 
        class="fixed bottom-6 right-6 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-full shadow-lg transition-all text-sm font-medium flex items-center gap-2 z-50 hover:scale-105"
        title="Request a Feature">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
        </svg>
        Request
    </button>

<script>
// ========== GLOBAL FUNCTION FOR ONCLICK ==========
// toggleDarkMode must be at global scope for onclick handler
function toggleDarkMode() {
    const body = document.body;
    if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        body.classList.add('light');
    } else {
        body.classList.remove('light');
        body.classList.add('dark');
    }
}

// ========== LOADING STATES ==========
function showLoading(message = 'Processing...') {
    const overlay = document.getElementById('loading-overlay');
    const text = document.getElementById('loading-text');
    if (overlay && text) {
        text.textContent = message;
        overlay.classList.remove('hidden');
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

// ========== THINKING INDICATOR ==========
let thinkingIndicatorElement = null;

function showThinkingIndicator() {
    // Create thinking indicator if it doesn't exist
    if (!thinkingIndicatorElement) {
        const chatContainer = document.getElementById('chat-container');
        const indicatorDiv = document.createElement('div');
        indicatorDiv.className = 'flex justify-start';
        indicatorDiv.id = 'thinking-indicator-wrapper';
        
        const indicator = document.createElement('div');
        indicator.className = 'thinking-indicator';
        indicator.innerHTML = `
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
        `;
        
        indicatorDiv.appendChild(indicator);
        chatContainer.appendChild(indicatorDiv);
        thinkingIndicatorElement = indicatorDiv;
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

function hideThinkingIndicator() {
    if (thinkingIndicatorElement) {
        thinkingIndicatorElement.remove();
        thinkingIndicatorElement = null;
    }
}

// ========== QUICK REPLY SUGGESTIONS ==========
function showQuickReplies(suggestions) {
    const container = document.getElementById('quick-replies');
    if (!container || !suggestions || suggestions.length === 0) {
        hideQuickReplies();
        return;
    }
    
    const buttonsHtml = suggestions.map(suggestion => `
        <button class="quick-reply-btn" onclick="handleQuickReply('${suggestion.text.replace(/'/g, "\\'")}')">
            ${suggestion.icon || 'üí¨'} ${suggestion.text}
        </button>
    `).join('');
    
    container.querySelector('div > div').innerHTML = buttonsHtml;
    container.classList.remove('hidden');
    
    // Auto-hide after 30 seconds
    setTimeout(hideQuickReplies, 30000);
}

function hideQuickReplies() {
    const container = document.getElementById('quick-replies');
    if (container) {
        container.classList.add('hidden');
    }
}

function handleQuickReply(text) {
    hideQuickReplies();
    document.getElementById('text-input').value = text;
    sendTextInput();
}

// Suggest context-aware quick replies based on last response
function suggestQuickReplies(context) {
    const suggestions = [];
    
    // After weather
    if (context.includes('weather') || context.includes('temperature')) {
        suggestions.push(
            { icon: 'üè®', text: 'Hotels nearby' },
            { icon: 'üçΩÔ∏è', text: 'Best restaurants' },
            { icon: 'üó∫Ô∏è', text: 'Things to do' }
        );
    }
    // After itinerary
    else if (context.includes('itinerary') || context.includes('Day 1')) {
        suggestions.push(
            { icon: 'üè®', text: 'Hotels' },
            { icon: 'üçΩÔ∏è', text: 'Restaurants' },
            { icon: 'üç≤', text: 'Local food specialties' }
        );
    }
    // After hotel recommendations
    else if (context.includes('hotel') || context.includes('stay')) {
        suggestions.push(
            { icon: 'üçΩÔ∏è', text: 'Restaurants' },
            { icon: 'üó∫Ô∏è', text: 'Things to do' },
            { icon: 'üå§Ô∏è', text: 'Weather' }
        );
    }
    // After restaurant recommendations
    else if (context.includes('restaurant') || context.includes('[Pure Veg]') || context.includes('[Non-Veg]')) {
        suggestions.push(
            { icon: 'üè®', text: 'Hotels' },
            { icon: 'üó∫Ô∏è', text: 'Plan an itinerary' },
            { icon: 'üöó', text: 'Transport options' }
        );
    }
    // After shopping list
    else if (context.includes('shopping') || context.includes('Added')) {
        suggestions.push(
            { icon: 'üìù', text: 'Show shopping list' },
            { icon: 'üõí', text: 'Add more items' },
            { icon: 'üóëÔ∏è', text: 'Clear list' }
        );
    }
    // Default suggestions
    else {
        suggestions.push(
            { icon: 'üå§Ô∏è', text: 'Weather' },
            { icon: 'üó∫Ô∏è', text: 'Plan a trip' },
            { icon: 'üõí', text: 'Shopping list' }
        );
    }
    
    showQuickReplies(suggestions);
}

// ========== GEMINI AI INTEGRATION ==========
let conversationContext = [];

// Wrapper for AI calls with loading indicator
async function callAIWithTyping(message, loadingMessage = 'Thinking...') {
    // Show thinking indicator in chat
    showThinkingIndicator();
    showLoading(loadingMessage);
    try {
        const response = await askGeminiAI(message);
        hideThinkingIndicator();
        hideLoading();
        return response;
    } catch (error) {
        hideThinkingIndicator();
        hideLoading();
        showError('AI request failed. Please try again.');
        throw error;
    }
}

async function askGeminiAI(userMessage) {
    try {
        console.log('ü§ñ Calling Gemini AI with:', userMessage);
        
        conversationContext.push({ role: 'user', text: userMessage });
        if (conversationContext.length > 6) {
            conversationContext = conversationContext.slice(-6);
        }
        
        const contextMessages = conversationContext.map(msg => 
            `${msg.role === 'user' ? 'User' : 'Assistant'}: ${msg.text}`
        ).join('\n');
        
        const systemPrompt = `You are Unify, a helpful voice assistant.${userName ? ` The user's name is ${userName}. Use their name naturally and occasionally in conversation.` : ' Be friendly and conversational.'}

CRITICAL RULES:
- ${userName ? `The user's name is ${userName} - use it!` : 'You do NOT know the user\'s name. NEVER say "User" or "Certainly, User!" - just say "Certainly!" or be friendly without using a name.'}
- Be natural and conversational

HOTEL/RESTAURANT FORMATTING (MUST FOLLOW EXACTLY):
When listing hotels or restaurants, use this CLEAN format:

1. [Hotel/Restaurant Name]
   Price: [Budget/Mid-range/Luxury] | Type: [Veg/Non-Veg/Both] | Must Try: [Signature dish]
   [LOCATION: City, State]

2. [Next entry...]
   Price: [Range] | Type: [Type] | Must Try: [Dish]
   [LOCATION: City, State]

CRITICAL RULES:
- NO descriptions, NO features, NO extra text
- ONLY: Name, Price, Type, Must Try
- Keep it ONE LINE after the name
- Add [LOCATION: City, State] for each entry
- Add blank line between entries

AFTER all hotels/restaurants, add:

---
üçî FAST FOOD CHAINS IN [CITY]:
List ALL fast food chains available in that location (McDonald's, KFC, Wendy's, Taco Bell, Burger King, Subway, Chipotle, Panera Bread, Five Guys, Chick-fil-A, Arby's, Jimmy John's, Domino's, Pizza Hut, etc.)
Format: [FASTFOOD: Chain Name, City]

Your capabilities:
- Weather (say "check weather")
- Shopping lists (say "manage shopping")  
- Reminders (say "set reminder")
- Memory (remembering where things are)
- Hotel & restaurant recommendations
- Travel itineraries

For casual conversation, be friendly and natural.
For name corrections like "no, my name is X", extract the name.

Recent conversation:
${contextMessages}

Respond conversationally and naturally.`;

        console.log('üì° Sending request to /api/chat...');
        
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: userMessage,
                systemPrompt: systemPrompt,
                userName: userName
            })
        });
        
        console.log('üì¨ Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå API Error Response:', errorText);
            throw new Error(`AI request failed: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ AI Response received:', data);
        
        conversationContext.push({ role: 'assistant', text: data.response || data.text });
        
        return data;
    } catch (error) {
        console.error('üí• AI error:', error);
        console.error('Error details:', error.message, error.stack);
        // Better error handling - try to be helpful
        showError(`AI request failed: ${error.message}`);
        return {
            response: "I'm having trouble connecting to my AI. Please try again in a moment!",
            intent: 'error'
        };
    }
}

async function handleNameCorrection(text) {
    const patterns = [
        /(?:no|nah|nope|actually|wrong),?\s*(?:my name is|i'm|i am|it's|call me)\s+([^,.!?]+)/i,
        /(?:my name is|i'm|i am|it's|call me)\s+([^,.!?]+)/i
    ];
    
    let newName = '';
    for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            newName = match[1].trim();
            break;
        }
    }
    
    if (!newName) {
        const aiResponse = await askGeminiAI(`Extract just the name from: "${text}"`);
        newName = aiResponse.response;
    }
    
    newName = newName.replace(/[?.!,]$/g, '').trim();
    newName = newName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
    
    const isHarsh = /idiot|stupid|dumb|moron|fool/i.test(text);
    userName = newName;
    saveUserData();
    
    const response = isHarsh 
        ? `I apologize! I've updated your name to ${userName}.`
        : `Got it! I've updated your name to ${userName}.`;
    
    addChatMessage(response, false);
    speak(response);
}

        // ========== STATE VARIABLES ==========
        let darkMode = false;
        let recognition = null;
        let continuousRecognition = null;
        let isListening = false;
        let synth = window.speechSynthesis;
        let isSpeaking = false;
        let currentSpeechText = '';
        let reminders = [];
        let weather = null;
        let waitingForLocation = false;
        let waitingForReminder = false;
        let chatHistory = [];
        let micPermissionGranted = false;
        
        // New state variables
        let userName = null;
        let waitingForName = false;
        let shoppingList = [];
        let memoryStore = {}; // Store user's personal information

        // ========== INITIALIZATION ==========
        window.onload = async () => {
            await requestMicrophonePermission();
            loadUserData();
            checkReminders();
            
            // Don't force name input - just show friendly welcome
            const welcomeMsg = userName 
                ? `Hi ${userName}! How can I help you today?` 
                : "Hi! I'm Unify, your voice assistant. How can I help you today?";
            
            addChatMessage(welcomeMsg, false);
            speak(welcomeMsg);
            
            // No hint needed - user has Help & Tips button!
        };

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                micPermissionGranted = true;
                console.log('Microphone permission granted');
                initializeSpeechRecognition();
            } catch (error) {
                console.error('Microphone permission denied:', error);
                micPermissionGranted = false;
                const errorMsg = "Microphone access denied. Please enable it in your browser settings to use voice features.";
                addChatMessage(errorMsg, false);
            }
        }

        // ========== DARK MODE & LIGHT SWITCH ==========
        function toggleDarkMode() {
            darkMode = !darkMode;
            const body = document.body;
            const card = document.getElementById('main-card');
            const title = document.getElementById('title');
            const subtitle = document.getElementById('subtitle');
            const chatContainer = document.getElementById('chat-container');
            const lightSwitch = document.getElementById('light-switch');
            const tubeLight = document.getElementById('tube-light');
            const weatherEffects = document.getElementById('weather-effects');
            const receipt = document.getElementById('shopping-receipt');
            
            if (darkMode) {
                // Turn OFF the light (dark mode) - INSTANT
                lightSwitch.classList.remove('on');
                tubeLight.classList.remove('on', 'starting');
                
                // Clear weather effects in dark mode
                if (weatherEffects) weatherEffects.innerHTML = '';
                
                // Immediate dark mode
                body.classList.remove('light');
                body.classList.add('dark');
                body.style.background = '#000';
                body.style.filter = 'none';
                card.className = 'bg-gray-900 bg-opacity-90 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-gray-700 mb-6';
                title.className = 'text-4xl font-black text-white';
                subtitle.className = 'text-sm text-gray-300';
                if (chatContainer) chatContainer.className = 'bg-gray-800 rounded-2xl p-4 max-h-96 overflow-y-auto space-y-3 mb-6';
                if (receipt) receipt.classList.add('dark-mode');
            } else {
                // Turn ON the light (light mode) - DELAYED with tube light startup
                lightSwitch.classList.add('on');
                
                // Start tube light flicker animation
                tubeLight.classList.add('starting');
                
                // Wait for tube light to fully glow before switching to light mode
                setTimeout(() => {
                    tubeLight.classList.remove('starting');
                    tubeLight.classList.add('on');
                    
                    // Now switch to light mode after tube light is on
                    body.classList.remove('dark');
                    body.classList.add('light');
                    
                    // Restore weather effects or default background
                    if (weather && weather.current) {
                        createWeatherEffect(weather.current.weather_code, Math.round(weather.current.temperature_2m));
                    } else {
                        body.style.background = 'linear-gradient(to bottom right, #fce7f3, #e9d5ff, #c7d2fe)';
                        body.style.filter = 'none';
                    }
                    
                    card.className = 'bg-white bg-opacity-80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white border-opacity-50 mb-6';
                    title.className = 'text-4xl font-black text-gray-900';
                    subtitle.className = 'text-sm text-gray-600';
                    if (chatContainer) chatContainer.className = 'bg-gray-50 rounded-2xl p-4 max-h-96 overflow-y-auto space-y-3 mb-6';
                    if (receipt) receipt.classList.remove('dark-mode');
                }, 800); // Match the tube light startup animation duration
            }
        }

        // ========== FEATURE REQUEST ==========
        function openFeatureRequest() {
            // Google Form for feature requests
            const formUrl = 'https://forms.gle/h8Wtb3fbwKBnjoYT8';
            window.open(formUrl, '_blank');
        }

        // ========== RESTAURANT/HOTEL RESPONSE ENHANCEMENT ==========
        function enhanceRestaurantResponse(text) {
            // Check if this is a hotel/restaurant response
            if (!text.match(/\d+\.\s+\w+/) || !text.includes('Price:')) {
                return text; // Not a restaurant/hotel response, return as-is
            }
            
            let enhanced = text;
            let city = 'Mason, Ohio'; // Default city
            
            // Try to extract city from [LOCATION: ...] tags
            const locationMatch = text.match(/\[LOCATION:\s*([^\]]+)\]/);
            if (locationMatch) {
                city = locationMatch[1];
            }
            
            // Remove all location tags from display
            enhanced = enhanced.replace(/\[LOCATION:[^\]]+\]/g, '');
            
            // NEW FORMAT: Match "1. Hotel Name" followed by ONE line with Price/Type/Must Try
            // Pattern: "1. Name\n   Price: ... | Type: ... | Must Try: ..."
            enhanced = enhanced.replace(
                /(\d+)\.\s+([^\n]+)\n\s*(Price:[^\n]+)/g,
                (match, number, name, details) => {
                    const cleanName = name.trim();
                    const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(cleanName + ' ' + city)}`;
                    
                    return `${number}. <a href="${googleSearchUrl}" target="_blank" class="hotel-link">${cleanName}</a>\n   ${details}\n   <button class="direction-btn" onclick="getDirections('${cleanName.replace(/'/g, "\\'")}', '${city}')">üìç Get Directions</button>\n`;
                }
            );
            
            // Handle fast food section
            if (enhanced.includes('üçî FAST FOOD CHAINS') || enhanced.includes('[FASTFOOD:')) {
                // Extract fast food chains
                const fastFoodMatches = enhanced.match(/\[FASTFOOD:\s*([^,\]]+)/g);
                if (fastFoodMatches) {
                    const chains = fastFoodMatches.map(m => m.replace('[FASTFOOD:', '').trim());
                    
                    // Remove [FASTFOOD: ...] tags
                    enhanced = enhanced.replace(/\[FASTFOOD:[^\]]+\]/g, '');
                    
                    // Build fast food section HTML
                    let fastFoodHTML = '\n\n<div class="fast-food-section">';
                    fastFoodHTML += `<h3>üçî Fast Food Chains in ${city}</h3>`;
                    fastFoodHTML += '<div class="fast-food-buttons">';
                    
                    chains.forEach(chain => {
                        const icon = getChainIcon(chain);
                        fastFoodHTML += `<button class="fast-food-btn" onclick="getDirections('${chain}', '${city}')">${icon} ${chain}</button>`;
                    });
                    
                    fastFoodHTML += '</div></div>';
                    
                    // Add to end of response
                    enhanced += fastFoodHTML;
                }
            }
            
            return enhanced;
        }
        
        function getChainIcon(chainName) {
            const icons = {
                'McDonald': 'üçî',
                'KFC': 'üçó',
                'Taco Bell': 'üåÆ',
                'Wendy': 'üçî',
                'Burger King': 'üëë',
                'Subway': 'ü•™',
                'Chipotle': 'üåØ',
                'Panera': 'ü•ñ',
                'Five Guys': 'üçü',
                'Chick-fil-A': 'üêî',
                'Arby': 'ü•©',
                'Jimmy John': 'ü•™',
                'Domino': 'üçï',
                'Pizza Hut': 'üçï'
            };
            
            for (const [key, icon] of Object.entries(icons)) {
                if (chainName.includes(key)) return icon;
            }
            return 'üçî'; // Default
        }

        // ========== CHAT MESSAGE HANDLING ==========
        function addChatMessage(text, isUser = true) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} items-start gap-2 fade-in`;
            
            // Clean markdown bold syntax (**text** ‚Üí text)
            let cleanedText = text.replace(/\*\*(.*?)\*\*/g, '$1');
            
            // Enhance restaurant/hotel responses with direction buttons (AI messages only)
            let hasButtons = false;
            if (!isUser) {
                const enhanced = enhanceRestaurantResponse(cleanedText);
                if (enhanced !== cleanedText) {
                    hasButtons = true;
                    cleanedText = enhanced;
                }
            }
            
            // Convert newlines to <br> tags, but handle HTML buttons specially
            let formattedText;
            if (hasButtons) {
                // Don't escape HTML if we have buttons
                formattedText = cleanedText.replace(/\n/g, '<br>');
            } else {
                // Normal escaping for regular text
                formattedText = escapeHtml(cleanedText).replace(/\n/g, '<br>');
            }
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="bg-indigo-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 max-w-md shadow-sm relative group">
                        <p class="text-sm">${formattedText}</p>
                        <button onclick="deleteMessage(this)" class="hidden group-hover:block absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-sm hover:bg-red-600 transition-all shadow-lg">√ó</button>
                    </div>
                `;
            } else {
                const bgClass = darkMode ? 'bg-gray-700' : 'bg-white';
                const textClass = darkMode ? 'text-gray-200' : 'text-gray-800';
                
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-2 max-w-md">
                        <div class="${bgClass} rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm flex-1">
                            <p class="text-sm ${textClass}">${formattedText}</p>
                        </div>
                        <button onclick="speak(\`${text.replace(/`/g, '\\`').replace(/'/g, "\\'")}\`)" class="flex-shrink-0 p-2 rounded-full bg-purple-500 hover:bg-purple-600 text-white transition-all">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                        </button>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            chatHistory.push({ text, isUser });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSendButton() {
            const input = document.getElementById('text-input');
            const sendBtn = document.getElementById('send-btn');
            const voiceBtn = document.getElementById('voice-btn');
            
            if (input.value.trim().length > 0) {
                // Show send button, hide voice button
                sendBtn.classList.remove('hidden');
                voiceBtn.classList.add('hidden');
            } else {
                // Show voice button, hide send button
                sendBtn.classList.add('hidden');
                voiceBtn.classList.remove('hidden');
            }
        }

        function sendTextInput() {
            const input = document.getElementById('text-input');
            const text = input.value.trim();
            if (text) {
                addChatMessage(text, true);
                
                if (waitingForName) {
                    handleNameInput(text);
                } else if (waitingForLocation) {
                    // Validate location input
                    const cleanLocation = text.trim();
                    if (cleanLocation.length < 2) {
                        const msg = "I didn't catch that. Please tell me a city or location name.";
                        addChatMessage(msg, false);
                        speak(msg);
                        input.value = '';
                        return;
                    }
                    // Reject common filler words
                    const fillerWords = ['he', 'she', 'it', 'a', 'an', 'the', 'um', 'uh', 'er', 'oh'];
                    if (fillerWords.includes(cleanLocation.toLowerCase())) {
                        const msg = "I didn't quite catch the location. Could you say it again?";
                        addChatMessage(msg, false);
                        speak(msg);
                        input.value = '';
                        return;
                    }
                    waitingForLocation = false;
                    getWeatherByCity(cleanLocation);
                } else if (waitingForReminder) {
                    waitingForReminder = false;
                    createReminderFromText(text);
                } else {
                    processCommand(text);
                }
                
                input.value = '';
                toggleSendButton(); // Reset to voice button after sending
            }
        }

        // ========== SPEECH RECOGNITION ==========
        
        let isProcessing = false; // Prevent duplicate processing
        let speechTimeout = null; // Timeout for collecting complete sentence
        
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.error('Speech recognition not supported in this browser');
                addChatMessage("Sorry, speech recognition is not supported in your browser. Please try Chrome, Edge, or Safari.", false);
                return;
            }

            // Manual recognition - triggered by button only
            continuousRecognition = new SpeechRecognition();
            continuousRecognition.continuous = true;  // Keep listening
            continuousRecognition.interimResults = true;  // Get interim results
            continuousRecognition.lang = 'en-US';

            continuousRecognition.onresult = async (event) => {
                // Get the latest result
                const last = event.results.length - 1;
                const result = event.results[last];
                const text = result[0].transcript.trim();
                
                if (!text) return;
                
                // Clear any existing timeout
                if (speechTimeout) {
                    clearTimeout(speechTimeout);
                }
                
                // If it's a final result, process after short delay
                if (result.isFinal) {
                    console.log('‚úÖ Final result:', text);
                    
                    // Stop listening immediately
                    stopListening();
                    
                    // Prevent duplicate processing
                    if (isProcessing) {
                        console.log('‚è∏Ô∏è Already processing, ignoring:', text);
                        return;
                    }
                    
                    isProcessing = true;
                    
                    addChatMessage(text, true);
                
                try {
                    if (waitingForLocation) {
                        // Validate location input
                        const cleanLocation = text.replace(/[?!]/g, '').trim();
                        
                        if (cleanLocation.length < 2) {
                            const msg = "I didn't catch that. Please tell me a city or location name.";
                            addChatMessage(msg, false);
                            speak(msg);
                            return;
                        }
                        
                        const fillerWords = ['he', 'she', 'it', 'a', 'an', 'the', 'um', 'uh', 'er', 'oh', 'weather'];
                        if (fillerWords.includes(cleanLocation.toLowerCase())) {
                            const msg = "I didn't quite catch the location. Could you say it again?";
                            addChatMessage(msg, false);
                            speak(msg);
                            return;
                        }
                        
                        waitingForLocation = false;
                        await getWeatherByCity(cleanLocation);
                        return;
                    }
                    
                    if (waitingForReminder) {
                        waitingForReminder = false;
                        await createReminderFromText(text);
                        return;
                    }
                    
                    if (waitingForName) {
                        await handleNameInput(text);
                        return;
                    }
                    
                    // Process as normal command
                    await processCommand(text);
                } finally {
                    // Always clear processing flag
                    isProcessing = false;
                }
                } // Close isFinal check
            };

            continuousRecognition.onerror = (event) => {
                console.log('Recognition error:', event.error);
                stopListening();
            };

            continuousRecognition.onend = () => {
                stopListening();
            };
        }

        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            if (!continuousRecognition) {
                addChatMessage("Speech recognition not available. Please use text input.", false);
                return;
            }
            
            try {
                isListening = true;
                continuousRecognition.start();
                
                // Update UI
                document.getElementById('mic-icon-bottom').classList.add('hidden');
                document.getElementById('waveform-bottom').classList.remove('hidden');
                document.getElementById('voice-btn').classList.add('bg-purple-600', 'ring-4', 'ring-purple-200');
                document.getElementById('voice-btn').classList.remove('bg-gray-900');
                
            } catch (e) {
                console.log('Start listening failed:', e);
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            
            if (continuousRecognition) {
                try {
                    continuousRecognition.stop();
                } catch (e) {
                    console.log('Stop failed:', e);
                }
            }
            
            // Update UI
            document.getElementById('mic-icon-bottom')?.classList.remove('hidden');
            document.getElementById('waveform-bottom')?.classList.add('hidden');
            document.getElementById('voice-btn')?.classList.remove('bg-purple-600', 'ring-4', 'ring-purple-200');
            document.getElementById('voice-btn')?.classList.add('bg-gray-900');
        }

        // Remove old recognition code - we only need one now
        recognition = continuousRecognition;

        // ========== COMMAND PROCESSING ==========
        function processSuggestion(text) {
            document.getElementById('text-input').value = text;
            sendTextInput();
        }

        async function processCommand(text) {
            const lower = text.toLowerCase();
            
            // Auto-close cards when topic changes
            const isWeatherQuery = lower.includes('weather') || lower.includes('temperature') || 
                                   lower.includes('rain') || lower.includes('snow') || 
                                   lower.includes('forecast') || lower.includes('hot') || lower.includes('cold');
            
            const isShoppingQuery = lower.includes('shopping') || lower.includes('grocery') || 
                                    (lower.includes('add') && lower.includes('list'));
            
            const isReminderQuery = lower.includes('remind') || lower.includes('reminder');
            
            // Close weather card if not asking about weather
            if (!isWeatherQuery && !waitingForLocation) {
                const weatherCard = document.getElementById('weather-card');
                if (weatherCard && !weatherCard.classList.contains('hidden')) {
                    weatherCard.classList.add('hidden');
                }
            }
            
            // Close shopping receipt if not asking about shopping
            if (!isShoppingQuery) {
                const shoppingReceipt = document.getElementById('shopping-receipt');
                if (shoppingReceipt && !shoppingReceipt.classList.contains('hidden')) {
                    shoppingReceipt.classList.add('hidden');
                }
            }
            
            // Close reminders section if not asking about reminders
            if (!isReminderQuery) {
                const remindersSection = document.getElementById('reminders-section');
                if (remindersSection && !remindersSection.classList.contains('hidden')) {
                    remindersSection.classList.add('hidden');
                }
            }
            
            // Remove common conversational prefixes
            let cleanText = text;
            const prefixes = ['hey', 'hi', 'hello', 'ok', 'okay', 'well', 'so', 'um', 'uh'];
            for (const prefix of prefixes) {
                const regex = new RegExp(`^${prefix}[,\\s]+`, 'i');
                cleanText = cleanText.replace(regex, '');
            }

            if (waitingForLocation) {
                const cleanLocation = cleanText.replace(/[?!]/g, '').trim();
                
                // Validate location
                if (cleanLocation.length < 2) {
                    const msg = "I didn't catch that. Please tell me a city or location name.";
                    addChatMessage(msg, false);
                    speak(msg);
                    return;
                }
                
                // Reject common filler words
                const fillerWords = ['he', 'she', 'it', 'a', 'an', 'the', 'um', 'uh', 'er', 'oh', 'weather'];
                if (fillerWords.includes(cleanLocation.toLowerCase())) {
                    const msg = "I didn't quite catch the location. Could you say it again?";
                    addChatMessage(msg, false);
                    speak(msg);
                    return;
                }
                
                waitingForLocation = false;
                getWeatherByCity(cleanLocation);
                return;
            }

            if (waitingForReminder) {
                waitingForReminder = false;
                createReminderFromText(cleanText);
                return;
            }
            
            // Handle location choice selection
            if (window.waitingForLocationChoice && window.pendingLocationChoices) {
                window.waitingForLocationChoice = false;
                const choices = window.pendingLocationChoices;
                
                // Check if user said a number (1, 2, 3)
                const numberMatch = cleanText.match(/\b([1-9])\b/);
                if (numberMatch) {
                    const choice = parseInt(numberMatch[1]) - 1;
                    if (choice >= 0 && choice < choices.length) {
                        const selected = choices[choice];
                        const lat = parseFloat(selected.lat);
                        const lon = parseFloat(selected.lon);
                        
                        const addr = selected.address;
                        let locationName = addr.city || addr.town || addr.village || addr.hamlet || selected.display_name.split(',')[0];
                        if (addr.state) locationName += `, ${addr.state}`;
                        if (addr.country) locationName += `, ${addr.country}`;
                        
                        window.pendingLocationChoices = null;
                        await fetchWeather(lat, lon, locationName);
                        return;
                    }
                }
                
                // Check if user said the full location name
                for (const loc of choices) {
                    const addr = loc.address;
                    const country = addr.country ? addr.country.toLowerCase() : '';
                    const state = addr.state ? addr.state.toLowerCase() : '';
                    
                    if (cleanText.toLowerCase().includes(country) || cleanText.toLowerCase().includes(state)) {
                        const lat = parseFloat(loc.lat);
                        const lon = parseFloat(loc.lon);
                        
                        let locationName = addr.city || addr.town || addr.village || addr.hamlet || loc.display_name.split(',')[0];
                        if (addr.state) locationName += `, ${addr.state}`;
                        if (addr.country) locationName += `, ${addr.country}`;
                        
                        window.pendingLocationChoices = null;
                        await fetchWeather(lat, lon, locationName);
                        return;
                    }
                }
                
                // Didn't understand the choice
                const msg = "I didn't catch which one you meant. Could you say the number or the country name?";
                addChatMessage(msg, false);
                speak(msg);
                window.waitingForLocationChoice = true;
                return;
            }
            
            // Check for name change/update commands
            if (lower.includes('change') && (lower.includes('name') || lower.includes('my name'))) {
                const msg = "What would you like me to call you?";
                addChatMessage(msg, false);
                speak(msg);
                waitingForName = true;
                return;
            }
            
            // Check for direct name statements
            if (lower.match(/^(my name is|i'm|i am|call me|it's)\s+/i)) {
                handleNameInput(cleanText);
                return;
            }
            
            // Check for name correction (no, actually, etc.)
            if (userName && /^(no|nah|nope|actually|wrong)/i.test(cleanText)) {
                handleNameCorrection(cleanText);
                return;
            }

            // Weather queries - Check BEFORE memory recall to avoid conflicts
            else if (cleanText.toLowerCase().includes('weather') || cleanText.toLowerCase().includes('temperature') || cleanText.toLowerCase().includes('rain') || cleanText.toLowerCase().includes('snow')) {
                const location = extractLocationFromSentence(cleanText);
                
                if (location) {
                    // User specified a location
                    getWeatherByCity(location);
                } else if (weather && weather.current) {
                    // We have weather data already, answer about it
                    // Handle specific rain question
                    if (cleanText.toLowerCase().includes('rain')) {
                        const willRain = willItRain(weather.current.weather_code);
                        const celsius = Math.round(weather.current.temperature_2m);
                        const fahrenheit = Math.round((celsius * 9/5) + 32);
                        
                        let rainMsg;
                        if (willRain) {
                            rainMsg = `Yes, it looks like rain is expected today. ${getWeatherAdvice(weather)}`;
                        } else {
                            rainMsg = `No, it won't rain today. The temperature is ${fahrenheit}¬∞F (${celsius}¬∞C). ${getWeatherAdvice(weather)}`;
                        }
                        addChatMessage(rainMsg, false);
                        speak(rainMsg);
                    } 
                    // Handle snow question
                    else if (cleanText.toLowerCase().includes('snow')) {
                        const willSnow = willItSnow(weather.current.weather_code);
                        const celsius = Math.round(weather.current.temperature_2m);
                        const fahrenheit = Math.round((celsius * 9/5) + 32);
                        
                        let snowMsg;
                        if (willSnow) {
                            snowMsg = `Yes, snow is expected! ${getWeatherAdvice(weather)}`;
                        } else {
                            snowMsg = `No, it won't snow today. The temperature is ${fahrenheit}¬∞F (${celsius}¬∞C). ${getWeatherAdvice(weather)}`;
                        }
                        addChatMessage(snowMsg, false);
                        speak(snowMsg);
                    }
                    // General weather info
                    else {
                        const celsius = Math.round(weather.current.temperature_2m);
                        const fahrenheit = Math.round((celsius * 9/5) + 32);
                        const advice = getWeatherAdvice(weather);
                        const weatherMsg = `The temperature is ${fahrenheit}¬∞F (${celsius}¬∞C). ${advice}`;
                        addChatMessage(weatherMsg, false);
                        speak(weatherMsg);
                    }
                } else {
                    // No location and no cached weather - try to get user's location automatically
                    addChatMessage("üåç Detecting your location...", false);
                    speak("Detecting your location");
                    
                    if (navigator.geolocation) {
                        // Request location with better options
                        navigator.geolocation.getCurrentPosition(
                            async (position) => {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                
                                console.log('‚úÖ Got location:', lat, lon);
                                
                                // Do reverse geocoding to get city name
                                try {
                                    const reverseResponse = await fetch(
                                        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`,
                                        { headers: { 'User-Agent': 'UnifyVoiceAssistant/1.0' } }
                                    );
                                    const reverseData = await reverseResponse.json();
                                    
                                    // Log FULL response for debugging
                                    console.log('üó∫Ô∏è Full OpenStreetMap response:', reverseData);
                                    
                                    const addr = reverseData.address;
                                    
                                    // Log what we got from OpenStreetMap (for debugging)
                                    console.log('üó∫Ô∏è OpenStreetMap address data:', addr);
                                    
                                    // Try ALL possible location fields in order of specificity
                                    let cityName = addr.city || 
                                                   addr.town || 
                                                   addr.village || 
                                                   addr.hamlet || 
                                                   addr.suburb || 
                                                   addr.neighbourhood || 
                                                   addr.county || 
                                                   addr.municipality ||
                                                   addr.state_district ||
                                                   null;
                                    
                                    // If we got a city name, format it nicely
                                    if (cityName) {
                                        // Add state for US addresses (format: "Mason, Ohio")
                                        if (addr.state && addr.country_code === 'us') {
                                            cityName = `${cityName}, ${addr.state}`;
                                        } else if (addr.state && addr.country) {
                                            cityName = `${cityName}, ${addr.state}, ${addr.country}`;
                                        } else if (addr.country && addr.country_code !== 'us') {
                                            cityName = `${cityName}, ${addr.country}`;
                                        }
                                    } else {
                                        // Fallback: just use state or country
                                        cityName = addr.state || addr.country || "your location";
                                    }
                                    
                                    console.log('üìç Final location name:', cityName);
                                    fetchWeather(lat, lon, cityName);
                                } catch (error) {
                                    console.error('Reverse geocoding failed:', error);
                                    // Fallback to generic name
                                    fetchWeather(lat, lon, "your location");
                                }
                            },
                            (error) => {
                                console.log('‚ùå Geolocation error:', error.code, error.message);
                                // Geolocation failed, ask for location
                                let askMsg;
                                if (error.code === 1) {
                                    // Permission denied
                                    askMsg = "üìç Location permission was denied. Please tell me your city, or check your browser settings to enable location access.";
                                } else if (error.code === 2) {
                                    // Position unavailable
                                    askMsg = "I couldn't determine your location. Where are you? Just say your city!";
                                } else if (error.code === 3) {
                                    // Timeout
                                    askMsg = "Location detection is taking too long. Where are you located?";
                                } else {
                                    askMsg = "I couldn't detect your location. Where are you?";
                                }
                                addChatMessage(askMsg, false);
                                speak(askMsg);
                                waitingForLocation = true;
                            },
                            {
                                enableHighAccuracy: false, // Faster, less battery
                                timeout: 15000, // 15 seconds (increased from 7)
                                maximumAge: 300000 // Cache for 5 minutes
                            }
                        );
                    } else {
                        // Geolocation not supported
                        const askMsg = "Your browser doesn't support location detection. Just tell me your city or town!";
                        addChatMessage(askMsg, false);
                        speak(askMsg);
                        waitingForLocation = true;
                    }
                }
                return; // CRITICAL: Stop here, don't fall through to AI fallback
            }
            // Shopping List Commands - SEPARATE CHECK (not else if!)
            if (cleanText.toLowerCase().includes('add') && (cleanText.toLowerCase().includes('shopping list') || cleanText.toLowerCase().includes('shopping') || cleanText.toLowerCase().includes('to my list') || cleanText.toLowerCase().includes('to list'))) {
                handleAddToShoppingList(cleanText);
            }
            // Handle follow-up additions: "also add", "and add", etc.
            else if (cleanText.toLowerCase().match(/\b(also|and|plus)\s+add\b/i) || cleanText.toLowerCase().match(/\badd\s+(also|too)\b/i)) {
                handleAddToShoppingList(cleanText);
            }
            // Simple "add X" when shopping list was recently used
            else if (cleanText.toLowerCase().startsWith('add ') && shoppingList.length > 0) {
                handleAddToShoppingList(cleanText);
            }
            else if (cleanText.toLowerCase().includes('remove') && (cleanText.toLowerCase().includes('shopping list') || cleanText.toLowerCase().includes('from shopping'))) {
                handleRemoveFromShoppingList(cleanText);
            }
            else if ((cleanText.toLowerCase().includes('show') || cleanText.toLowerCase().includes('what') || cleanText.toLowerCase().includes('read')) && cleanText.toLowerCase().includes('shopping')) {
                showShoppingList();
            }
            else if (cleanText.toLowerCase().includes('clear') && cleanText.toLowerCase().includes('shopping')) {
                clearShoppingList();
            }
            // Reminder queries - SEPARATE CHECK
            else if (cleanText.toLowerCase().includes('remind')) {
                createReminderFromText(cleanText);
            }
            // Show reminders - Make more specific to avoid matching "shopping list"
            else if ((cleanText.toLowerCase().includes('show') || cleanText.toLowerCase().includes('my reminder') || cleanText.toLowerCase().includes('list reminder')) && 
                     !cleanText.toLowerCase().includes('shopping')) {
                if (reminders.length === 0) {
                    const msg = "You haven't set any reminders yet. Would you like me to remind you of something?";
                    addChatMessage(msg, false);
                    speak(msg);
                    waitingForReminder = true;
                } else {
                    const msg = `You have ${reminders.length} reminder${reminders.length > 1 ? 's' : ''}. Check the list below.`;
                    addChatMessage(msg, false);
                    speak(msg);
                    document.getElementById('reminders-section').classList.remove('hidden');
                }
            }
            // Delete/clear reminders
            else if (cleanText.toLowerCase().includes('clear') && cleanText.toLowerCase().includes('reminder')) {
                clearAllReminders();
            }
            // Memory Recall - VERY specific patterns only (don't match weather/location queries!)
            else if (
                // "Where is/are my [thing]" - but NOT "my location"
                (cleanText.toLowerCase().match(/^where\s+(is|are)\s+my\s+\w+/i) && 
                 !cleanText.toLowerCase().includes('location')) ||
                // "Where did I put/leave my [thing]"
                cleanText.toLowerCase().match(/^where\s+did\s+i\s+(put|leave)\s+(my|the)\s+/i) ||
                // "Find my [thing]" - but NOT "my location"  
                (cleanText.toLowerCase().match(/^find\s+my\s+\w+/i) && 
                 !cleanText.toLowerCase().includes('location'))
            ) {
                handleMemoryRecall(cleanText);
            }
            // Memory Storage (where things are) - but NOT weather/location queries
            else if (
                (cleanText.toLowerCase().includes('my ') || 
                 cleanText.toLowerCase().includes('i put') || 
                 cleanText.toLowerCase().includes('i left')) && 
                (cleanText.toLowerCase().includes(' is ') || 
                 cleanText.toLowerCase().includes(' are ') || 
                 cleanText.toLowerCase().includes(' in ') || 
                 cleanText.toLowerCase().includes(' on ') || 
                 cleanText.toLowerCase().includes(' at ')) &&
                // Exclude weather/location queries
                !cleanText.toLowerCase().includes('weather') &&
                !cleanText.toLowerCase().includes('location') &&
                !cleanText.toLowerCase().includes('temperature')
            ) {
                handleMemoryStorage(cleanText);
            }
            // Creator Info
            else if (cleanText.toLowerCase().match(/\b(who (created|made|built|developed) (you|this|unify)|who (is|are) (your|the) (creator|developer|maker|author)|tell me about (your|the) creator|who owns (you|this))\b/i)) {
                const creatorMsg = `I was created by Prithviraju Venkataraman, a developer passionate about AI and voice interfaces. I was built to help his family mainly with travel planning, weather updates, shopping lists, reminders, and more but later on thought, why not make this as a Vibe Coded Project! Cool isn't it? If you see any bugs or room for improvement, click on Request feature.`;
                addChatMessage(creatorMsg, false);
                speak("I was created by Prithviraju Venkataraman. This started as a family project and became a Vibe Coded Project!");
            }
            // Help/Features query
            else if (cleanText.toLowerCase().match(/what (can you do|are your features?|features?|do you have|is your feature)/i) ||
                     cleanText.toLowerCase().match(/\b(help|capabilities|what are you)\b/i) ||
                     cleanText.toLowerCase().match(/what (do|can) you (do|offer|provide)/i)) {
                const helpMsg = `Hey! I'm here to make your life easier. Here's what I can help with:

üå§Ô∏è Weather - Ask about weather anywhere!
  ‚Üí "What's the weather?"
  ‚Üí "Will it rain in Seattle?"
  ‚Üí "Temperature in Paris?"

üõí Shopping Lists - Add items with quantities!
  ‚Üí "Add 2 pounds of chicken to my list"
  ‚Üí "Add 1 gallon of milk"
  ‚Üí "Also add 3 apples"

‚è∞ Reminders - Never forget again!
  ‚Üí "Remind me to call mom at 5pm"
  ‚Üí "Remind me tomorrow to buy groceries"

üîë Memory - I'll remember where you put things!
  ‚Üí "My car keys are on the counter"
  ‚Üí "Where are my keys?"

‚úàÔ∏è Travel Planning - Plan your trips!
  ‚Üí "Plan a 3-day trip to Tokyo"

Just talk to me naturally!`;
                addChatMessage(helpMsg, false);
                speak("I can help with weather, shopping lists with quantities, reminders, memory, and travel planning. Just talk to me naturally!");
            }
            // Itinerary/Travel Planning - Check BEFORE AI fallback
            else if (cleanText.toLowerCase().includes('trip') || 
                     cleanText.toLowerCase().includes('itinerary') || 
                     cleanText.toLowerCase().includes('itenarary') ||
                     cleanText.toLowerCase().includes('itenary') ||
                     cleanText.toLowerCase().includes('vacation') ||
                     cleanText.toLowerCase().includes('visit') && cleanText.toLowerCase().match(/\b(to|in|for)\b/) ||
                     (cleanText.toLowerCase().includes('plan') && (cleanText.toLowerCase().includes('travel') || cleanText.toLowerCase().includes('visit')))) {
                
                console.log('‚úàÔ∏è ITINERARY MODE TRIGGERED!');
                console.log('Input text:', text);
                
                // Use AI to create detailed itinerary - PLACES ONLY
                const itineraryPrompt = `Create a beautifully formatted day-by-day itinerary for: "${text}". 

FOCUS ONLY ON: Places to visit and activities to do
DO NOT INCLUDE: Food recommendations, hotels, or restaurants (user can ask separately)

Keep it concise (5-7 main attractions per day maximum).

Format with visual appeal:
**Day [number] in [City]:**

üïê **[Time]:** [Place/Activity]
   - What to see/do there
   - Duration and any entry info
   - Travel time to next spot

Use emojis strategically:
- üïê üïë üïí for times
- üèõÔ∏è for temples/historic sites
- üå≥ for parks/nature
- üé® for museums/art
- üèñÔ∏è for beaches
- ‚õ∞Ô∏è for mountains
- üö∂ for walking areas

Example:
**Day 1 in Chidambaram:**

üïê **6:00am:** üèõÔ∏è Thillai Nataraja Temple
   - Witness morning rituals and explore stunning Dravidian architecture
   - Duration: 3 hours
   - Gold-roofed sanctum is a must-see

üïí **9:30am:** üèõÔ∏è Thillai Kali Amman Temple  
   - Significant temple dedicated to Goddess Kali
   - Duration: 1 hour
   - üöó Travel time: 15 mins

üïô **11:00am:** üå≥ Pichavaram Mangrove Forest
   - Rowboat through world's second-largest mangrove forest
   - Duration: 2.5 hours
   - üöó Travel time: 40 mins

End with: "Enjoy exploring the beauty of [City]! Ask me about restaurants or hotels if you need recommendations."

Now create the itinerary with beautiful formatting and emojis!`;
                
                const aiResponse = await callAIWithTyping(itineraryPrompt);
                addChatMessage(aiResponse.response, false);
                speak("I've created an itinerary for you. Check the chat for details!");
                
                // Save to history
                saveToHistory(text, aiResponse.response);
                
                // CRITICAL: Stop here to prevent falling through to AI fallback
                return;
            }
            // Local Food Specialties / Culture Questions - BROAD DETECTION
            // Catches: "Food in X?", "What to eat in X?", "X cuisine?", "Famous dishes in X?"
            else if (
                // Pattern 1: "[adjective] food/cuisine/dishes in [place]"
                (cleanText.toLowerCase().match(/\b(food|cuisine|dishes?|specialt(y|ies))\s+(in|of|from)\s+\w+/i)) ||
                // Pattern 2: "[place] food/cuisine/dishes"
                (cleanText.toLowerCase().match(/\w+\s+(food|cuisine|dishes?|specialt(y|ies))/i) && cleanText.split(' ').length <= 6) ||
                // Pattern 3: "what to eat/try in [place]"
                (cleanText.toLowerCase().match(/what\s+(to|should|can|do)\s+(eat|try|have)/i)) ||
                // Pattern 4: "famous/special/local/traditional [food terms]"
                (cleanText.toLowerCase().match(/\b(famous|special|local|traditional|authentic|signature|must.try|typical)\b/i) && 
                 cleanText.toLowerCase().match(/\b(food|dish|dishes|cuisine|eat)\b/i)) ||
                // Pattern 5: Simple "food in [place]" or "[place] food"
                (cleanText.toLowerCase().match(/\b(food|cuisine)\b/i) && !cleanText.toLowerCase().match(/\b(restaurant|hotel|where|best)\b/i))
            ) {
                
                console.log('üç≤ LOCAL FOOD SPECIALTY MODE');
                
                // This is asking about local food culture, not specific restaurants
                const specialtyPrompt = `Answer this question about local food and specialties: "${text}"

Provide information about the LOCAL FOOD CULTURE and FAMOUS DISHES of the region mentioned.

Format:
üçΩÔ∏è **Famous Local Dishes:**
- Dish name - Brief description and what makes it special
- Where it's typically served (occasion/context)

Include 5-7 signature dishes that represent the local cuisine.

Example for "What's the food like in Chidambaram?":
üçΩÔ∏è **Famous Chidambaram/Tamil Nadu Dishes:**
- Idli & Sambar - Soft steamed rice cakes with lentil stew, breakfast staple
- Dosa - Crispy rice crepe, served with chutneys and sambar
- Chettinad Chicken - Fiery red curry with aromatic spices, regional specialty
- Pongal - Savory rice and lentil dish, comfort food
- Filter Coffee - Strong South Indian coffee, cultural icon

üå∂Ô∏è **What Makes It Special:**
Tamil Nadu cuisine is known for rice-based dishes, fermented batters, and bold use of spices like curry leaves, mustard seeds, and tamarind.

üí° **Pro Tip:** Best enjoyed at local eateries and traditional homes. Try eating on a banana leaf for authentic experience!

If you'd like specific restaurant recommendations, just ask!

Now answer about the local food culture and famous dishes!`;
                
                const aiResponse = await callAIWithTyping(specialtyPrompt);
                addChatMessage(aiResponse.response, false);
                speak("Let me tell you about the local food specialties!");
                
                // Save to history
                saveToHistory(text, aiResponse.response);
            }
            // Handle veg preference response - CHECK FIRST, BEFORE PATTERN MATCHING
            if (window.waitingForVegPreference) {
                window.waitingForVegPreference = false;
                const originalQuery = window.pendingFoodQuery;
                const wasHotelQuery = window.isHotelQuery;
                window.pendingFoodQuery = null;
                window.isHotelQuery = false;
                
                let preference = '';
                if (cleanText.match(/\b(1|one|veg|vegetarian|pure veg)\b/i)) {
                    preference = wasHotelQuery ? ' (hotels with pure vegetarian restaurants)' : ' (pure vegetarian options only)';
                } else if (cleanText.match(/\b(2|two|non-veg|non veg|meat)\b/i)) {
                    preference = wasHotelQuery ? ' (hotels with non-vegetarian restaurants)' : ' (non-vegetarian options)';
                } else if (cleanText.match(/\b(3|three|anything|any|both|either)\b/i)) {
                    preference = wasHotelQuery ? ' (hotels with both veg and non-veg options)' : ' (both veg and non-veg options)';
                } else {
                    // Didn't understand, ask again
                    const msg = "I didn't catch that. Please say 1 for Pure Veg, 2 for Non-Veg, or 3 for Anything.";
                    addChatMessage(msg, false);
                    speak(msg);
                    window.waitingForVegPreference = true;
                    window.isHotelQuery = wasHotelQuery;
                    window.pendingFoodQuery = originalQuery;
                    return;
                }
                
                // Continue with original query + preference
                const finalQuery = originalQuery + preference;
                const queryType = wasHotelQuery ? 'hotel' : 'food';
                
                const recommendPrompt = queryType === 'hotel' ? 
                `Answer this question about hotel recommendations: "${finalQuery}"

Provide 4-6 specific hotel recommendations with these details for EACH:
- Hotel name - Brief description
- Price range (Budget/Mid-range/Luxury)
- Restaurant type: [Pure Veg / Non-Veg / Both]
- Local specialty dish if available
- Why it's recommended

Keep it SHORT and COMPLETE.

${finalQuery.includes('pure vegetarian') ? 'IMPORTANT: Only suggest hotels with PURE VEGETARIAN restaurants.' : ''}
${finalQuery.includes('non-vegetarian') ? 'IMPORTANT: Only suggest hotels with NON-VEGETARIAN restaurants or both options.' : ''}
${finalQuery.includes('both veg and non-veg') ? 'IMPORTANT: Suggest a mix of hotels with different restaurant types.' : ''}

Example format:
- The Saradharam - Near Nataraja Temple, traditional stay | Mid-range | Pure Veg restaurant | Try: Chettinad meals | Perfect for temple visits
- Hotel Akshaya - Modern, family-friendly | Budget | Non-Veg restaurant | Try: Local biryani | Central location

End with: "I hope you have a comfortable stay! Let me know if you need restaurant suggestions."

Now answer completely!` :

                `Answer this question about travel recommendations: "${finalQuery}"

Provide 4-6 specific recommendations with brief details.
Keep it SHORT and COMPLETE.

${finalQuery.includes('vegetarian') || finalQuery.includes('pure veg') ? 'IMPORTANT: Only suggest VEGETARIAN/VEG restaurants. Mark each as [Pure Veg].' : 'Mark each restaurant as [Pure Veg] or [Non-Veg].'}

${queryType === 'food' ? 'Also mention the local specialty dish for the region!' : ''}

Format:
- Name - Brief description | [Veg Type] | Try: [Local specialty]
- Include why it's good
- End with a friendly note

Example for "Best restaurants in Paris":
- Le Comptoir du Relais - Classic French bistro | [Non-Veg] | Try: Coq au vin
- L'As du Fallafel - Famous in Marais | [Veg] | Try: Falafel wrap | Budget-friendly

Bon app√©tit! Let me know if you need more suggestions.

Now answer the question completely!`;
                
                const aiResponse = await callAIWithTyping(recommendPrompt);
                addChatMessage(aiResponse.response, false);
                speak(queryType === 'hotel' ? "I've got some hotel recommendations for you!" : "I've got some recommendations for you!");
                
                // Save to history
                saveToHistory(finalQuery, aiResponse.response);
                return; // EXIT - don't process further
            }
            // Food, Hotels, Transport recommendations - FLEXIBLE DETECTION
            else if (cleanText.toLowerCase().match(/\b(restaurant|eat|eating|dining|meal|lunch|dinner|breakfast|cafe|cafes|place to eat|places to eat)\b/i) ||
                     cleanText.toLowerCase().match(/\b(hotel|hotels|stay|staying|accommodation|accommodations|lodge|resort|hostel|place to stay|places to stay|where can i stay|where should i stay)\b/i) ||
                     cleanText.toLowerCase().match(/\b(transport|transportation|bus|train|taxi|uber|ola|auto|rickshaw|metro|subway|getting around|get around|how to reach|how do i get|travel to)\b/i)) {
                
                console.log('üçΩÔ∏è RECOMMENDATION MODE (Food/Hotels/Transport)');
                
                // Check if it's a restaurant/food query
                const isFoodQuery = cleanText.toLowerCase().match(/\b(food|restaurant|eat|eating|dining|cuisine|dish|dishes|meal|lunch|dinner|breakfast|cafe|cafes|place to eat|places to eat)\b/i);
                const isHotelQuery = cleanText.toLowerCase().match(/\b(hotel|hotels|stay|staying|accommodation|accommodations|lodge|resort|hostel|place to stay|places to stay|where can i stay|where should i stay)\b/i);
                
                // Check if user already specified preference
                const hasVegPref = cleanText.toLowerCase().match(/\b(veg|vegetarian|pure veg|only veg|veg only)\b/i);
                const hasNonVegPref = cleanText.toLowerCase().match(/\b(non-veg|non veg|nonveg|meat|chicken|seafood|anything)\b/i);
                
                // If it's a food query and no preference specified, ask for preference
                if (isFoodQuery && !hasVegPref && !hasNonVegPref && !window.waitingForVegPreference) {
                    window.pendingFoodQuery = text;
                    window.waitingForVegPreference = true;
                    window.isHotelQuery = false;
                    
                    const prefMsg = "Would you prefer:\n1. Pure Veg\n2. Non-Veg\n3. Anything is fine\n\nYou can say the number or the preference!";
                    addChatMessage(prefMsg, false);
                    speak("Would you prefer pure veg, non veg, or anything is fine?");
                    return;
                }
                
                // If it's a hotel query, ask for food preference
                if (isHotelQuery && !hasVegPref && !hasNonVegPref && !window.waitingForVegPreference) {
                    window.pendingFoodQuery = text;
                    window.waitingForVegPreference = true;
                    window.isHotelQuery = true;
                    
                    const prefMsg = "For hotel restaurants, would you prefer:\n1. Pure Veg\n2. Non-Veg\n3. Anything is fine\n\nYou can say the number or the preference!";
                    addChatMessage(prefMsg, false);
                    speak("For hotel restaurants, would you prefer pure veg, non veg, or anything is fine?");
                    return;
                }
                
                // If we get here, it's a NEW query (not continuing from veg preference)
                // Determine query type from the current text
                const queryType = cleanText.toLowerCase().match(/\b(hotel|hotels|stay|staying|accommodation)\b/i) ? 'hotel' : 
                                  cleanText.toLowerCase().match(/\b(transport|bus|train|taxi)\b/i) ? 'transport' : 'food';
                
                const recommendPrompt = queryType === 'hotel' ? 
                `Answer this question about hotel recommendations: "${text}"

Provide 4-6 specific hotel recommendations with these details for EACH:
- Hotel name - Brief description
- Price range (Budget/Mid-range/Luxury)
- Restaurant type: [Pure Veg / Non-Veg / Both]
- Local specialty dish if available
- Why it's recommended

Keep it SHORT and COMPLETE.

${text.includes('vegetarian') || text.includes('pure veg') ? 'IMPORTANT: Only suggest hotels with PURE VEGETARIAN restaurants.' : ''}

Example format:
- The Saradharam - Near Nataraja Temple, traditional stay | Mid-range | Pure Veg restaurant | Try: Chettinad meals | Perfect for temple visits
- Hotel Akshaya - Modern, family-friendly | Budget | Both Veg & Non-Veg | Try: Local biryani | Central location

End with: "I hope you have a comfortable stay! Let me know if you need restaurant suggestions."

Now answer completely!` :

                `Answer this question about travel recommendations: "${text}"

Provide 4-6 specific recommendations with brief details.
Keep it SHORT and COMPLETE.

${text.includes('vegetarian') || text.includes('pure veg') ? 'IMPORTANT: Only suggest VEGETARIAN/VEG restaurants. Mark each as [Pure Veg].' : 'Mark each restaurant as [Pure Veg] or [Non-Veg].'}

${queryType === 'food' ? 'Also mention the local specialty dish for the region!' : ''}

Format:
- Name - Brief description | [Veg Type] | Try: [Local specialty]
- Include why it's good
- End with a friendly note

Example for "Best restaurants in Paris":
- Le Comptoir du Relais - Classic French bistro | [Non-Veg] | Try: Coq au vin
- L'As du Fallafel - Famous in Marais | [Veg] | Try: Falafel wrap | Budget-friendly

Bon app√©tit! Let me know if you need more suggestions.

Now answer the question completely!`;
                
                const aiResponse = await callAIWithTyping(recommendPrompt);
                addChatMessage(aiResponse.response, false);
                speak(queryType === 'hotel' ? "I've got some hotel recommendations for you!" : "I've got some recommendations for you!");
                
                // Save to history
                saveToHistory(text, aiResponse.response);
            }
            // Use AI for unclear queries and casual chat
            else {
                console.log('üí¨ CASUAL CHAT MODE');
                console.log('Input text:', text);
                console.log('Checking conditions:');
                console.log('  includes trip?', cleanText.toLowerCase().includes('trip'));
                console.log('  includes itinerary?', cleanText.toLowerCase().includes('itinerary'));
                console.log('  includes vacation?', cleanText.toLowerCase().includes('vacation'));
                
                const aiResponse = await callAIWithTyping(text);
                addChatMessage(aiResponse.response, false);
                speak(aiResponse.response);
                
                // Save to history
                saveToHistory(text, aiResponse.response);
            }
        }

        // ========== WEATHER FUNCTIONS ==========
        function createWeatherEffect(weatherCode, temperature) {
            const container = document.getElementById('weather-effects');
            container.innerHTML = ''; // Clear existing effects
            
            // Snow (codes 71-77)
            if (weatherCode >= 71 && weatherCode <= 77) {
                for (let i = 0; i < 50; i++) {
                    const snowflake = document.createElement('div');
                    snowflake.className = 'snowflake';
                    snowflake.textContent = '‚ùÑ';
                    snowflake.style.left = Math.random() * 100 + '%';
                    snowflake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    snowflake.style.animationDelay = Math.random() * 5 + 's';
                    snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                    container.appendChild(snowflake);
                }
                document.body.style.background = 'linear-gradient(to bottom, #B8C6DB, #F5F7FA)';
            }
            // Rain (codes 51-67, 80-82)
            else if ((weatherCode >= 51 && weatherCode <= 67) || (weatherCode >= 80 && weatherCode <= 82)) {
                for (let i = 0; i < 100; i++) {
                    const raindrop = document.createElement('div');
                    raindrop.className = 'raindrop';
                    raindrop.style.left = Math.random() * 100 + '%';
                    raindrop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                    raindrop.style.animationDelay = Math.random() * 2 + 's';
                    container.appendChild(raindrop);
                }
                // Add clouds for rain
                for (let i = 1; i <= 3; i++) {
                    const cloud = document.createElement('div');
                    cloud.className = `cloud cloud-${i}`;
                    container.appendChild(cloud);
                }
                document.body.style.background = 'linear-gradient(to bottom, #4A5568, #718096)';
            }
            // Thunderstorm (codes 95-99)
            else if (weatherCode >= 95 && weatherCode <= 99) {
                for (let i = 0; i < 80; i++) {
                    const raindrop = document.createElement('div');
                    raindrop.className = 'raindrop';
                    raindrop.style.left = Math.random() * 100 + '%';
                    raindrop.style.animationDuration = (Math.random() * 0.3 + 0.3) + 's';
                    raindrop.style.animationDelay = Math.random() * 1 + 's';
                    container.appendChild(raindrop);
                }
                // Random lightning
                setInterval(() => {
                    if (Math.random() > 0.95) {
                        const lightning = document.createElement('div');
                        lightning.className = 'lightning';
                        container.appendChild(lightning);
                        setTimeout(() => lightning.remove(), 200);
                    }
                }, 1000);
                document.body.style.background = 'linear-gradient(to bottom, #2D3748, #4A5568)';
            }
            // Clear/Sunny (code 0-3)
            else if (weatherCode >= 0 && weatherCode <= 3) {
                const sun = document.createElement('div');
                sun.className = 'sun';
                container.appendChild(sun);
                
                // Add some clouds for partly cloudy
                if (weatherCode > 0) {
                    for (let i = 1; i <= 2; i++) {
                        const cloud = document.createElement('div');
                        cloud.className = `cloud cloud-${i}`;
                        container.appendChild(cloud);
                    }
                }
                
                // Hot day effect
                if (temperature > 30) {
                    const heatWave = document.createElement('div');
                    heatWave.className = 'heat-wave';
                    container.appendChild(heatWave);
                    document.body.style.background = 'linear-gradient(to bottom, #FDB750, #FFDAA5)';
                } else {
                    document.body.style.background = 'linear-gradient(to bottom right, #87CEEB, #E0F6FF, #FFF8DC)';
                }
            }
            // Overcast/Cloudy (codes 45-48 fog, or other cloudy conditions)
            else {
                for (let i = 1; i <= 3; i++) {
                    const cloud = document.createElement('div');
                    cloud.className = `cloud cloud-${i}`;
                    container.appendChild(cloud);
                }
                document.body.style.background = 'linear-gradient(to bottom, #A0AEC0, #CBD5E0)';
            }
            
            // Freezing cold effect (any weather below 5¬∞C)
            if (temperature < 5) {
                document.body.style.filter = 'brightness(0.9) contrast(1.1)';
                // Add extra snowflakes even if not snowing
                if (weatherCode < 71 || weatherCode > 77) {
                    for (let i = 0; i < 20; i++) {
                        const snowflake = document.createElement('div');
                        snowflake.className = 'snowflake';
                        snowflake.textContent = '‚ùÑ';
                        snowflake.style.left = Math.random() * 100 + '%';
                        snowflake.style.animationDuration = (Math.random() * 4 + 3) + 's';
                        snowflake.style.animationDelay = Math.random() * 5 + 's';
                        snowflake.style.fontSize = (Math.random() * 8 + 8) + 'px';
                        snowflake.style.opacity = '0.6';
                        container.appendChild(snowflake);
                    }
                }
            } else {
                document.body.style.filter = 'none';
            }
        }

        function extractLocationFromSentence(text) {
            const lower = text.toLowerCase();
            
            // Check for "current location" keywords - return null to trigger geolocation
            const currentLocationKeywords = ['my location', 'current location', 'my current location', 'here', 'where i am', 'my area', 'this location'];
            for (const keyword of currentLocationKeywords) {
                if (lower.includes(keyword)) {
                    return null; // Will trigger geolocation
                }
            }
            
            // Remove common time phrases first
            let cleanText = text;
            const timeWords = ['right now', 'now', 'today', 'tomorrow', 'tonight', 'currently', 'at the moment'];
            timeWords.forEach(word => {
                cleanText = cleanText.replace(new RegExp(word, 'gi'), '');
            });
            
            const patterns = [
                /(?:weather|temperature|rain|snow|hot|cold|forecast)\s+(?:in|at|for)\s+([^?]+)/i,
                /(?:in|at)\s+([^?]+?)\s*(?:weather|temperature|rain|snow|hot|cold)/i,
                /(?:how'?s?|what'?s?|how is|what is)\s+(?:the\s+)?(?:weather|temperature)\s+(?:in|at|for)\s+([^?]+)/i,
            ];
            
            for (const pattern of patterns) {
                const match = cleanText.match(pattern);
                if (match && match[1]) {
                    let location = match[1].trim();
                    // Clean up the location string
                    location = location.replace(/[?.!,;]$/g, '').trim();
                    
                    // Double-check it's not a current location keyword
                    const locationLower = location.toLowerCase();
                    for (const keyword of currentLocationKeywords) {
                        if (locationLower.includes(keyword)) {
                            return null; // Trigger geolocation
                        }
                    }
                    
                    if (location.length > 0) return location;
                }
            }
            return null;
        }

        async function getWeatherByCity(cityName) {
            try {
                const searchName = expandStateAbbreviation(cityName.trim());
                
                // Get up to 5 results to handle ambiguity better
                const nominatimResponse = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchName)}&format=json&limit=5&addressdetails=1`,
                    { headers: { 'User-Agent': 'UnifyVoiceAssistant/1.0' } }
                );
                
                const nominatimData = await nominatimResponse.json();
                
                if (!nominatimData || nominatimData.length === 0) {
                    const errorMsg = `Hmm, I couldn't find "${cityName}". Could you try saying it a different way? Like "Boston" or "Paris, France"?`;
                    addChatMessage(errorMsg, false);
                    speak(errorMsg);
                    return;
                }
                
                // Check if there are multiple distinct locations (different countries/states)
                const uniqueLocations = [];
                const seenCountries = new Set();
                
                for (const loc of nominatimData) {
                    const addr = loc.address;
                    const country = addr.country;
                    const state = addr.state || '';
                    const key = `${country}-${state}`;
                    
                    // Only add if this country/state combo hasn't been seen
                    if (!seenCountries.has(key) && uniqueLocations.length < 3) {
                        seenCountries.add(key);
                        uniqueLocations.push(loc);
                    }
                }
                
                // If multiple distinct locations found, ask user to disambiguate
                if (uniqueLocations.length > 1 && !cityName.includes(',')) {
                    const options = uniqueLocations.map((loc, index) => {
                        const addr = loc.address;
                        let name = addr.city || addr.town || addr.village || addr.hamlet || loc.display_name.split(',')[0];
                        if (addr.state) name += `, ${addr.state}`;
                        if (addr.country) name += `, ${addr.country}`;
                        return `${index + 1}. ${name}`;
                    }).join('\n');
                    
                    const disambigMsg = `I found multiple places called "${cityName}":\n\n${options}\n\nWhich one did you mean? You can say the full name or just the number.`;
                    addChatMessage(disambigMsg, false);
                    speak(`I found multiple places called ${cityName}. Which one did you mean?`);
                    
                    // Store options for later selection
                    window.pendingLocationChoices = uniqueLocations;
                    window.waitingForLocationChoice = true;
                    return;
                }
                
                // Use the first (best) result
                const location = nominatimData[0];
                const latitude = parseFloat(location.lat);
                const longitude = parseFloat(location.lon);
                
                const addr = location.address;
                let locationName = addr.city || addr.town || addr.village || addr.hamlet || location.display_name.split(',')[0];
                if (addr.state) locationName += `, ${addr.state}`;
                if (addr.country) locationName += `, ${addr.country}`;
                
                // Pass both original query and resolved location
                await fetchWeather(latitude, longitude, locationName, cityName.trim());
                
            } catch (error) {
                console.error('Location search error:', error);
                const errorMsg = `Sorry, I'm having trouble looking that up right now. Mind trying again?`;
                addChatMessage(errorMsg, false);
                speak(errorMsg);
            }
        }

        async function fetchWeather(lat, lon, resolvedLocation, originalQuery = null) {
            showLoading('Checking weather...');
            try {
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,precipitation&timezone=auto`
                );
                weather = await weatherResponse.json();
                
                const celsius = Math.round(weather.current.temperature_2m);
                const fahrenheit = Math.round((celsius * 9/5) + 32);
                const advice = getWeatherAdvice(weather);
                
                // Create weather effects
                createWeatherEffect(weather.current.weather_code, celsius);
                
                // Determine display location
                let displayLocation = resolvedLocation;
                if (originalQuery && originalQuery.toLowerCase() !== resolvedLocation.toLowerCase()) {
                    // Show "Roxbury, MA (Boston, Massachusetts, United States)"
                    displayLocation = `${originalQuery} (${resolvedLocation})`;
                }
                
                document.getElementById('weather-card').classList.remove('hidden');
                document.getElementById('location-name').textContent = displayLocation;
                document.getElementById('temperature').textContent = `${fahrenheit}¬∞F / ${celsius}¬∞C`;
                document.getElementById('weather-advice').textContent = advice;
                
                hideLoading();
                const weatherMsg = `The temperature in ${displayLocation} is ${fahrenheit}¬∞F (${celsius}¬∞C). ${advice}`;
                addChatMessage(weatherMsg, false);
                speak(weatherMsg);
                
            } catch (error) {
                hideLoading();
                console.error('Weather error:', error);
                const errorMsg = "Sorry, I couldn't fetch the weather data right now. Please try again later.";
                addChatMessage(errorMsg, false);
                speak(errorMsg);
            }
        }

        function getWeatherAdvice(weatherData) {
            const code = weatherData.current.weather_code;
            const temp = weatherData.current.temperature_2m;
            
            if (code >= 51 && code <= 67) return "It's going to rain. Don't forget your umbrella!";
            if (code >= 71 && code <= 77) return "Snow expected! Dress warm and stay safe!";
            if (code >= 80 && code <= 99) return "Thunderstorms possible. Stay indoors if you can!";
            if (temp < 5) return "It's freezing outside! Bundle up with warm layers!";
            if (temp > 30) return "Hot day ahead! Stay hydrated and seek shade!";
            if (code === 0) return "Perfect weather! Great day to be outside!";
            return "Have a wonderful day!";
        }

        function willItRain(weatherCode) {
            // Rain codes: 51-67 (drizzle and rain), 80-82 (rain showers), 95-99 (thunderstorms)
            return (weatherCode >= 51 && weatherCode <= 67) || 
                   (weatherCode >= 80 && weatherCode <= 82) || 
                   (weatherCode >= 95 && weatherCode <= 99);
        }

        function willItSnow(weatherCode) {
            // Snow codes: 71-77, 85-86
            return (weatherCode >= 71 && weatherCode <= 77) || 
                   (weatherCode >= 85 && weatherCode <= 86);
        }

        function expandStateAbbreviation(location) {
            const states = {
                'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California','CO':'Colorado',
                'CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia','HI':'Hawaii','ID':'Idaho',
                'IL':'Illinois','IN':'Indiana','IA':'Iowa','KS':'Kansas','KY':'Kentucky','LA':'Louisiana',
                'ME':'Maine','MD':'Maryland','MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi',
                'MO':'Missouri','MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey',
                'NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio',
                'OK':'Oklahoma','OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
                'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont','VA':'Virginia',
                'WA':'Washington','WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming'
            };
            
            for (const [abbr, full] of Object.entries(states)) {
                const regex = new RegExp(`\\b${abbr}\\b`, 'gi');
                if (regex.test(location)) return location.replace(regex, full);
            }
            return location;
        }

        // ========== REMINDER FUNCTIONS ==========
        function createReminderFromText(text) {
            const reminder = {
                id: Date.now(),
                text: text,
                time: extractTime(text),
                created: new Date().toLocaleString(),
                alarmTime: calculateAlarmTime(text)
            };
            reminders.push(reminder);
            saveRemindersToStorage();
            updateRemindersList();
            const reminderMsg = `Got it! I'll remind you: ${text}`;
            addChatMessage(reminderMsg, false);
            speak(reminderMsg);
            
            if (reminder.alarmTime) setAlarm(reminder);
        }

        function extractTime(text) {
            const lower = text.toLowerCase();
            if (lower.includes('tomorrow')) return 'tomorrow';
            if (lower.includes('today')) return 'today';
            if (lower.includes('tonight')) return 'tonight';
            const match = lower.match(/(\d{1,2})\s*(am|pm)/);
            if (match) return match[0];
            return 'later';
        }

        function calculateAlarmTime(text) {
            const lower = text.toLowerCase();
            const now = new Date();
            
            if (lower.includes('tomorrow')) {
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0, 0, 0);
                return tomorrow;
            }
            
            const match = lower.match(/(\d{1,2})\s*(am|pm)/);
            if (match) {
                let hour = parseInt(match[1]);
                const isPM = match[2] === 'pm';
                if (isPM && hour !== 12) hour += 12;
                if (!isPM && hour === 12) hour = 0;
                const alarmTime = new Date(now);
                alarmTime.setHours(hour, 0, 0, 0);
                if (alarmTime < now) alarmTime.setDate(alarmTime.getDate() + 1);
                return alarmTime;
            }
            return null;
        }

        function setAlarm(reminder) {
            if (!reminder.alarmTime) return;
            const timeUntilAlarm = reminder.alarmTime - new Date();
            if (timeUntilAlarm > 0) {
                setTimeout(() => triggerAlarm(reminder), timeUntilAlarm);
            }
        }

        function triggerAlarm(reminder) {
            const overlay = document.getElementById('alarm-overlay');
            const notification = document.getElementById('alarm-notification');
            
            overlay.classList.remove('hidden');
            notification.className = 'alarm-notification bg-white rounded-3xl shadow-2xl p-8 max-w-md';
            notification.innerHTML = `
                <div class="text-center">
                    <div class="mb-4">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600 mx-auto animate-bounce">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">‚è∞ Reminder!</h2>
                    <p class="text-lg text-gray-700 mb-6">${escapeHtml(reminder.text)}</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="snoozeAlarm(${reminder.id})" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl transition-all">
                            Snooze 5min
                        </button>
                        <button onclick="dismissAlarm(${reminder.id})" class="px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-xl transition-all">
                            Dismiss
                        </button>
                    </div>
                </div>
            `;
            speak(`Reminder: ${reminder.text}`);
        }

        function snoozeAlarm(id) {
            const reminder = reminders.find(r => r.id === id);
            if (reminder) {
                reminder.alarmTime = new Date(Date.now() + 5 * 60 * 1000);
                setAlarm(reminder);
                saveRemindersToStorage();
            }
            dismissAlarm(id);
        }

        function dismissAlarm(id) {
            document.getElementById('alarm-overlay').classList.add('hidden');
            document.getElementById('alarm-notification').classList.add('hidden');
        }

        function checkReminders() {
            setInterval(() => {
                const now = new Date();
                reminders.forEach(reminder => {
                    if (reminder.alarmTime && reminder.alarmTime <= now && !reminder.triggered) {
                        reminder.triggered = true;
                        triggerAlarm(reminder);
                    }
                });
            }, 1000);
        }

        function updateRemindersList() {
            const list = document.getElementById('reminders-list');
            list.innerHTML = '';
            
            if (reminders.length === 0) {
                document.getElementById('reminders-section').classList.add('hidden');
                return;
            }
            
            reminders.forEach(r => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl shadow flex justify-between items-start';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="text-gray-800 font-medium mb-1">${escapeHtml(r.text)}</p>
                        <p class="text-sm text-gray-500">${escapeHtml(r.time)} ‚Ä¢ ${escapeHtml(r.created)}</p>
                    </div>
                    <button onclick="deleteReminder(${r.id})" class="text-red-500 hover:text-red-700 font-medium ml-4 transition-all">Delete</button>
                `;
                list.appendChild(div);
            });
            document.getElementById('reminders-section').classList.remove('hidden');
        }

        function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            saveRemindersToStorage();
            updateRemindersList();
        }

        function clearAllReminders() {
            if (reminders.length === 0) {
                const msg = "You don't have any reminders to clear.";
                addChatMessage(msg, false);
                speak(msg);
                return;
            }
            reminders = [];
            saveRemindersToStorage();
            updateRemindersList();
            const msg = "All reminders have been cleared.";
            addChatMessage(msg, false);
            speak(msg);
        }

        // ========== NAME HANDLING ==========
        function handleNameInput(text) {
            waitingForName = false;
            // Extract clean name from input
            let name = text.trim();
            // Remove common phrases
            name = name.replace(/^(my name is|i'm|i am|it's|call me)\s+/i, '');
            name = name.replace(/[?.!,]$/g, '');
            // Capitalize first letter
            name = name.charAt(0).toUpperCase() + name.slice(1);
            
            userName = name;
            saveUserData();
            
            const response = `Nice to meet you, ${userName}! How can I help you today?`;
            addChatMessage(response, false);
            speak(response);
        }

        // ========== SHOPPING LIST FUNCTIONS ==========
        function handleAddToShoppingList(text) {
            const lower = text.toLowerCase();
            // Extract items after "add" and before "to"
            let items = text;
            
            // Try to extract items between "add" and "to shopping list"
            const match1 = text.match(/add\s+(.+?)\s+to\s+(?:my\s+)?shopping/i);
            if (match1) {
                items = match1[1];
            } else {
                // Try just after "add"
                const match2 = text.match(/(?:add|also|and|plus)\s+(.+)/i);
                if (match2) {
                    items = match2[1];
                }
            }
            
            // Clean up
            items = items.replace(/to (?:my )?shopping list/gi, '');
            items = items.replace(/please/gi, '');
            items = items.replace(/\s+also$/gi, ''); // Remove trailing "also"
            items = items.replace(/\s+too$/gi, ''); // Remove trailing "too"
            
            // Split by common separators
            const itemArray = items.split(/,| and |\n/).map(item => item.trim()).filter(item => item.length > 0);
            
            itemArray.forEach(item => {
                // Capitalize first letter for better display
                const formattedItem = item.charAt(0).toUpperCase() + item.slice(1);
                
                if (!shoppingList.some(existing => existing.toLowerCase() === item.toLowerCase())) {
                    shoppingList.push(formattedItem);
                }
            });
            
            saveUserData();
            updateShoppingListUI();
            
            const msg = itemArray.length === 1 
                ? `Added ${itemArray[0]} to your shopping list!` 
                : `Added ${itemArray.join(', ')} to your shopping list!`;
            addChatMessage(msg, false);
            speak(msg);
        }

        function handleRemoveFromShoppingList(text) {
            const lower = text.toLowerCase();
            let item = text;
            
            // Extract item to remove
            const match1 = text.match(/remove\s+(.+?)\s+from\s+(?:my\s+)?shopping/i);
            if (match1) {
                item = match1[1];
            } else {
                const match2 = text.match(/remove\s+(.+)/i);
                if (match2) {
                    item = match2[1];
                }
            }
            
            item = item.replace(/from (?:my )?shopping list/gi, '').trim();
            
            const index = shoppingList.findIndex(i => i.toLowerCase().includes(item.toLowerCase()));
            if (index !== -1) {
                const removed = shoppingList.splice(index, 1)[0];
                saveUserData();
                updateShoppingListUI();
                const msg = `Removed ${removed} from your shopping list!`;
                addChatMessage(msg, false);
                speak(msg);
            } else {
                const msg = `I couldn't find "${item}" in your shopping list.`;
                addChatMessage(msg, false);
                speak(msg);
            }
        }

        function showShoppingList() {
            if (shoppingList.length === 0) {
                const msg = "Your shopping list is empty. Would you like to add something?";
                addChatMessage(msg, false);
                speak(msg);
            } else {
                const items = shoppingList.join(', ');
                const msg = `You have ${shoppingList.length} item${shoppingList.length > 1 ? 's' : ''} on your shopping list: ${items}`;
                addChatMessage(msg, false);
                speak(msg);
                
                // Show the receipt
                document.getElementById('shopping-receipt').classList.remove('hidden');
            }
        }

        function clearShoppingList() {
            if (shoppingList.length === 0) {
                const msg = "Your shopping list is already empty.";
                addChatMessage(msg, false);
                speak(msg);
                return;
            }
            
            shoppingList = [];
            saveUserData();
            updateShoppingListUI();
            
            const msg = "Shopping list cleared!";
            addChatMessage(msg, false);
            speak(msg);
        }

        function updateShoppingListUI() {
            const receipt = document.getElementById('shopping-receipt');
            const itemsContainer = document.getElementById('receipt-items');
            const countSpan = document.getElementById('receipt-count');
            const dateSpan = document.getElementById('receipt-date');
            
            // Update date/time
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            dateSpan.textContent = `${dateStr} ${timeStr}`;
            
            if (shoppingList.length === 0) {
                itemsContainer.innerHTML = '<div style="text-align: center; color: #999; font-size: 12px; padding: 20px;">No items yet</div>';
                receipt.classList.add('hidden');
            } else {
                receipt.classList.remove('hidden');
                itemsContainer.innerHTML = shoppingList.map((item, index) => `
                    <div class="receipt-item">
                        <div class="receipt-item-text">
                            <span class="receipt-bullet">‚Ä¢</span>
                            <span>${escapeHtml(item)}</span>
                        </div>
                        <button onclick="removeShoppingItem(${index})" class="receipt-delete" title="Remove item">‚úï</button>
                    </div>
                `).join('');
            }
            
            countSpan.textContent = shoppingList.length;
            
            // Update dark mode styling
            if (darkMode) {
                receipt.classList.add('dark-mode');
            } else {
                receipt.classList.remove('dark-mode');
            }
        }

        function removeShoppingItem(index) {
            const removed = shoppingList.splice(index, 1)[0];
            saveUserData();
            updateShoppingListUI();
            const msg = `Removed ${removed}`;
            speak(msg);
        }

        // ========== MEMORY SYSTEM ==========
        function handleMemoryStorage(text) {
            const lower = text.toLowerCase();
            
            // Parse what and where
            // Patterns: "my X is/are in/on/at Y", "I put my X in/on/at Y", "I left my X in/on/at Y"
            let thing = null;
            let location = null;
            let preposition = null;
            
            const patterns = [
                /my\s+(.+?)\s+(?:is|are)\s+(in|on|at)\s+(.+)/i,
                /i\s+put\s+(?:my\s+)?(.+?)\s+(in|on|at)\s+(.+)/i,
                /i\s+left\s+(?:my\s+)?(.+?)\s+(in|on|at)\s+(.+)/i,
                /(?:my\s+)?(.+?)\s+(?:is|are)\s+(in|on|at)\s+(.+)/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match.length === 4) {
                        thing = match[1].trim();
                        preposition = match[2].trim();
                        location = match[3].trim();
                    } else {
                        thing = match[1].trim();
                        location = match[2].trim();
                    }
                    break;
                }
            }
            
            if (thing && location) {
                // Clean up
                thing = thing.replace(/^(the|my|a|an)\s+/i, '');
                location = location.replace(/[?.!,]$/g, '');
                
                // Add preposition to location if we have it
                const fullLocation = preposition ? `${preposition} ${location}` : location;
                
                // Normalize common variations (handle typos and similar items)
                const normalizedThing = normalizeThing(thing);
                
                memoryStore[normalizedThing] = fullLocation;
                saveUserData();
                
                const msg = `Got it! I'll remember that your ${normalizedThing} ${normalizedThing.endsWith('s') ? 'are' : 'is'} ${fullLocation}.`;
                addChatMessage(msg, false);
                speak(msg);
            } else {
                const msg = "I didn't quite catch that. Try saying something like 'My car keys are on the kitchen counter'";
                addChatMessage(msg, false);
                speak(msg);
            }
        }

        // Normalize item names to handle common variations
        function normalizeThing(thing) {
            thing = thing.toLowerCase().trim();
            
            // Common singular to plural mappings
            const singularToPlural = {
                'key': 'keys',
                'glass': 'glasses',
                'sunglass': 'sunglasses',
                'headphone': 'headphones',
                'earbud': 'earbuds'
            };
            
            // Check if it's already plural
            if (thing.endsWith('s')) {
                return thing;
            }
            
            // Check for exact singular match
            if (singularToPlural[thing]) {
                return singularToPlural[thing];
            }
            
            // Check for compound words (e.g., "car key" -> "car keys")
            const words = thing.split(' ');
            const lastWord = words[words.length - 1];
            
            if (singularToPlural[lastWord]) {
                words[words.length - 1] = singularToPlural[lastWord];
                return words.join(' ');
            }
            
            // If last word doesn't end in 's', add it for common objects
            if (!lastWord.endsWith('s') && words.length > 0) {
                words[words.length - 1] = lastWord + 's';
                return words.join(' ');
            }
            
            return thing;
        }

        function handleMemoryRecall(text) {
            const lower = text.toLowerCase();
            
            // Parse what they're looking for
            // Patterns: "where is/are my X", "where did I put X", "where's my X", "do you know where X is", "my X?"
            let thing = null;
            
            const patterns = [
                /(?:do you know )?where\s+(?:is|are)\s+(?:my\s+|the\s+)?(.+)/i,
                /(?:do you know )?where\s+did\s+i\s+(?:put|leave)\s+(?:my\s+|the\s+)?(.+)/i,
                /(?:do you know )?where'?s\s+(?:my\s+|the\s+)?(.+)/i,
                /where\s+(?:my\s+|the\s+)?(.+?)\s+(?:is|are)/i,
                /(?:my\s+|the\s+)?(.+)\s+where/i,
                /^(?:my\s+|the\s+)?(.+)\?$/i  // Just "my car key?"
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    thing = match[1].trim();
                    break;
                }
            }
            
            if (thing) {
                thing = thing.replace(/[?.!,]$/g, '');
                thing = thing.replace(/^(the|my|a|an)\s+/i, '');
                
                // Try exact match first
                let location = memoryStore[thing.toLowerCase()];
                
                // If no exact match, try fuzzy matching
                if (!location) {
                    const match = findBestMemoryMatch(thing);
                    if (match) {
                        location = match.location;
                        thing = match.thing; // Use the stored version
                    }
                }
                
                if (location) {
                    const msg = `You told me your ${thing} ${thing.endsWith('s') ? 'are' : 'is'} ${location}.`;
                    addChatMessage(msg, false);
                    speak(msg);
                } else {
                    const msg = `I don't remember where your ${thing} ${thing.endsWith('s') ? 'are' : 'is'}. You haven't told me about that yet.`;
                    addChatMessage(msg, false);
                    speak(msg);
                }
            } else {
                const msg = "What are you looking for?";
                addChatMessage(msg, false);
                speak(msg);
            }
        }

        // Fuzzy matching helper function
        function findBestMemoryMatch(query) {
            query = query.toLowerCase();
            const keys = Object.keys(memoryStore);
            
            // Try to find the best match
            for (const key of keys) {
                // Exact match
                if (key === query) {
                    return { thing: key, location: memoryStore[key] };
                }
                
                // Singular/plural variations
                if (key === query + 's' || key + 's' === query) {
                    return { thing: key, location: memoryStore[key] };
                }
                
                // Remove 's' from both and compare
                const keySingular = key.replace(/s$/, '');
                const querySingular = query.replace(/s$/, '');
                if (keySingular === querySingular) {
                    return { thing: key, location: memoryStore[key] };
                }
                
                // Partial match (contains)
                if (key.includes(query) || query.includes(key)) {
                    return { thing: key, location: memoryStore[key] };
                }
                
                // Word-by-word match
                const keyWords = key.split(' ');
                const queryWords = query.split(' ');
                const matchCount = keyWords.filter(kw => queryWords.some(qw => 
                    kw === qw || qw === kw + 's' || kw === qw + 's' ||
                    kw.replace(/s$/, '') === qw.replace(/s$/, '')
                )).length;
                if (matchCount >= Math.min(keyWords.length, queryWords.length)) {
                    return { thing: key, location: memoryStore[key] };
                }
            }
            
            // Try Levenshtein distance for typos
            let bestMatch = null;
            let bestDistance = Infinity;
            const maxDistance = Math.floor(query.length / 3); // Allow up to 1/3 character differences
            
            for (const key of keys) {
                const distance = levenshteinDistance(query, key);
                if (distance < bestDistance && distance <= maxDistance) {
                    bestDistance = distance;
                    bestMatch = key;
                }
            }
            
            if (bestMatch) {
                return { thing: bestMatch, location: memoryStore[bestMatch] };
            }
            
            return null;
        }

        // Levenshtein distance algorithm for spell checking
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            matrix[i][j - 1] + 1,     // insertion
                            matrix[i - 1][j] + 1      // deletion
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // ========== LOCAL STORAGE (USER-SPECIFIC) ==========
        function getUserStorageKey() {
            // Use username as part of storage key to separate user data
            const safeUserName = (userName || 'default_user').replace(/[^a-zA-Z0-9]/g, '_');
            return `unify_user_data_${safeUserName}`;
        }
        
        function saveUserData() {
            try {
                const data = {
                    userName: userName,
                    shoppingList: shoppingList,
                    memoryStore: memoryStore,
                    reminders: reminders
                };
                const storageKey = getUserStorageKey();
                localStorage.setItem(storageKey, JSON.stringify(data));
                console.log(`üíæ Saved data for user: ${userName} (key: ${storageKey})`);
            } catch (e) {
                console.error('Failed to save user data:', e);
            }
        }

        function loadUserData() {
            try {
                const storageKey = getUserStorageKey();
                const stored = localStorage.getItem(storageKey);
                console.log(`üìÇ Loading data for user: ${userName} (key: ${storageKey})`);
                if (stored) {
                    const data = JSON.parse(stored);
                    userName = data.userName || null;
                    shoppingList = data.shoppingList || [];
                    memoryStore = data.memoryStore || {};
                    reminders = data.reminders || [];
                    
                    // Restore alarm times for reminders
                    reminders.forEach(r => {
                        if (r.alarmTime) {
                            r.alarmTime = new Date(r.alarmTime);
                            setAlarm(r);
                        }
                    });
                    
                    // Update UI
                    if (reminders.length > 0) updateRemindersList();
                    if (shoppingList.length > 0) updateShoppingListUI();
                }
            } catch (e) {
                console.error('Failed to load user data:', e);
            }
        }

        function saveRemindersToStorage() {
            saveUserData(); // Use unified save function
        }

        function loadRemindersFromStorage() {
            // No longer needed - handled by loadUserData
        }

        // ========== TEXT-TO-SPEECH ==========
        function speak(text) {
            const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
            currentSpeechText = cleanText;
            
            if (typeof responsiveVoice !== 'undefined') {
                responsiveVoice.cancel();
                isSpeaking = true;
                responsiveVoice.speak(cleanText, "UK English Female", { 
                    pitch: 1.1, 
                    rate: 1.0, 
                    volume: 1,
                    onstart: () => {
                        isSpeaking = true;
                    },
                    onend: () => {
                        isSpeaking = false;
                    }
                });
                return;
            }
            
            synth.cancel();
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(cleanText);
                const voices = synth.getVoices();
                const goodVoice = voices.find(v => 
                    (v.name.includes('Google') && v.lang.includes('en')) ||
                    v.name.includes('Samantha') ||
                    v.name.includes('Karen') ||
                    v.lang.includes('en-GB')
                ) || voices[0];
                
                if (goodVoice) utterance.voice = goodVoice;
                utterance.rate = 1.0;
                utterance.pitch = 1.2;
                utterance.volume = 1.0;
                
                utterance.onstart = () => {
                    isSpeaking = true;
                };
                
                utterance.onend = () => {
                    isSpeaking = false;
                };
                
                isSpeaking = true;
                synth.speak(utterance);
            }, 100);
        }
        
        function stopSpeech() {
            if (typeof responsiveVoice !== 'undefined') {
                responsiveVoice.cancel();
            } else {
                synth.cancel();
            }
            isSpeaking = false;
        }
        
        function replaySpeech() {
            if (currentSpeechText) {
                speak(currentSpeechText);
            }
        }
        
        // ========== HELP OVERLAY ==========
        function showHelpOverlay() {
            document.getElementById('help-overlay').classList.remove('hidden');
        }
        
        function hideHelpOverlay() {
            document.getElementById('help-overlay').classList.add('hidden');
        }
        
        // ========== GOOGLE MAPS DIRECTIONS ==========
        function getDirections(placeName, city) {
            // Try to get user's exact GPS location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Success - use exact coordinates
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const destination = encodeURIComponent(`${placeName}, ${city}`);
                        const mapsUrl = `https://www.google.com/maps/dir/${lat},${lon}/${destination}`;
                        window.open(mapsUrl, '_blank');
                    },
                    (error) => {
                        // GPS denied or failed - use city as origin
                        console.log('GPS not available, using city as origin');
                        const origin = encodeURIComponent(city);
                        const destination = encodeURIComponent(`${placeName}, ${city}`);
                        const mapsUrl = `https://www.google.com/maps/dir/${origin}/${destination}`;
                        window.open(mapsUrl, '_blank');
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 5000,
                        maximumAge: 300000 // Cache for 5 minutes
                    }
                );
            } else {
                // Geolocation not supported - use city
                const origin = encodeURIComponent(city);
                const destination = encodeURIComponent(`${placeName}, ${city}`);
                const mapsUrl = `https://www.google.com/maps/dir/${origin}/${destination}`;
                window.open(mapsUrl, '_blank');
            }
        }
        
// ========== UX IMPROVEMENTS ==========

// 1. TYPING INDICATOR
function showTypingIndicator() {
    const chatContainer = document.getElementById('chat-container');
    
    // Remove existing typing indicator if any
    hideTypingIndicator();
    
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'flex justify-start items-start gap-2 fade-in';
    typingDiv.innerHTML = `
        <div class="bg-gray-200 rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
            </div>
        </div>
    `;
    chatContainer.appendChild(typingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// 2. DELETE MESSAGE FUNCTION
function deleteMessage(button) {
    if (confirm('Delete this message?')) {
        const messageDiv = button.closest('.flex');
        messageDiv.style.transition = 'all 0.2s';
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'scale(0.8)';
        setTimeout(() => messageDiv.remove(), 200);
    }
}

// 3. CONVERSATION HISTORY & SEARCH (USER-SPECIFIC)
let conversationHistory = [];

function getHistoryStorageKey() {
    const safeUserName = (userName || 'default_user').replace(/[^a-zA-Z0-9]/g, '_');
    return `unify_history_${safeUserName}`;
}

function saveToHistory(userMessage, aiResponse) {
    conversationHistory.push({
        timestamp: new Date().toISOString(),
        user: userMessage,
        ai: aiResponse,
        date: new Date().toLocaleDateString()
    });
    
    // Save to localStorage with user-specific key
    const historyKey = getHistoryStorageKey();
    localStorage.setItem(historyKey, JSON.stringify(conversationHistory));
    console.log(`üíæ Saved history for user: ${userName}`);
}

function loadHistory() {
    const historyKey = getHistoryStorageKey();
    const saved = localStorage.getItem(historyKey);
    console.log(`üìÇ Loading history for user: ${userName} (key: ${historyKey})`);
    if (saved) {
        conversationHistory = JSON.parse(saved);
    }
}

function searchHistory(query) {
    const results = conversationHistory.filter(conv => 
        conv.user.toLowerCase().includes(query.toLowerCase()) ||
        conv.ai.toLowerCase().includes(query.toLowerCase())
    );
    return results;
}

function showHistoryPanel() {
    // Create history panel HTML
    const panel = document.createElement('div');
    panel.id = 'history-panel';
    panel.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    panel.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">Conversation History</h2>
                <button onclick="closeHistoryPanel()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            <div class="p-4 border-b border-gray-200">
                <input 
                    type="text" 
                    id="history-search" 
                    placeholder="Search conversations..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    oninput="filterHistory(this.value)"
                />
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-4">
                ${renderHistoryList()}
            </div>
            <div class="p-4 border-t border-gray-200 flex gap-2">
                <button onclick="exportHistory()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">Export</button>
                <button onclick="clearHistory()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Clear All</button>
            </div>
        </div>
    `;
    document.body.appendChild(panel);
}

function renderHistoryList(filtered = conversationHistory) {
    if (filtered.length === 0) {
        return '<p class="text-gray-500 text-center">No conversations yet</p>';
    }
    
    return filtered.map((conv, index) => `
        <div class="bg-gray-50 rounded-lg p-3 space-y-2">
            <div class="text-xs text-gray-500">${conv.date} ${new Date(conv.timestamp).toLocaleTimeString()}</div>
            <div class="text-sm">
                <div class="font-semibold text-purple-600">You:</div>
                <div class="text-gray-700">${escapeHtml(conv.user)}</div>
            </div>
            <div class="text-sm">
                <div class="font-semibold text-blue-600">Unify:</div>
                <div class="text-gray-700">${escapeHtml(conv.ai.substring(0, 150))}${conv.ai.length > 150 ? '...' : ''}</div>
            </div>
        </div>
    `).join('');
}

function filterHistory(query) {
    const results = query ? searchHistory(query) : conversationHistory;
    document.getElementById('history-list').innerHTML = renderHistoryList(results);
}

function closeHistoryPanel() {
    const panel = document.getElementById('history-panel');
    if (panel) panel.remove();
}

function exportHistory() {
    const dataStr = JSON.stringify(conversationHistory, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `unify-history-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

function clearHistory() {
    if (confirm('Clear all conversation history? This cannot be undone.')) {
        conversationHistory = [];
        localStorage.removeItem('unify_history');
        closeHistoryPanel();
        alert('History cleared!');
    }
}

// 4. ERROR VISUAL FEEDBACK
function showError(message) {
    const chatContainer = document.getElementById('chat-container');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'flex justify-center items-center fade-in';
    errorDiv.innerHTML = `
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-sm flex items-center gap-2 animate-shake">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span class="text-sm">${escapeHtml(message)}</span>
        </div>
    `;
    chatContainer.appendChild(errorDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Remove after 5 seconds
    setTimeout(() => {
        errorDiv.style.opacity = '0';
        setTimeout(() => errorDiv.remove(), 300);
    }, 5000);
}

// Add shake animation to CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .animate-shake {
        animation: shake 0.5s;
    }
`;
document.head.appendChild(style);

// Load history on page load
loadHistory();

// ========== USAGE INSTRUCTIONS ==========

/*
1. TYPING INDICATOR:
   - Call showTypingIndicator() before AI response
   - Call hideTypingIndicator() before showing response

2. DELETE MESSAGES:
   - Already integrated in addChatMessage() with delete button
   - Shows on hover over user messages

3. CONVERSATION HISTORY:
   - Call saveToHistory(userMsg, aiMsg) after each exchange
   - Add button to show history panel: <button onclick="showHistoryPanel()">History</button>
   - Search, export, and clear functions included

4. ERROR FEEDBACK:
   - Call showError("Error message") instead of addChatMessage for errors
   - Visual shake animation + auto-dismiss
*/
</script>
</body>
</html>
