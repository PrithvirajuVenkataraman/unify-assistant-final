<!DOCTYPE html>
<html lang="en">
<!--
    JARVIS Voice Assistant
    ======================
    Deployment Structure (Vercel):
    /
    ‚îú‚îÄ‚îÄ index.full_with_map_preview.html (this file)
    ‚îú‚îÄ‚îÄ api/
    ‚îÇ   ‚îú‚îÄ‚îÄ chat-groq.js
    ‚îÇ   ‚îî‚îÄ‚îÄ search.js
    ‚îî‚îÄ‚îÄ vercel.json (create this - see below)

    vercel.json contents:
    {
      "functions": { "api/**/*.js": { "runtime": "edge" } },
      "rewrites": [{ "source": "/", "destination": "/index.full_with_map_preview.html" }]
    }

    Environment Variable Required:
    - GROQ_API_KEY (get from https://console.groq.com)
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>JARVIS - Just A Rather Very Intelligent System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=jQZ2zpcE"></script>
    <style>
        @keyframes waveform {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.5); }
        }
        .wave-bar {
            animation: waveform 0.8s ease-in-out infinite;
        }
        body.dark {
            background: linear-gradient(135deg, #000000 0%, #0a1929 50%, #001f3f 100%) !important;
        }
        body.light {
            background: linear-gradient(to bottom right, #0a1929, #1e3a5f, #0d47a1) !important;
        }
        
        /* ========== JARVIS INTRO ANIMATION ========== */
        #jarvis-intro {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #0a1929 0%, #001529 50%, #000000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        #jarvis-intro.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Advanced Arc Reactor Animation - Red/Blue Mix */
        .arc-reactor {
            position: relative;
            width: 300px;
            height: 300px;
            margin-bottom: 40px;
        }
        
        /* Central core with red-blue gradient glow */
        .arc-core {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, 
                #ffffff 0%, 
                #00ffff 20%,
                #0088cc 40%, 
                #ff0066 60%,
                #004466 100%);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 
                -20px 0 30px rgba(255, 0, 100, 0.6),
                20px 0 30px rgba(0, 217, 255, 0.6),
                0 0 50px rgba(0, 217, 255, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.5);
            animation: biColorPulse 4s ease-in-out infinite;
        }
        
        /* Red glow overlay on left */
        .arc-core::before {
            content: '';
            position: absolute;
            width: 40px;
            height: 80px;
            left: 0;
            top: 0;
            background: radial-gradient(circle at left, rgba(255, 0, 100, 0.8) 0%, transparent 70%);
            border-radius: 50% 0 0 50%;
            animation: redGlow 4s ease-in-out infinite;
        }
        
        /* Blue glow overlay on right */
        .arc-core::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 80px;
            right: 0;
            top: 0;
            background: radial-gradient(circle at right, rgba(0, 217, 255, 0.8) 0%, transparent 70%);
            border-radius: 0 50% 50% 0;
            animation: blueGlow 4s ease-in-out infinite;
        }
        
        /* Inner ring - fastest */
        .arc-ring {
            position: absolute;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .arc-ring:nth-child(2) {
            width: 120px;
            height: 120px;
            border: 2px solid rgba(0, 217, 255, 0.6);
            box-shadow: 
                -5px 0 15px rgba(255, 0, 100, 0.4),
                5px 0 15px rgba(0, 217, 255, 0.4),
                inset 0 0 15px rgba(0, 217, 255, 0.2);
            animation: rotate 4s linear infinite, ringColorShift 4s ease-in-out infinite;
        }
        
        /* Tech circle patterns */
        .arc-ring:nth-child(2)::before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #00ffff;
            border-radius: 50%;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px #00ffff;
            animation: dotColorShift 4s ease-in-out infinite;
        }
        
        /* Middle ring with segments */
        .arc-ring:nth-child(3) {
            width: 180px;
            height: 180px;
            border: 2px dashed rgba(0, 217, 255, 0.4);
            border-radius: 50%;
            animation: rotate 6s linear infinite reverse, ringColorShift 4s ease-in-out infinite 0.5s;
            box-shadow: 
                -8px 0 10px rgba(255, 0, 100, 0.3),
                8px 0 10px rgba(0, 217, 255, 0.3);
        }
        
        /* Outer ring - slowest with tech pattern */
        .arc-ring:nth-child(4) {
            width: 240px;
            height: 240px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            animation: rotate 8s linear infinite, ringColorShift 4s ease-in-out infinite 1s;
            box-shadow: 
                -10px 0 20px rgba(255, 0, 100, 0.2),
                10px 0 20px rgba(0, 217, 255, 0.2);
        }
        
        .arc-ring:nth-child(4)::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px dotted rgba(0, 217, 255, 0.2);
            animation: rotate 10s linear infinite reverse;
        }
        
        /* Outer tech ring with segments */
        .arc-ring:nth-child(5) {
            width: 280px;
            height: 280px;
            border: 1px solid rgba(0, 136, 204, 0.2);
            background: repeating-conic-gradient(
                from 0deg,
                transparent 0deg 5deg,
                rgba(0, 217, 255, 0.1) 5deg 6deg
            );
            animation: rotate 12s linear infinite, outerRingGlow 4s ease-in-out infinite;
        }
        
        /* Scanning lines with color shift */
        
        /* Red-Blue Alternating Glow Animation - SEQUENTIAL */
        @keyframes biColorPulse {
            /* Start - neutral */
            0% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 
                    -15px 0 20px rgba(255, 0, 100, 0.3),
                    15px 0 20px rgba(0, 217, 255, 0.3),
                    0 0 30px rgba(100, 150, 200, 0.2),
                    inset 0 0 20px rgba(255, 255, 255, 0.3);
            }
            /* Red builds up */
            15% { 
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 
                    -35px 0 60px rgba(255, 0, 100, 1),
                    5px 0 10px rgba(0, 217, 255, 0.1),
                    -20px 0 70px rgba(255, 0, 100, 0.8),
                    inset 0 0 40px rgba(255, 50, 100, 0.7);
            }
            /* Red peak - HOLD */
            25% { 
                transform: translate(-50%, -50%) scale(1.08);
                box-shadow: 
                    -40px 0 70px rgba(255, 0, 100, 1),
                    5px 0 10px rgba(0, 217, 255, 0.1),
                    -25px 0 80px rgba(255, 0, 100, 0.9),
                    inset 0 0 45px rgba(255, 50, 100, 0.8);
            }
            /* Red fades */
            35% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 
                    -15px 0 20px rgba(255, 0, 100, 0.3),
                    15px 0 20px rgba(0, 217, 255, 0.3),
                    0 0 30px rgba(100, 150, 200, 0.2),
                    inset 0 0 20px rgba(255, 255, 255, 0.3);
            }
            /* Blue builds up */
            50% { 
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 
                    -5px 0 10px rgba(255, 0, 100, 0.1),
                    35px 0 60px rgba(0, 217, 255, 1),
                    20px 0 70px rgba(0, 217, 255, 0.8),
                    inset 0 0 40px rgba(50, 200, 255, 0.7);
            }
            /* Blue peak - HOLD */
            60% { 
                transform: translate(-50%, -50%) scale(1.08);
                box-shadow: 
                    -5px 0 10px rgba(255, 0, 100, 0.1),
                    40px 0 70px rgba(0, 217, 255, 1),
                    25px 0 80px rgba(0, 217, 255, 0.9),
                    inset 0 0 45px rgba(50, 200, 255, 0.8);
            }
            /* Blue fades */
            70% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 
                    -15px 0 20px rgba(255, 0, 100, 0.3),
                    15px 0 20px rgba(0, 217, 255, 0.3),
                    0 0 30px rgba(100, 150, 200, 0.2),
                    inset 0 0 20px rgba(255, 255, 255, 0.3);
            }
            /* Full glow builds */
            85% { 
                transform: translate(-50%, -50%) scale(1.12);
                box-shadow: 
                    0 0 100px rgba(255, 0, 100, 0.6),
                    0 0 100px rgba(0, 217, 255, 0.6),
                    0 0 120px rgba(255, 255, 255, 0.8),
                    inset 0 0 60px rgba(255, 255, 255, 0.9);
            }
            /* Full glow peak - HOLD */
            95% { 
                transform: translate(-50%, -50%) scale(1.15);
                box-shadow: 
                    0 0 120px rgba(255, 0, 100, 0.7),
                    0 0 120px rgba(0, 217, 255, 0.7),
                    0 0 150px rgba(255, 255, 255, 1),
                    inset 0 0 70px rgba(255, 255, 255, 1);
            }
            /* Return to start */
            100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 
                    -15px 0 20px rgba(255, 0, 100, 0.3),
                    15px 0 20px rgba(0, 217, 255, 0.3),
                    0 0 30px rgba(100, 150, 200, 0.2),
                    inset 0 0 20px rgba(255, 255, 255, 0.3);
            }
        }
        
        /* Red glow intensity - SEQUENTIAL */
        @keyframes redGlow {
            0% { opacity: 0.3; }
            15% { opacity: 0.8; }
            25% { opacity: 1; }      /* RED PEAK - hold */
            35% { opacity: 0.3; }
            50%, 100% { opacity: 0.2; }
        }
        
        /* Blue glow intensity - SEQUENTIAL */
        @keyframes blueGlow {
            0%, 35% { opacity: 0.2; }
            50% { opacity: 0.8; }
            60% { opacity: 1; }      /* BLUE PEAK - hold */
            70% { opacity: 0.3; }
            85%, 100% { opacity: 0.2; }
        }
        
        /* Ring color shift */
        @keyframes ringColorShift {
            0%, 100% { 
                border-color: rgba(0, 217, 255, 0.6);
            }
            25% { 
                border-color: rgba(255, 0, 100, 0.6);
            }
            50% { 
                border-color: rgba(255, 255, 255, 0.8);
            }
            75% { 
                border-color: rgba(0, 217, 255, 0.6);
            }
        }
        
        /* Dot indicator color shift */
        @keyframes dotColorShift {
            0%, 100% { 
                background: #00ffff;
                box-shadow: 0 0 10px #00ffff;
            }
            25% { 
                background: #ff0066;
                box-shadow: 0 0 10px #ff0066;
            }
            50% { 
                background: #ffffff;
                box-shadow: 0 0 15px #ffffff;
            }
            75% { 
                background: #00ffff;
                box-shadow: 0 0 10px #00ffff;
            }
        }
        
        /* Scan line color shift */
        
        /* Outer ring glow */
        @keyframes outerRingGlow {
            0%, 100% { 
                box-shadow: 
                    -15px 0 25px rgba(255, 0, 100, 0.2),
                    15px 0 25px rgba(0, 217, 255, 0.2);
            }
            25% { 
                box-shadow: 
                    -25px 0 40px rgba(255, 0, 100, 0.4),
                    5px 0 15px rgba(0, 217, 255, 0.1);
            }
            50% { 
                box-shadow: 
                    0 0 50px rgba(255, 255, 255, 0.3);
            }
            75% { 
                box-shadow: 
                    -5px 0 15px rgba(255, 0, 100, 0.1),
                    25px 0 40px rgba(0, 217, 255, 0.4);
            }
        }
        
        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .jarvis-text {
            font-size: 3rem;
            font-weight: 900;
            color: #00ffff;
            text-shadow: 
                0 0 10px #00ffff,
                0 0 20px #00d9ff,
                0 0 30px #0088cc,
                0 0 40px #0088cc;
            letter-spacing: 12px;
            margin-bottom: 20px;
            animation: fadeIn 1s ease-in;
            font-family: 'Arial Black', sans-serif;
        }
        
        .jarvis-subtitle {
            font-size: 0.9rem;
            color: #80d4ff;
            text-shadow: 0 0 10px #0088cc;
            letter-spacing: 3px;
            opacity: 0;
            animation: fadeIn 1s ease-in 1s forwards;
            font-family: 'Courier New', monospace;
        }
        
        .init-status {
            color: #00d9ff;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin-top: 30px;
            opacity: 0;
            animation: fadeIn 0.5s ease-in 2s forwards, blink 1s ease-in-out infinite 2.5s;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Header Logo Smooth Glow */
        .logo-glow {
            animation: logoGlowPulse 3s ease-in-out infinite;
        }
        
        @keyframes logoGlowPulse {
            0%, 100% {
                box-shadow: 
                    0 0 20px rgba(0, 217, 255, 0.4),
                    0 0 40px rgba(0, 217, 255, 0.2),
                    inset 0 0 20px rgba(0, 217, 255, 0.1);
            }
            50% {
                box-shadow: 
                    0 0 30px rgba(0, 217, 255, 0.8),
                    0 0 60px rgba(0, 217, 255, 0.5),
                    0 0 80px rgba(0, 217, 255, 0.3),
                    inset 0 0 30px rgba(0, 217, 255, 0.2);
            }
        }
        
        .logo-glow::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 217, 255, 0.3) 0%, transparent 70%);
            animation: logoGlowRing 3s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes logoGlowRing {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }
        
        /* Weather Effects - Contained in Weather Card Only */
        #weather-card {
            position: relative;
            overflow: hidden;
        }
        
        .weather-effect-local {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
            border-radius: 1rem;
        }
        
        #weather-card > * {
            position: relative;
            z-index: 2;
        }
        
        /* Light Switch Styles - Smaller */
        .light-switch-container {
            position: relative;
            width: 60px;          /* Was 80px */
            height: 105px;        /* Was 140px */
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
            border-radius: 6px;   /* Was 8px */
            box-shadow: 0 3px 8px rgba(0,0,0,0.1),
                        inset 0 1px 0 rgba(255,255,255,0.8);
            padding: 11px;        /* Was 15px */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .light-switch {
            width: 30px;          /* Was 40px */
            height: 52px;         /* Was 70px */
            background: #fff;
            border-radius: 3px;   /* Was 4px */
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .switch-toggle {
            width: 27px;          /* Was 36px */
            height: 24px;         /* Was 32px */
            background: linear-gradient(145deg, #f0f0f0, #d9d9d9);
            border-radius: 2px;   /* Was 3px */
            position: absolute;
            left: 1.5px;          /* Was 2px */
            top: 1.5px;           /* Was 2px */
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 3px rgba(0,0,0,0.3),
                        inset 0 1px 0 rgba(255,255,255,0.8);
        }
        
        .switch-toggle::before {
            content: '';
            position: absolute;
            width: 15px;          /* Was 20px */
            height: 2px;          /* Was 3px */
            background: #999;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 1px;   /* Was 2px */
        }
        
        .light-switch.on .switch-toggle {
            top: 27px;          /* Was 36px - adjusted for smaller size */
            background: linear-gradient(145deg, #d9d9d9, #c9c9c9);
        }
        
        /* Tube Light */
        .tube-light-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30; /* Lower than chat content (z-40) so it doesn't overlap */
            pointer-events: none;
        }
        
        .tube-light {
            width: 200px;
            height: 30px;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.1),
                rgba(200, 200, 200, 0.2),
                rgba(255, 255, 255, 0.1));
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .tube-light::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%);
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .tube-light.on {
            background: linear-gradient(to bottom,
                rgba(255, 255, 255, 0.95),
                rgba(240, 248, 255, 1),
                rgba(255, 255, 255, 0.95));
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                        0 0 40px rgba(200, 220, 255, 0.6),
                        inset 0 2px 5px rgba(255,255,255,0.5);
        }
        
        .tube-light.on::before {
            opacity: 1;
            animation: tube-flicker 0.1s ease-in-out 2;
        }
        
        .tube-light-glow {
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: radial-gradient(ellipse at center,
                rgba(255, 255, 255, 0.4) 0%,
                transparent 70%);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        
        .tube-light.on + .tube-light-glow {
            opacity: 1;
        }
        
        @keyframes tube-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes tube-startup {
            0% { opacity: 0; }
            10% { opacity: 0.3; }
            20% { opacity: 0; }
            30% { opacity: 0.6; }
            40% { opacity: 0.2; }
            50% { opacity: 0.8; }
            60% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .tube-light.starting {
            animation: tube-startup 0.8s ease-in-out;
        }
        
        /* Alarm notification styles */
        .alarm-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-5deg); }
            75% { transform: translate(-50%, -50%) rotate(5deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        /* Weather Background Effects */
        .weather-effect {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Snowflakes */
        @keyframes snowfall {
            0% {
                transform: translateY(-10px) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) translateX(50px);
                opacity: 0.3;
            }
        }
        
        .snowflake {
            position: absolute;
            top: -10px;
            color: white;
            font-size: 1em;
            animation: snowfall linear infinite;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
        }
        
        /* Rain */
        @keyframes rainfall {
            0% {
                transform: translateY(-10px);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh);
                opacity: 0.3;
            }
        }
        
        .raindrop {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(174, 194, 224, 0.8), rgba(174, 194, 224, 0.3));
            animation: rainfall linear infinite;
        }
        
        /* Sun */
        @keyframes sunPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        .sun {
            position: absolute;
            top: 80px;
            right: 100px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 70%, transparent 70%);
            border-radius: 50%;
            animation: sunPulse 4s ease-in-out infinite;
            box-shadow: 0 0 60px #FFD700, 0 0 100px #FFA500;
        }
        
        .sun::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: sunPulse 4s ease-in-out infinite;
        }
        
        /* Clouds */
        @keyframes cloudFloat {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(calc(100vw + 100px)); }
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 100px;
            animation: cloudFloat linear infinite;
        }
        
        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 100px;
        }
        
        .cloud-1 {
            width: 100px;
            height: 40px;
            top: 100px;
            animation-duration: 40s;
        }
        
        .cloud-1::before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }
        
        .cloud-1::after {
            width: 60px;
            height: 40px;
            top: -15px;
            right: 10px;
        }
        
        .cloud-2 {
            width: 120px;
            height: 50px;
            top: 150px;
            animation-duration: 50s;
            animation-delay: -10s;
        }
        
        .cloud-2::before {
            width: 60px;
            height: 60px;
            top: -30px;
            left: 15px;
        }
        
        .cloud-2::after {
            width: 70px;
            height: 50px;
            top: -20px;
            right: 15px;
        }
        
        .cloud-3 {
            width: 90px;
            height: 35px;
            top: 200px;
            animation-duration: 45s;
            animation-delay: -25s;
        }
        
        .cloud-3::before {
            width: 45px;
            height: 45px;
            top: -20px;
            left: 10px;
        }
        
        .cloud-3::after {
            width: 50px;
            height: 35px;
            top: -12px;
            right: 10px;
        }
        
        /* Thunder effect */
        @keyframes lightning {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .lightning {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            animation: lightning 0.2s ease-in-out;
        }
        
        /* Hot day shimmer */
        @keyframes heatShimmer {
            0%, 100% { transform: translateY(0) scaleY(1); }
            50% { transform: translateY(-5px) scaleY(1.1); }
        }
        
        .heat-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(to top, rgba(255, 200, 100, 0.3), transparent);
            animation: heatShimmer 3s ease-in-out infinite;
        }
        
        /* Shopping List Receipt */
        .shopping-receipt {
            position: fixed;
            right: 20px;
            top: 120px;
            width: 280px;
            max-height: calc(100vh - 200px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 20px;
            font-family: 'Courier New', monospace;
            z-index: 50;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        /* Center on mobile */
        @media (max-width: 640px) {
            .shopping-receipt {
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                width: calc(100% - 40px);
                max-width: 320px;
            }
        }
        
        .shopping-receipt.dark-mode {
            background: #1F2937;
            color: #F3F4F6;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #333;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        .receipt-store {
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: #4F46E5;
        }
        
        .receipt-divider {
            font-size: 12px;
            color: #999;
            letter-spacing: 1px;
            margin: 10px 0;
        }
        
        .receipt-thank-you {
            text-align: center;
            font-size: 11px;
            font-style: italic;
            color: #666;
            margin: 10px 0;
        }
        
        .receipt-count-number {
            font-size: 18px;
            font-weight: bold;
            color: #4F46E5;
        }
        
        .shopping-receipt.dark-mode .receipt-header {
            border-bottom-color: #4B5563;
        }
        
        .receipt-title {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .receipt-subtitle {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .shopping-receipt.dark-mode .receipt-subtitle {
            color: #9CA3AF;
        }
        
        .receipt-items {
            margin: 15px 0;
        }
        
        .receipt-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #ddd;
            font-size: 14px;
        }
        
        .shopping-receipt.dark-mode .receipt-item {
            border-bottom-color: #374151;
        }
        
        .receipt-item:last-child {
            border-bottom: none;
        }
        
        .receipt-item-text {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .receipt-bullet {
            color: #8B5CF6;
            font-weight: bold;
        }
        
        .receipt-delete {
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .receipt-delete:hover {
            background: #DC2626;
            transform: scale(1.05);
        }
        
        .receipt-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #333;
            text-align: center;
            font-size: 12px;
        }
        
        .shopping-receipt.dark-mode .receipt-footer {
            border-top-color: #4B5563;
        }
        
        .receipt-total {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .receipt-clear-btn {
            background: #8B5CF6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .receipt-clear-btn:hover {
            background: #7C3AED;
            transform: translateY(-2px);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .shopping-receipt {
                right: 10px;
                top: 100px;
                width: calc(100vw - 20px);
                max-width: 320px;
                max-height: 50vh;
            }
            
            .tube-light-container {
                top: 10px;
            }
            
            .tube-light {
                width: 150px;
                height: 25px;
            }
            
            .light-switch-container {
                width: 60px;
                height: 110px;
                padding: 10px;
            }
            
            .light-switch {
                width: 35px;
                height: 60px;
            }
            
            .switch-toggle {
                width: 31px;
                height: 27px;
            }
            
            .light-switch.on .switch-toggle {
                top: 23px;          /* Was 31px - adjusted for smaller size */
            }
        }
        
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            
            #main-card {
                padding: 16px;
            }
            
            #chat-container {
                max-height: 250px;
            }
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* Simple Loading Spinner (no overlay) */
        .simple-loading {
            position: fixed;
            top: 50%;
            right: 24px;
            transform: translateY(-50%);
            z-index: 9999;
        }
        
        .simple-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #E5E7EB;
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-card {
            background: white;
            padding: 2rem 3rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #E5E7EB;
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loading-text {
            color: #374151;
            font-size: 1.125rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="light min-h-screen transition-all duration-500">
    <!-- JARVIS Intro Animation -->
    <div id="jarvis-intro">
        <div class="arc-reactor">
            <div class="arc-ring"></div>
            <div class="arc-ring"></div>
            <div class="arc-ring"></div>
            <div class="arc-ring"></div>
            <div class="arc-ring"></div>
            <div class="arc-core"></div>
        </div>
        <div class="jarvis-text">J.A.R.V.I.S</div>
        <div class="jarvis-subtitle">Just A Rather Very Intelligent System</div>
        <div class="init-status">‚ó¢ Initializing systems...</div>
    </div>
    
    <!-- Weather Effects Container -->
    <div id="weather-effects" class="weather-effect"></div>
    
    <!-- Shopping List Receipt -->
    <div id="shopping-receipt" class="shopping-receipt hidden">
        <!-- Close button - absolute positioned -->
        <button onclick="closeShoppingList()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-3xl leading-none z-10" title="Close" style="background: none; border: none; cursor: pointer;">√ó</button>
        
        <div class="receipt-header">
            <div class="receipt-store">üõí JARVIS MARKET</div>
            <div class="receipt-title">SHOPPING LIST</div>
            <div class="receipt-subtitle" id="receipt-date">---</div>
            <div class="receipt-divider">- - - - - - - - - - - - - - - -</div>
        </div>
        <div id="receipt-items" class="receipt-items">
            <div style="text-align: center; color: #999; font-size: 12px; padding: 20px;">
                No items yet
            </div>
        </div>
        <div class="receipt-footer">
            <div class="receipt-divider">- - - - - - - - - - - - - - - -</div>
            <div class="receipt-total">
                <span>TOTAL ITEMS:</span>
                <span id="receipt-count" class="receipt-count-number">0</span>
            </div>
            <div class="receipt-thank-you">Thank you for shopping!</div>
            <button onclick="clearShoppingList()" class="receipt-clear-btn">üóëÔ∏è Clear All</button>
        </div>
    </div>
    
    <!-- Tube Light -->
    <div class="tube-light-container">
        <div id="tube-light" class="tube-light"></div>
        <div class="tube-light-glow"></div>
    </div>

    <!-- Alarm Notification Overlay -->
    <div id="alarm-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50"></div>
    <div id="alarm-notification" class="hidden"></div>

    <div class="min-h-screen pb-32">
        <div id="bg-effects" class="fixed inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-20 left-20 w-72 h-72 bg-slate-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
            <div class="absolute bottom-20 right-20 w-72 h-72 bg-indigo-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-delay: 1s;"></div>
            <div class="absolute top-1/2 left-1/2 w-72 h-72 bg-violet-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-delay: 2s;"></div>
        </div>

        <div class="max-w-4xl mx-auto relative z-10 p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <div class="logo-glow p-3 rounded-full bg-gradient-to-r from-cyan-500 to-blue-600 shadow-lg shadow-cyan-500/50 relative">
                        <!-- Arc Reactor Icon -->
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" class="text-white">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                            <circle cx="12" cy="12" r="6" stroke="currentColor" stroke-width="1.5"/>
                            <circle cx="12" cy="12" r="3" fill="currentColor"/>
                            <line x1="12" y1="2" x2="12" y2="6" stroke="currentColor" stroke-width="1.5"/>
                            <line x1="12" y1="18" x2="12" y2="22" stroke="currentColor" stroke-width="1.5"/>
                            <line x1="2" y1="12" x2="6" y2="12" stroke="currentColor" stroke-width="1.5"/>
                            <line x1="18" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <div class="absolute inset-0 rounded-full bg-cyan-400 opacity-20 animate-pulse"></div>
                    </div>
                    <div>
                        <h1 id="title" class="text-4xl font-black text-gray-900">JARVIS</h1>
                        <p id="subtitle" class="text-sm text-gray-600">Your AI Voice Assistant</p>
                    </div>
                </div>
                
                <!-- Light Switch -->
                <div class="light-switch-container" onclick="toggleDarkMode()">
                    <div id="light-switch" class="light-switch on">
                        <div class="switch-toggle"></div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="main-card" class="bg-white bg-opacity-80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white border-opacity-50 mb-6">
                
                <!-- Chat History -->
                <div id="chat-container" class="bg-gray-50 rounded-2xl p-4 max-h-96 overflow-y-auto space-y-3 mb-6">
                    <!-- Welcome message -->
                </div>

                <!-- Weather Card -->
                <div id="weather-card" class="hidden bg-gradient-to-r from-blue-400 to-cyan-500 text-white p-6 rounded-2xl shadow-lg mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                            </svg>
                            <div>
                                <h2 class="text-xl font-bold text-white drop-shadow-lg">Weather</h2>
                                <p id="location-name" class="text-sm text-white drop-shadow-md">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <p id="temperature" class="text-5xl font-bold mb-2 text-white drop-shadow-lg">--¬∞F / --¬∞C</p>
                    <p id="weather-advice" class="text-white text-lg drop-shadow-md"></p>
                </div>

                <!-- Reminders List -->
                <div id="reminders-section" class="hidden bg-gray-50 p-6 rounded-2xl mb-6">
                    <div class="flex items-center gap-2 mb-4">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <h2 class="text-xl font-bold text-gray-800">Your Reminders</h2>
                    </div>
                    <div id="reminders-list" class="space-y-3"></div>
                </div>

                <!-- Suggestion Buttons - Dynamic based on context -->
                <div id="initial-suggestions" class="bg-purple-50 p-6 rounded-2xl">
                    <h3 class="font-bold text-gray-900 mb-3">Try asking me:</h3>
                    <div id="suggestion-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Processing...</div>
        </div>
    </div>

    <!-- ChatGPT-style Input at Bottom -->
    <div id="input-bar-container" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
        <div class="max-w-4xl mx-auto p-4">
            <div id="input-bar-inner" class="flex items-center gap-3 bg-gray-50 rounded-full border-2 border-gray-200 px-4 py-3 hover:border-purple-300 transition-all">
                <button onclick="showHelpModal()" id="help-btn" class="flex-shrink-0 relative group" title="Help & Tips">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600 hover:text-purple-600 transition-all">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <!-- Tooltip -->
                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        Help & Tips
                    </div>
                </button>
                
                <input 
                    type="text" 
                    id="text-input"
                    placeholder="Ask anything..."
                    class="flex-1 bg-transparent outline-none text-gray-900 placeholder-gray-500 dark-mode-text"
                    onkeypress="if(event.key === 'Enter') sendTextInput()"
                    oninput="toggleSendButton()"
                />
                
                <!-- Send Button (shows when typing) -->
                <button onclick="sendTextInput()" id="send-btn" class="hidden flex-shrink-0 p-2 rounded-full bg-indigo-600 hover:bg-indigo-700 transition-all">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
                
                <!-- Voice Button (shows when not typing) -->
                <button onclick="toggleListening()" id="voice-btn" class="flex-shrink-0 p-2 rounded-full bg-gray-900 hover:bg-gray-800 transition-all">
                    <svg id="mic-icon-bottom" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                    <div id="waveform-bottom" class="hidden flex items-center gap-1">
                        <div class="w-1 h-4 bg-white rounded-full wave-bar" style="animation-delay: 0s;"></div>
                        <div class="w-1 h-4 bg-white rounded-full wave-bar" style="animation-delay: 0.1s;"></div>
                        <div class="w-1 h-4 bg-white rounded-full wave-bar" style="animation-delay: 0.2s;"></div>
                    </div>
                </button>
            </div>
            <!-- Footer with disclaimer and request button - centered -->
            <div class="flex items-center justify-center mt-2 gap-2">
                <p id="footer-disclaimer" class="text-xs text-gray-500">JARVIS can make mistakes. Check important info.</p>
                <button 
                    onclick="openFeatureRequest()" 
                    class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded-full text-xs font-medium flex items-center gap-1 transition-all hover:scale-105"
                    title="Request a Feature">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    Request
                </button>
            </div>
        </div>
    </div>

<script>

const TRUST_LEVEL = {VERIFIED: 'verified', GENERATED: 'generated'};
function getTrustLabel(trustLevel) {
  return trustLevel === TRUST_LEVEL.VERIFIED
    ? '‚úÖ Verified by location data'
    : '‚Ñπ Generated (structure only)';
}

function isVerifiedPlace(obj) {
  return !!obj &&
    typeof obj.lat === 'number' &&
    typeof obj.lon === 'number' &&
    typeof obj.distanceKm === 'number' &&
    obj.distanceKm <= 10;
}

function containsPlaceList(text) {
  if (typeof text !== 'string') return false;
  return /üè®|üçΩÔ∏è|hotel|restaurant|stay|biryani|curry/i.test(text);
}

function getUserIntent(text) {
  return {
    wantsHotels: /hotel|stay|accommodation/i.test(text),
    wantsRestaurants: /restaurant|food|eat|biryani|curry|lunch|dinner/i.test(text),
    wantsItinerary: /itinerary|plan|schedule|day in/i.test(text)
  };
}

function violatesIntent(text) {
  const ctx = window.__intentContext;
  if (!ctx || typeof text !== 'string') return false;
  if (ctx.itineraryOnly && containsPlaceList(text)) return true;
  if (!ctx.allowHotels && /hotel|stay|accommodation/i.test(text)) return true;
  if (!ctx.allowRestaurants && /restaurant|food|eat|biryani|curry|lunch|dinner/i.test(text)) return true;
  return false; 
}

function getSourceAttribution(trustLevel) {
  return trustLevel === TRUST_LEVEL.VERIFIED
    ? 'üìç Source: OpenStreetMap / Brave Search'
    : 'üß† Source: Language model (no live location lookup)';
}

function retryWithStricterPrompt() {
  const msg = window.__lastUserMessage;
  if (!msg) return;

  const strict =
    'STRICT MODE:\n' +
    '- Do not list hotels or restaurants unless explicitly asked\n' +
    '- If itinerary only, give structure only\n' +
    '- Never invent place names\n\n' +
    msg;

  sendMessage(strict); }
  
window.__telemetry = {
  hallucinationAttempts: 0,
  regenerations: 0
};

function toggleDarkMode() {
    const body = document.body;
    if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        body.classList.add('light');
    } else {
        body.classList.remove('light');
        body.classList.add('dark');
    }
}

function showLoading(message = 'Processing...') {
    const overlay = document.getElementById('loading-overlay');
    const text = document.getElementById('loading-text');
    if (overlay && text) {
        text.textContent = message;
        overlay.classList.remove('hidden');
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

function showQuickReplies(suggestions) {
    
}

function hideQuickReplies() {
    
}

function handleQuickReply(text) {
    document.getElementById('text-input').value = text;
    sendTextInput();
}

function getRegionalFood(context) {
    const lower = context.toLowerCase();
    
    
    if (lower.includes('tamil nadu') || lower.includes('chidambaram') || lower.includes('chennai') ||
        lower.includes('bangalore') || lower.includes('bengaluru') || lower.includes('hyderabad') ||
        lower.includes('mysore') || lower.includes('coimbatore') || lower.includes('madurai') ||
        lower.includes('kochi') || lower.includes('kerala') || lower.includes('andhra') || lower.includes('karnataka')) {
        return [
            { icon: 'üçõ', text: 'Best Biryani spots' },
            { icon: '‚òï', text: 'Filter coffee places' },
            { icon: 'ü•ò', text: 'Dosa & Idli spots' }
        ];
    }
    
    if (lower.includes('delhi') || lower.includes('mumbai') || lower.includes('jaipur') ||
        lower.includes('agra') || lower.includes('kolkata') || lower.includes('punjab') ||
        lower.includes('rajasthan')) {
        return [
            { icon: 'üçõ', text: 'Butter chicken spots' },
            { icon: 'ü´ì', text: 'Naan & Tandoor' },
            { icon: 'ü•ò', text: 'Street chaat' }
        ];
    }
    
    if (lower.includes('india')) {
        return [
            { icon: 'üçõ', text: 'Biryani near me' },
            { icon: 'üç≤', text: 'Curry places' },
            { icon: '‚òï', text: 'Chai shops' }
        ];
    }
    
    if (lower.includes('italy') || lower.includes('rome') || lower.includes('milan') ||
        lower.includes('florence') || lower.includes('venice') || lower.includes('naples')) {
        return [
            { icon: 'üçù', text: 'Authentic Pasta' },
            { icon: 'üçï', text: 'Best Pizzerias' },
            { icon: 'üç¶', text: 'Gelato shops' }
        ];
    }
    
    if (lower.includes('new york') || lower.includes('nyc') || lower.includes('manhattan') ||
        lower.includes('brooklyn')) {
        return [
            { icon: 'üçï', text: 'Classic NYC Pizza' },
            { icon: 'ü•Ø', text: 'Best Bagels' },
            { icon: 'üå≠', text: 'Hot dog stands' }
        ];
    }
    
    if (lower.includes('mexico') || lower.includes('cancun') || lower.includes('cabo') ||
        lower.includes('guadalajara')) {
        return [
            { icon: 'üåÆ', text: 'Best Tacos' },
            { icon: 'ü´î', text: 'Street food' },
            { icon: 'üåØ', text: 'Burrito spots' }
        ];
    }
    
    if (lower.includes('japan') || lower.includes('tokyo') || lower.includes('kyoto') ||
        lower.includes('osaka')) {
        return [
            { icon: 'üç£', text: 'Sushi spots' },
            { icon: 'üçú', text: 'Ramen shops' },
            { icon: 'ü•ü', text: 'Izakaya' }
        ];
    }
    
    if (lower.includes('france') || lower.includes('paris') || lower.includes('lyon') ||
        lower.includes('nice')) {
        return [
            { icon: 'ü•ê', text: 'Best Croissants' },
            { icon: 'üßÄ', text: 'Cheese & Wine' },
            { icon: 'ü•ñ', text: 'Boulangeries' }
        ];
    }
    
    if (lower.includes('ohio') || lower.includes('texas') || lower.includes('california') || 
        lower.includes('mason') || lower.includes('chicago') || lower.includes('boston') ||
        lower.includes('seattle') || lower.includes('los angeles') || lower.includes('long beach')) {
        return [
            { icon: 'üçî', text: 'Best Burgers' },
            { icon: 'üçñ', text: 'BBQ spots' },
            { icon: '‚òï', text: 'Coffee shops' }
        ];
    }
    
    return [
        { icon: 'üçΩÔ∏è', text: 'Local restaurants' },
        { icon: '‚òï', text: 'Coffee shops' },
        { icon: 'üç∞', text: 'Dessert places' }
    ];
}

function showInitialSuggestions() {
    const suggestions = [
        { icon: '‚òÄÔ∏è', text: "What's the weather?", query: "What's the weather like today?" },
        { icon: 'üõí', text: 'Add 2 lbs chicken to list', query: 'Add 2 pounds of chicken to my shopping list' },
        { icon: '‚è∞', text: 'Remind me to call mom', query: 'Remind me to call mom at 5pm' },
        { icon: 'üîë', text: 'My keys are on counter', query: 'My car keys are on the counter' },
        { icon: '‚ùì', text: 'What can you do?', query: 'What can you do?' },
        { icon: '‚úàÔ∏è', text: 'Plan a trip to Paris', query: 'Plan a weekend trip to Paris' }
    ];
    
    updateSuggestionBox(suggestions);
}

function updateSuggestionBox(suggestions) {
    const grid = document.getElementById('suggestion-grid');
    if (!grid) return;
    
    grid.innerHTML = suggestions.map(s => `
        <button onclick="processSuggestion('${s.query.replace(/'/g, "\\'")} ')" 
                class="text-left bg-white hover:bg-purple-100 text-purple-800 p-3 rounded-xl text-sm font-medium shadow-sm border border-purple-200 transition-all">
            ${s.icon} ${s.text}
        </button>
    `).join('');
}

function updateContextualSuggestions(context) {
    const lower = context.toLowerCase();
    let suggestions = [];
    
    
    
    if (lower.includes('itinerary') || 
        lower.includes('day 1') || 
        lower.includes('day 2') ||
        lower.includes('enjoy exploring') || 
        lower.includes('things to do') ||
        (lower.includes('duration') && lower.includes('hours'))) {
        const city = extractCityFromText(context);
        suggestions = [
            { icon: 'üè®', text: `Hotels in ${city || 'this area'}`, query: `Hotels in ${city || 'the area'}` },
            { icon: 'üçΩÔ∏è', text: 'Best restaurants', query: `Best restaurants in ${city || 'the area'}` },
            { icon: 'üé´', text: 'Things to do at night', query: `Things to do at night in ${city || 'the area'}` },
            { icon: 'üì∏', text: 'Best photo spots', query: `Best photo spots in ${city || 'the area'}` },
            { icon: 'üöå', text: 'How to get around', query: `Transport in ${city || 'the area'}` },
            { icon: 'üõçÔ∏è', text: 'Shopping areas', query: `Shopping areas in ${city || 'the area'}` }
        ];
    }
    
    else if ((lower.includes('üè®') || lower.includes('hotel')) && lower.includes('food:')) {
        const city = extractCityFromText(context);
        suggestions = [
            { icon: 'üçΩÔ∏è', text: 'Restaurants nearby', query: `Best restaurants in ${city || 'the area'}` },
            { icon: 'üó∫Ô∏è', text: 'Things to do', query: `Things to do in ${city || 'the area'}` },
            { icon: 'üöå', text: 'Transport info', query: `How to get around ${city || 'the area'}` },
            { icon: '‚òï', text: 'Coffee shops', query: `Coffee shops in ${city || 'the area'}` },
            { icon: 'üõçÔ∏è', text: 'Shopping areas', query: `Shopping in ${city || 'the area'}` },
            { icon: 'üé´', text: 'Nightlife', query: `Things to do at night in ${city || 'the area'}` }
        ];
    }
    
    else if (lower.includes('restaurant') || lower.includes('food:')) {
        const city = extractCityFromText(context);
        suggestions = [
            { icon: 'üè®', text: 'Hotels nearby', query: `Hotels in ${city || 'the area'}` },
            { icon: 'üó∫Ô∏è', text: 'Create itinerary', query: `Plan a day in ${city || 'the area'}` },
            { icon: '‚òï', text: 'Coffee & desserts', query: `Best coffee and dessert places in ${city || 'the area'}` },
            { icon: 'üöå', text: 'Transport', query: `Transport in ${city || 'the area'}` },
            { icon: 'üçî', text: 'Fast food', query: 'Fast food near me' },
            { icon: 'üì∏', text: 'Photo spots', query: `Photo spots in ${city || 'the area'}` }
        ];
    }
    
    else {
        suggestions = [
            { icon: '‚òÄÔ∏è', text: "What's the weather?", query: "What's the weather?" },
            { icon: '‚úàÔ∏è', text: 'Plan a trip', query: 'Plan a trip to Paris' },
            { icon: 'üõí', text: 'Shopping list', query: 'Add milk to my list' },
            { icon: '‚è∞', text: 'Set reminder', query: 'Remind me to call mom' },
            { icon: 'üîë', text: 'Store location', query: 'My keys are on the counter' },
            { icon: '‚ùì', text: 'What can you do?', query: 'What can you do?' }
        ];
    }
    
    if (suggestions.length > 0) {
        updateSuggestionBox(suggestions);
    } else {
    }
}

function extractCityFromText(text) {
    
    const patterns = [
        /in ([A-Z][a-z]+(?: [A-Z][a-z]+)*)/,
        /to ([A-Z][a-z]+(?: [A-Z][a-z]+)*)/,
        /at ([A-Z][a-z]+(?: [A-Z][a-z]+)*)/
    ];
    
    for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match) return match[1];
    }
    
    return '';
}

// Helper function to detect if response is actually a hotel listing
function isHotelListing(text) {
    // Must have multiple indicators that this is a hotel recommendation
    const hotelIndicators = [
        /\d+\.\s*[A-Z].*?(Hotel|Inn|Resort|Suites|Lodge|Hostel)/i,  // Numbered list with hotel type
        /Price:/i,           // Price mention
        /Rating:/i,          // Rating mention
        /per night/i,        // Per night pricing
        /\$\d+/,             // Dollar amount
        /‚Çπ\d+/,              // Rupee amount
        /stars?:/i,          // Star rating
        /check-in/i,         // Check-in info
        /amenities/i,        // Amenities list
        /rooms? available/i, // Room availability
    ];

    // Count how many indicators match
    const matchCount = hotelIndicators.filter(pattern => pattern.test(text)).length;

    // Need at least 2 indicators to confirm it's a hotel listing
    return matchCount >= 2;
}

// Helper function to detect if response is actually a restaurant listing
function isRestaurantListing(text) {
    const restaurantIndicators = [
        /\d+\.\s*[A-Z].*?(Restaurant|Cafe|Bistro|Diner|Eatery|Kitchen)/i,  // Numbered list with restaurant type
        /Must Try:/i,        // Must try dishes
        /Cuisine:/i,         // Cuisine type
        /Speciality:/i,      // Speciality dishes
        /\$\$|\$\$\$/,       // Price range symbols
        /Rating:/i,          // Rating mention
        /Hours:/i,           // Opening hours
        /Signature dish/i,   // Signature dish
    ];

    const matchCount = restaurantIndicators.filter(pattern => pattern.test(text)).length;
    return matchCount >= 2;
}

function suggestQuickReplies(context) {
    const suggestions = [];
    let lastResponse = context;

    // Check for itinerary first (most specific)
    if (context.includes('itinerary') || context.includes('Day 1') || context.includes('Enjoy exploring')) {
        const regionalFood = getRegionalFood(context);
        suggestions.push(
            { icon: 'üè®', text: 'Hotels nearby' },
            { icon: 'üçΩÔ∏è', text: 'Restaurants nearby' },
            ...regionalFood.slice(0, 1),
            { icon: 'üé´', text: 'Things to do at night' },
            { icon: 'üì∏', text: 'Best photo spots' }
        );

        addShareButton(context, 'itinerary');
    }
    // Check for actual hotel listings (not just mentions of "hotel")
    else if (isHotelListing(context)) {
        const regionalFood = getRegionalFood(context);
        suggestions.push(
            { icon: 'üçΩÔ∏è', text: 'Restaurants nearby' },
            { icon: 'üó∫Ô∏è', text: 'Plan activities' },
            ...regionalFood.slice(0, 1),
            { icon: 'üõçÔ∏è', text: 'Shopping areas' },
            { icon: '‚òï', text: 'Coffee shops' }
        );

        addShareButton(context, 'hotels');
    }
    // Check for actual restaurant listings
    else if (isRestaurantListing(context)) {
        const regionalFood = getRegionalFood(context);
        suggestions.push(
            { icon: 'üè®', text: 'Hotels nearby' },
            { icon: 'üó∫Ô∏è', text: 'Things to do' },
            ...regionalFood.slice(0, 2),
            { icon: 'üç∞', text: 'Dessert places' }
        );

        addShareButton(context, 'restaurants');
    }
    // Weather responses
    else if (context.includes('weather') || context.includes('temperature') || context.includes('¬∞')) {
        suggestions.push(
            { icon: 'üè®', text: 'Hotels nearby' },
            { icon: 'üçΩÔ∏è', text: 'Best restaurants' },
            { icon: 'üó∫Ô∏è', text: 'Things to do' }
        );
    }
    // Default suggestions
    else {
        suggestions.push(
            { icon: 'üå§Ô∏è', text: 'Weather' },
            { icon: 'üó∫Ô∏è', text: 'Plan a trip' },
            { icon: 'üõí', text: 'Shopping list' }
        );
    }

    showQuickReplies(suggestions);


    updateContextualSuggestions(context);
}

function addShareButton(content, type) {
    const chatContainer = document.getElementById('chat-container');
    const shareBox = document.createElement('div');
    shareBox.className = 'flex justify-center gap-3 my-3 fade-in flex-wrap';

    const bgClass = darkMode ? 'bg-blue-900' : 'bg-blue-50';
    const textClass = darkMode ? 'text-blue-200' : 'text-blue-900';
    const emailBgClass = darkMode ? 'bg-purple-900' : 'bg-purple-50';
    const emailTextClass = darkMode ? 'text-purple-200' : 'text-purple-900';


    const cleanContent = content.replace(/<[^>]*>/g, '').replace(/\[üìç.*?\]/g, '');

    // Store content globally for email modal
    window.pendingEmailContent = { content: cleanContent, type: type };

    shareBox.innerHTML = `
        <button onclick="shareContent(\`${cleanContent.replace(/`/g, '\\`').replace(/'/g, "\\'")}\`, '${type}')"
                class="${bgClass} border-2 ${darkMode ? 'border-blue-600' : 'border-blue-300'} rounded-xl p-3 shadow-sm hover:shadow-md transition-all flex items-center gap-2">
            <span class="text-xl">üì§</span>
            <span class="text-sm font-medium ${textClass}">Share this ${type}</span>
        </button>
        <button onclick="openEmailModal('${type}')"
                class="${emailBgClass} border-2 ${darkMode ? 'border-purple-600' : 'border-purple-300'} rounded-xl p-3 shadow-sm hover:shadow-md transition-all flex items-center gap-2">
            <span class="text-xl">üìß</span>
            <span class="text-sm font-medium ${emailTextClass}">Email this ${type}</span>
        </button>
    `;

    chatContainer.appendChild(shareBox);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function shareContent(content, type) {
    const title = `My ${type} from JARVIS`;
    const text = `${title}\n\n${content}\n\n---\nShared via JARVIS Voice Assistant`;
    
    
    if (navigator.share) {
        try {
            await navigator.share({
                title: title,
                text: text
            });
            
            showTemporaryMessage('‚úÖ Shared successfully!');
        } catch (error) {
            if (error.name !== 'AbortError') {
                
                copyToClipboard(text);
            }
        }
    } else {
        
        copyToClipboard(text);
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showTemporaryMessage('üìã Copied to clipboard! Now you can paste it into SMS, WhatsApp, or any app!');
    }).catch(err => {
        showTemporaryMessage('‚ùå Failed to copy. Please try again.');
    });
}

// ============ EMAIL FUNCTIONALITY ============

// Open email modal to get user's email
function openEmailModal(type) {
    // Check if modal already exists
    let modal = document.getElementById('email-modal');
    if (modal) {
        modal.remove();
    }

    const bgOverlay = darkMode ? 'bg-black/70' : 'bg-black/50';
    const modalBg = darkMode ? 'bg-gray-800' : 'bg-white';
    const textColor = darkMode ? 'text-white' : 'text-gray-800';
    const inputBg = darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-800 border-gray-300';

    modal = document.createElement('div');
    modal.id = 'email-modal';
    modal.className = `fixed inset-0 ${bgOverlay} flex items-center justify-center z-50 fade-in`;

    // Get saved email for auto-fill
    const savedEmail = loadSavedEmail();

    modal.innerHTML = `
        <div class="${modalBg} rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold ${textColor}">üìß Email Your ${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
                <button onclick="closeEmailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <p class="text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4">
                Enter your email address to receive this ${type} in your inbox.
            </p>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium ${textColor} mb-1">Email Address</label>
                    <input type="email" id="email-input"
                           placeholder="your.email@example.com"
                           value="${savedEmail}"
                           class="w-full px-4 py-3 rounded-xl border ${inputBg} focus:outline-none focus:ring-2 focus:ring-purple-500"
                           onkeypress="if(event.key === 'Enter') sendEmail('${type}')">
                </div>

                <div class="flex gap-3">
                    <button onclick="closeEmailModal()"
                            class="flex-1 px-4 py-3 rounded-xl border ${darkMode ? 'border-gray-600 text-gray-300 hover:bg-gray-700' : 'border-gray-300 text-gray-600 hover:bg-gray-100'} transition-all">
                        Cancel
                    </button>
                    <button onclick="sendEmail('${type}')"
                            class="flex-1 px-4 py-3 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition-all font-medium">
                        Send Email
                    </button>
                </div>

                <p class="text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center">
                    This will open your default email app with the content ready to send.
                </p>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Focus the input (select all if pre-filled)
    setTimeout(() => {
        const input = document.getElementById('email-input');
        if (input) {
            input.focus();
            if (savedEmail) {
                input.select();
            }
        }
    }, 100);
}

// Close email modal
function closeEmailModal() {
    const modal = document.getElementById('email-modal');
    if (modal) {
        modal.classList.add('fade-out');
        setTimeout(() => modal.remove(), 300);
    }
}

// Send email using mailto
function sendEmail(type) {
    const emailInput = document.getElementById('email-input');
    const email = emailInput?.value?.trim();

    if (!email) {
        showTemporaryMessage('‚ùå Please enter an email address');
        return;
    }

    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showTemporaryMessage('‚ùå Please enter a valid email address');
        return;
    }

    // Get the stored content
    const pending = window.pendingEmailContent;
    if (!pending || !pending.content) {
        showTemporaryMessage('‚ùå No content to send. Please try again.');
        closeEmailModal();
        return;
    }

    // Prepare email content
    const typeTitle = type.charAt(0).toUpperCase() + type.slice(1);
    const subject = encodeURIComponent(`Your ${typeTitle} from JARVIS`);

    // Format content for email (limit length for mailto)
    let emailBody = `Hi!\n\nHere's your ${type} from JARVIS Voice Assistant:\n\n`;
    emailBody += '‚ïê'.repeat(40) + '\n\n';
    emailBody += pending.content.substring(0, 1500); // Limit content length
    if (pending.content.length > 1500) {
        emailBody += '\n\n[Content truncated - full version available in app]';
    }
    emailBody += '\n\n' + '‚ïê'.repeat(40);
    emailBody += '\n\nSent via JARVIS Voice Assistant';
    emailBody += '\n\nHave a great trip! üåü';

    const body = encodeURIComponent(emailBody);

    // Create mailto link
    const mailtoLink = `mailto:${email}?subject=${subject}&body=${body}`;

    // Open email client
    window.location.href = mailtoLink;

    // Save email for future use
    try {
        localStorage.setItem('jarvis_user_email', email);
    } catch (e) {
        // Non-fatal
    }

    // Close modal and show success
    closeEmailModal();
    showTemporaryMessage('üìß Opening your email app...');
}

// Load saved email when opening modal (auto-fill)
function loadSavedEmail() {
    try {
        return localStorage.getItem('jarvis_user_email') || '';
    } catch (e) {
        return '';
    }
}

// ============ END EMAIL FUNCTIONALITY ============

function showTemporaryMessage(message) {
    const chatContainer = document.getElementById('chat-container');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'flex justify-center my-2 fade-in';

    const bgClass = darkMode ? 'bg-green-900' : 'bg-green-50';
    const textClass = darkMode ? 'text-green-200' : 'text-green-900';

    msgDiv.innerHTML = `
        <div class="${bgClass} border-2 ${darkMode ? 'border-green-600' : 'border-green-300'} rounded-lg px-4 py-2">
            <span class="text-sm font-medium ${textClass}">${message}</span>
        </div>
    `;

    chatContainer.appendChild(msgDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;


    setTimeout(() => {
        msgDiv.classList.add('fade-out');
        setTimeout(() => msgDiv.remove(), 300);
    }, 3000);
}

// ============ FEEDBACK & LEARNING SYSTEM ============

// Store the last query-response pair for feedback
let lastQueryResponse = { query: '', response: '' };

// Load learned preferences from localStorage
function loadLearnedPreferences() {
    try {
        const data = localStorage.getItem('jarvis_learned_preferences');
        return data ? JSON.parse(data) : {
            positivePatterns: [],      // Successful query patterns
            preferredTopics: {},       // Topics user likes
            feedbackCount: { positive: 0, negative: 0 },
            lastUpdated: null
        };
    } catch (e) {
        return { positivePatterns: [], preferredTopics: {}, feedbackCount: { positive: 0, negative: 0 }, lastUpdated: null };
    }
}

// Save learned preferences to localStorage
function saveLearnedPreferences(prefs) {
    try {
        prefs.lastUpdated = new Date().toISOString();
        localStorage.setItem('jarvis_learned_preferences', JSON.stringify(prefs));
    } catch (e) {
        console.log('Could not save preferences:', e);
    }
}

// Extract topic keywords from a query
function extractTopics(text) {
    const topics = [];
    const lowerText = text.toLowerCase();

    const topicPatterns = {
        'travel': /\b(trip|travel|visit|itinerary|vacation|holiday|tour)\b/,
        'hotels': /\b(hotel|stay|accommodation|resort|hostel|booking)\b/,
        'restaurants': /\b(restaurant|food|eat|dining|cuisine|cafe)\b/,
        'weather': /\b(weather|temperature|forecast|rain|sunny|climate)\b/,
        'activities': /\b(things to do|activities|attractions|sightseeing|places)\b/,
        'transport': /\b(transport|bus|train|metro|taxi|uber|flight)\b/,
        'shopping': /\b(shopping|mall|market|buy|store)\b/
    };

    for (const [topic, pattern] of Object.entries(topicPatterns)) {
        if (pattern.test(lowerText)) {
            topics.push(topic);
        }
    }

    return topics;
}

// Handle positive feedback (thumbs up)
function handlePositiveFeedback(buttonElement) {
    const prefs = loadLearnedPreferences();

    // Record the successful interaction
    if (lastQueryResponse.query) {
        const topics = extractTopics(lastQueryResponse.query);

        // Store successful query pattern (limit to 50 patterns)
        prefs.positivePatterns.push({
            query: lastQueryResponse.query.substring(0, 100),
            topics: topics,
            timestamp: new Date().toISOString()
        });

        // Keep only last 50 patterns
        if (prefs.positivePatterns.length > 50) {
            prefs.positivePatterns = prefs.positivePatterns.slice(-50);
        }

        // Increment topic preferences
        topics.forEach(topic => {
            prefs.preferredTopics[topic] = (prefs.preferredTopics[topic] || 0) + 1;
        });
    }

    prefs.feedbackCount.positive++;
    saveLearnedPreferences(prefs);

    // Update UI
    const container = buttonElement.closest('.feedback-container');
    container.innerHTML = `
        <div class="flex items-center gap-2 text-green-500">
            <span>üëç</span>
            <span class="text-xs">Thanks for the feedback!</span>
        </div>
    `;

    // Fade out after a moment
    setTimeout(() => {
        container.classList.add('fade-out');
        setTimeout(() => container.remove(), 300);
    }, 2000);
}

// Handle negative feedback (thumbs down)
function handleNegativeFeedback(buttonElement) {
    const prefs = loadLearnedPreferences();
    prefs.feedbackCount.negative++;
    saveLearnedPreferences(prefs);

    // Update UI
    const container = buttonElement.closest('.feedback-container');
    container.innerHTML = `
        <div class="flex items-center gap-2 text-orange-500">
            <span>üëé</span>
            <span class="text-xs">Sorry about that. I'll try to do better!</span>
        </div>
    `;

    // Fade out after a moment
    setTimeout(() => {
        container.classList.add('fade-out');
        setTimeout(() => container.remove(), 300);
    }, 2000);
}

// Add feedback buttons after AI response
function addFeedbackButtons(query, response) {
    // Store for feedback reference
    lastQueryResponse = { query, response };

    const chatContainer = document.getElementById('chat-container');
    const feedbackDiv = document.createElement('div');
    feedbackDiv.className = 'flex justify-start my-2 fade-in feedback-container';

    const bgClass = darkMode ? 'bg-gray-800' : 'bg-gray-100';
    const textClass = darkMode ? 'text-gray-400' : 'text-gray-600';

    feedbackDiv.innerHTML = `
        <div class="flex items-center gap-3 ${bgClass} rounded-full px-3 py-1.5 ml-2">
            <span class="text-xs ${textClass}">Was this helpful?</span>
            <button onclick="handlePositiveFeedback(this)"
                    class="p-1.5 rounded-full hover:bg-green-100 dark:hover:bg-green-900 transition-all"
                    title="Yes, helpful!">
                <span class="text-lg">üëç</span>
            </button>
            <button onclick="handleNegativeFeedback(this)"
                    class="p-1.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900 transition-all"
                    title="Not quite right">
                <span class="text-lg">üëé</span>
            </button>
        </div>
    `;

    chatContainer.appendChild(feedbackDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Get user's preferred topics for personalization
function getUserPreferredTopics() {
    const prefs = loadLearnedPreferences();
    // Sort topics by preference count
    return Object.entries(prefs.preferredTopics)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([topic]) => topic);
}

// Get feedback stats for display
function getFeedbackStats() {
    const prefs = loadLearnedPreferences();
    return prefs.feedbackCount;
}

// ============ END FEEDBACK SYSTEM ============

let conversationContext = [];

async function callAIWithTyping(message, loadingMessage = 'Thinking...') {
    
    showThinkingIndicator(loadingMessage);
    try {
        const response = await askGeminiAI(message);
        hideThinkingIndicator();
        return response;
    } catch (error) {
        hideThinkingIndicator();
        showError('AI request failed. Please try again.');
        throw error;
    }
}

async function askGeminiAI(userMessage) {
    try {
        
        conversationContext.push({ role: 'user', text: userMessage });
        if (conversationContext.length > 6) {
            conversationContext = conversationContext.slice(-6);
        }
        
        const contextMessages = conversationContext.map(msg => 
            `${msg.role === 'user' ? 'User' : 'Assistant'}: ${msg.text}`
        ).join('\n');
        
        const systemPrompt = `You are JARVIS, a helpful voice assistant.${userName ? ` The user's name is ${userName}. Use their name naturally and occasionally.` : ' Be friendly and conversational.'}

‚õî CRITICAL ANTI-HALLUCINATION RULES:
1. NEVER make up or invent names of places, hotels, restaurants, or attractions
2. If you're not 100% CERTAIN something exists, DO NOT mention it
3. For location-based queries, only mention places you're ABSOLUTELY SURE are real
4. If unsure, say "I recommend searching online for specific options" instead of making up names
5. Better to give less information than false information
6. DO NOT invent hotel names, restaurant names, or attraction names
7. For small/unknown towns, admit you don't have specific info rather than guessing

RULES:
- ${userName ? `The user's name is ${userName} - use it!` : 'You do NOT know the user\'s name. NEVER say "User" or "Hi User!" - just say "Hi!" or be friendly without using a name.'}
- Be natural and conversational
- If asked about specific places/hotels/restaurants you're unsure about, recommend checking Google Maps, MakeMyTrip, or TripAdvisor

Your capabilities:
- Weather (say "check weather")
- Shopping lists (say "manage shopping")  
- Reminders (say "set reminder")
- Memory (remembering where things are)
- Travel itineraries and recommendations

For casual conversation, be friendly and natural.
For name corrections like "no, my name is X", extract the name.

Recent conversation:
${contextMessages}

Respond conversationally. DO NOT MAKE UP PLACE NAMES.`;
        const intent = getUserIntent(userMessage);
        window.__intentContext = {
          allowHotels: intent.wantsHotels,
          allowRestaurants: intent.wantsRestaurants,
          itineraryOnly:
            intent.wantsItinerary &&
            !intent.wantsHotels &&
            !intent.wantsRestaurants, 
          __retried: false };

        window.__lastUserMessage = userMessage;

        
        const response = await fetch('/api/chat-groq', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: userMessage,
                systemPrompt: systemPrompt,
                userName: userName
            })
        });
        
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå API Response not OK:', response.status, errorText);
            throw new Error(`AI request failed: ${response.status}`);
        }
        
        const data = await response.json();
        conversationContext.push({ role: 'assistant', text: data.response || data.text });
        
        return data;
    } catch (error) {
        
        showError(`AI request failed: ${error.message}`);
        return {
            response: "I'm having trouble connecting to my AI. Please try again in a moment!",
            intent: 'error'
        };
    }
}

async function handleNameCorrection(text) {
    const patterns = [
        /(?:no|nah|nope|actually|wrong),?\s*(?:my name is|i'm|i am|it's|call me)\s+([^,.!?]+)/i,
        /(?:my name is|i'm|i am|it's|call me)\s+([^,.!?]+)/i
    ];
    
    let newName = '';
    for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            newName = match[1].trim();
            break;
        }
    }
    
    if (!newName) {
        const aiResponse = await askGeminiAI(`Extract just the name from: "${text}"`);
        newName = aiResponse.response;
    }
    
    newName = newName.replace(/[?.!,]$/g, '').trim();
    newName = newName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
    
    const isHarsh = /idiot|stupid|dumb|moron|fool/i.test(text);
    userName = newName;
    saveUserData();
    
    const response = isHarsh 
        ? `I apologize! I've updated your name to ${userName}.`
        : `Got it! I've updated your name to ${userName}.`;
    
    addChatMessage(response, false);
    speak(response);
}

        
        let darkMode = false;
        let autoSpeak = false; 
        let recognition = null;
        let continuousRecognition = null;
        let wakeWordMode = false;  
        let commandMode = false;    
        let isListening = false;
        let synth = window.speechSynthesis;
        let reminders = [];
        let weather = null;
        let waitingForLocation = false;
        let waitingForReminder = false;
        let chatHistory = [];
        let micPermissionGranted = false;
        
        
        let userName = null;
        let waitingForName = false;
        let shoppingList = [];
        let memoryStore = {}; 

        
        window.onload = async () => {
            
            const introScreen = document.getElementById('jarvis-intro');
            
            
            setTimeout(() => {
                const initText = "Initializing JARVIS";
                if (typeof responsiveVoice !== 'undefined') {
                    responsiveVoice.speak(initText, "UK English Male", { 
                        pitch: 0.9, 
                        rate: 0.95, 
                        volume: 1 
                    });
                } else {
                    const synth = window.speechSynthesis;
                    const utterance = new SpeechSynthesisUtterance(initText);
                    const voices = synth.getVoices();
                    const maleVoice = voices.find(v => 
                        v.name.includes('Daniel') || 
                        v.name.includes('Alex') ||
                        (v.lang.includes('en-GB') && !v.name.toLowerCase().includes('female'))
                    ) || voices.find(v => v.lang.startsWith('en'));
                    if (maleVoice) utterance.voice = maleVoice;
                    utterance.rate = 0.95;
                    utterance.pitch = 0.9;
                    synth.speak(utterance);
                }
            }, 2000);
            
            
            setTimeout(() => {
                introScreen.classList.add('hidden');
                setTimeout(() => {
                    introScreen.style.display = 'none';
                }, 500);
            }, 5000);
            
            await requestMicrophonePermission();
            loadUserData();
            checkReminders();
            
            
            const hasVisited = localStorage.getItem('unify_has_visited');
            if (!hasVisited) {
                showInitialSuggestions();
                
            } else {
                
                const suggestionsBox = document.getElementById('initial-suggestions');
                if (suggestionsBox) {
                    suggestionsBox.style.display = 'none';
                }
            }
            
            
            const welcomeMsg = userName 
                ? `Hi ${userName}! How can I help you today?` 
                : "Hi! I'm JARVIS, your voice assistant. How can I help you today?";
            
            addChatMessage(welcomeMsg, false);
            speak(welcomeMsg);
            
            
        };

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                micPermissionGranted = true;
                initializeSpeechRecognition();
            } catch (error) {
                micPermissionGranted = false;
                const errorMsg = "Microphone access denied. Please enable it in your browser settings to use voice features.";
                addChatMessage(errorMsg, false);
            }
        }

        
        function toggleDarkMode() {
            darkMode = !darkMode;
            const body = document.body;
            const card = document.getElementById('main-card');
            const title = document.getElementById('title');
            const subtitle = document.getElementById('subtitle');
            const chatContainer = document.getElementById('chat-container');
            const lightSwitch = document.getElementById('light-switch');
            const tubeLight = document.getElementById('tube-light');
            const weatherEffects = document.getElementById('weather-effects');
            const receipt = document.getElementById('shopping-receipt');
            
            
            const inputBarContainer = document.getElementById('input-bar-container');
            const inputBarInner = document.getElementById('input-bar-inner');
            const textInput = document.getElementById('text-input');
            const helpBtn = document.getElementById('help-btn');
            const footerDisclaimer = document.getElementById('footer-disclaimer');
            
            if (darkMode) {
                
                lightSwitch.classList.remove('on');
                tubeLight.classList.remove('on', 'starting');
                
                
                if (weatherEffects) weatherEffects.innerHTML = '';
                
                
                body.classList.remove('light');
                body.classList.add('dark');
                body.style.background = '#000';
                body.style.filter = 'none';
                card.className = 'bg-gray-900 bg-opacity-90 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-gray-700 mb-6';
                title.className = 'text-4xl font-black text-white';
                subtitle.className = 'text-sm text-gray-300';
                if (chatContainer) chatContainer.className = 'bg-gray-800 rounded-2xl p-4 max-h-96 overflow-y-auto space-y-3 mb-6';
                if (receipt) receipt.classList.add('dark-mode');
                
                
                if (inputBarContainer) {
                    inputBarContainer.className = 'fixed bottom-0 left-0 right-0 bg-gray-900 bg-opacity-95 border-t border-gray-700 shadow-lg z-40 backdrop-blur-xl';
                }
                if (inputBarInner) {
                    inputBarInner.className = 'flex items-center gap-3 bg-gray-800 rounded-full border-2 border-gray-600 px-4 py-3 hover:border-purple-400 transition-all';
                }
                if (textInput) {
                    textInput.className = 'flex-1 bg-transparent outline-none text-white placeholder-gray-400';
                }
                if (helpBtn) {
                    const svg = helpBtn.querySelector('svg');
                    if (svg) svg.className = 'text-gray-400 hover:text-purple-400 transition-all';
                }
                if (footerDisclaimer) {
                    footerDisclaimer.className = 'text-xs text-gray-400';
                }
            } else {
                
                lightSwitch.classList.add('on');
                
                
                tubeLight.classList.add('starting');
                
                
                setTimeout(() => {
                    tubeLight.classList.remove('starting');
                    tubeLight.classList.add('on');
                    
                    
                    body.classList.remove('dark');
                    body.classList.add('light');
                    
                    
                    if (weather && weather.current) {
                        createWeatherEffect(weather.current.weather_code, Math.round(weather.current.temperature_2m));
                    } else {
                        body.style.background = 'linear-gradient(to bottom right, #fce7f3, #e9d5ff, #c7d2fe)';
                        body.style.filter = 'none';
                    }
                    
                    card.className = 'bg-white bg-opacity-80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white border-opacity-50 mb-6';
                    title.className = 'text-4xl font-black text-gray-900';
                    subtitle.className = 'text-sm text-gray-600';
                    if (chatContainer) chatContainer.className = 'bg-gray-50 rounded-2xl p-4 max-h-96 overflow-y-auto space-y-3 mb-6';
                    if (receipt) receipt.classList.remove('dark-mode');
                    
                    
                    if (inputBarContainer) {
                        inputBarContainer.className = 'fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40';
                    }
                    if (inputBarInner) {
                        inputBarInner.className = 'flex items-center gap-3 bg-gray-50 rounded-full border-2 border-gray-200 px-4 py-3 hover:border-purple-300 transition-all';
                    }
                    if (textInput) {
                        textInput.className = 'flex-1 bg-transparent outline-none text-gray-900 placeholder-gray-500';
                    }
                    if (helpBtn) {
                        const svg = helpBtn.querySelector('svg');
                        if (svg) svg.className = 'text-gray-600 hover:text-purple-600 transition-all';
                    }
                    if (footerDisclaimer) {
                        footerDisclaimer.className = 'text-xs text-gray-500';
                    }
                }, 800); 
            }
        }

        
        
        function showHelpModal() {
            const modal = document.createElement('div');
            modal.id = 'help-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.onclick = (e) => {
                if (e.target === modal) closeHelpModal();
            };
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">‚ú® Help & Prompting Tips</h2>
                        <button onclick="closeHelpModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">√ó</button>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <section>
                            <h3 class="text-lg font-bold text-purple-600 dark:text-purple-400 mb-3">üéØ What I Can Do</h3>
                            <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                <p><strong>‚úàÔ∏è Travel Planning:</strong> "Plan a 3-day trip to Tokyo" or "Hotels in Paris with vegetarian food"</p>
                                <p><strong>üçΩÔ∏è Food Recommendations:</strong> "Best restaurants in Rome" or "Biryani places in Chennai"</p>
                                <p><strong>üöå Transport Info:</strong> "How to get around London?" or "Transport in Mumbai"</p>
                                <p><strong>üå§Ô∏è Weather:</strong> "What's the weather?" or "Will it rain in Seattle tomorrow?"</p>
                                <p><strong>üõí Shopping Lists:</strong> "Add 2 pounds of chicken to my list" or "Show my shopping list"</p>
                                <p><strong>‚è∞ Reminders:</strong> "Remind me to call mom at 5pm" or "Remind me tomorrow to buy groceries"</p>
                                <p><strong>üîë Memory:</strong> "My car keys are on the counter" or "Where are my keys?"</p>
                            </div>
                        </section>
                        
                        <section>
                            <h3 class="text-lg font-bold text-purple-600 dark:text-purple-400 mb-3">üí° Pro Tips for Better Results</h3>
                            <div class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                                <div>
                                    <p class="font-semibold text-gray-900 dark:text-white">Be Specific:</p>
                                    <p class="text-gray-600 dark:text-gray-400">‚ùå "Hotels"</p>
                                    <p class="text-green-600 dark:text-green-400">‚úÖ "Hotels in Chennai with non-vegetarian food"</p>
                                </div>
                                
                                <div>
                                    <p class="font-semibold text-gray-900 dark:text-white">Ask for Local Specialties:</p>
                                    <p class="text-green-600 dark:text-green-400">‚úÖ "Biryani places in Hyderabad" or "Pizza spots in NYC"</p>
                                    <p class="text-xs text-gray-500 mt-1">I'll suggest region-specific dishes based on location!</p>
                                </div>
                                
                                <div>
                                    <p class="font-semibold text-gray-900 dark:text-white">Use the Share Button:</p>
                                    <p class="text-gray-600 dark:text-gray-400">After getting recommendations, click "üì§ Share" to send via SMS or WhatsApp!</p>
                                </div>
                                
                                <div>
                                    <p class="font-semibold text-gray-900 dark:text-white">Get GPS Directions:</p>
                                    <p class="text-gray-600 dark:text-gray-400">Hotel recommendations are based on web search results!</p>
                                </div>
                                
                                <div>
                                    <p class="font-semibold text-gray-900 dark:text-white">Dynamic Suggestions:</p>
                                    <p class="text-gray-600 dark:text-gray-400">After each response, check the "Try asking me" box - it updates with relevant follow-up questions!</p>
                                </div>
                            </div>
                        </section>
                        
                        <section>
                            <h3 class="text-lg font-bold text-purple-600 dark:text-purple-400 mb-3">üó£Ô∏è Voice Commands</h3>
                            <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                <p>Just press the <strong>üé§ microphone button</strong> and speak naturally!</p>
                                <p class="text-xs text-gray-500">Examples: "What's the weather?" or "Add milk to my shopping list"</p>
                            </div>
                        </section>
                        
                        <section>
                            <h3 class="text-lg font-bold text-purple-600 dark:text-purple-400 mb-3">üåç Smart Features</h3>
                            <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                <p><strong>üîç Web Search:</strong> I verify hotel specialties using real web data</p>
                                <p><strong>üìç Location-Aware:</strong> I detect if you're in a big city or small town for transport advice</p>
                                <p><strong>üçõ Regional Food:</strong> Get Biryani in India, Pizza in NYC, Pasta in Italy automatically!</p>
                                <p><strong>üé´ Context Suggestions:</strong> After itineraries, I suggest hotels, restaurants, nightlife, and more</p>
                            </div>
                        </section>
                        
                        <div class="text-center pt-4 border-t border-gray-200 dark:border-gray-700">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Need more help? Click the <strong>Request</strong> button to suggest improvements!</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeHelpModal() {
            const modal = document.getElementById('help-modal');
            if (modal) modal.remove();
        }
        
        
        function openFeatureRequest() {
            
            const formUrl = 'https://forms.gle/h8Wtb3fbwKBnjoYT8';
            window.open(formUrl, '_blank');
        }

        
        function addAIMessage(text, trustLevel = TRUST_LEVEL.GENERATED) 
        {
          if (violatesIntent(text)) {
            window.__telemetry.hallucinationAttempts++;

            if (!window.__intentContext.__retried) {
              window.__intentContext.__retried = true;
              window.__telemetry.regenerations++;
              retryWithStricterPrompt();
              return; 
            } 
          }

          if (containsPlaceList(text) && trustLevel !== TRUST_LEVEL.VERIFIED) {
            text = '‚ö†Ô∏è This response contains generated structure only. ' + 
            'Specific places are shown separately using verified location data.\n\n' + text;
        }

        text += '\n\n' + getTrustLabel(trustLevel);
        text += '\n' + getSourceAttribution(trustLevel);

        addChatMessage(text, false, true); 
      }
        
        function addChatMessage(text, isUser = true, typewriter = false) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} items-start gap-2 fade-in`;
            
            if (isUser) {
                
                const formattedText = escapeHtml(text).replace(/\n/g, '<br>');
                messageDiv.innerHTML = `
                    <div class="bg-indigo-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 max-w-md shadow-sm relative group">
                        <p class="text-sm">${formattedText}</p>
                        <button onclick="deleteMessage(this)" class="hidden group-hover:block absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-sm hover:bg-red-600 transition-all shadow-lg">√ó</button>
                    </div>
                `;
            } else {

                const bgClass = darkMode ? 'bg-gray-700' : 'bg-white';
                const textClass = darkMode ? 'text-gray-200' : 'text-gray-800';


                const textForSpeech = text.replace(/<[^>]*>/g, '');

                // Check if message contains HTML elements (like iframes, divs)
                const hasHtmlContent = /<(iframe|div|img|table)\s/i.test(text);

                // Convert markdown links [text](url) to HTML anchor tags, then newlines to <br>
                // But preserve HTML tags like <iframe>, <div>, etc.
                let formattedText;
                if (hasHtmlContent) {
                    // For HTML content, only convert markdown links and bold, preserve other HTML
                    formattedText = text
                        .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-500 hover:text-blue-700 underline">$1</a>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                    // Only convert newlines that are NOT inside HTML tags
                    formattedText = formattedText.replace(/\n(?![^<]*>)/g, '<br>');
                } else {
                    formattedText = text
                        .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-500 hover:text-blue-700 underline">$1</a>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');
                }

                // Use wider container for messages with maps/iframes
                const containerWidth = hasHtmlContent ? 'max-w-2xl' : 'max-w-md';

                messageDiv.innerHTML = `
                    <div class="flex items-start gap-2 ${containerWidth}">
                        <div class="${bgClass} rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm flex-1 overflow-hidden">
                            <div class="text-sm ${textClass} typewriter-text"></div>
                        </div>
                        <button onclick="toggleSpeak(\`${textForSpeech.replace(/`/g, '\\`').replace(/'/g, "\\'")}\`, this)" class="flex-shrink-0 p-2 rounded-full bg-purple-500 hover:bg-purple-600 text-white transition-all speaker-btn">
                            <svg class="play-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                            <svg class="stop-icon hidden" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                            </svg>
                        </button>
                    </div>
                `;
                
                chatContainer.appendChild(messageDiv);
                
                
                if (typewriter) {
                    const textElement = messageDiv.querySelector('.typewriter-text');
                    let charIndex = 0;
                    const speed = 15; 
                    
                    function typeCharacter() {
                        if (charIndex < formattedText.length) {
                            textElement.innerHTML = formattedText.substring(0, charIndex + 1);
                            charIndex++;
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                            setTimeout(typeCharacter, speed);
                        }
                    }
                    
                    typeCharacter();
                } else {
                    const textElement = messageDiv.querySelector('.typewriter-text');
                    textElement.innerHTML = formattedText;
                }
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
                chatHistory.push({ text, isUser });
                return;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            chatHistory.push({ text, isUser });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSendButton() {
            const input = document.getElementById('text-input');
            const sendBtn = document.getElementById('send-btn');
            const voiceBtn = document.getElementById('voice-btn');
            
            if (input.value.trim().length > 0) {
                
                sendBtn.classList.remove('hidden');
                voiceBtn.classList.add('hidden');
            } else {
                
                sendBtn.classList.add('hidden');
                voiceBtn.classList.remove('hidden');
            }
        }

        function sendTextInput() {
            const input = document.getElementById('text-input');
            const text = input.value.trim();
            if (text) {
                addChatMessage(text, true);
                
                if (waitingForName) {
                    handleNameInput(text);
                } else if (waitingForLocation) {
                    
                    const cleanLocation = text.trim();
                    if (cleanLocation.length < 2) {
                        const msg = "I didn't catch that. Please tell me a city or location name.";
                        addChatMessage(msg, false);
                        speak(msg);
                        input.value = '';
                        return;
                    }
                    
                    const fillerWords = ['he', 'she', 'it', 'a', 'an', 'the', 'um', 'uh', 'er', 'oh'];
                    if (fillerWords.includes(cleanLocation.toLowerCase())) {
                        const msg = "I didn't quite catch the location. Could you say it again?";
                        addChatMessage(msg, false);
                        speak(msg);
                        input.value = '';
                        return;
                    }
                    waitingForLocation = false;
                    getWeatherByCity(cleanLocation);
                } else if (waitingForReminder) {
                    waitingForReminder = false;
                    createReminderFromText(text);
                } else {
                    processCommand(text);
                }
                
                input.value = '';
                toggleSendButton(); 
            }
        }

        
        let userLocation = null;

        async function getUserLocation() {
            if (userLocation) return userLocation;
            
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            resolve(userLocation);
                        },
                        () => resolve(null),
                        { timeout: 5000, maximumAge: 300000 }
                    );
                } else {
                    resolve(null);
                }
            });
        }

        async function displayHotelsWithMaps(aiText, query) {
            const location = await getUserLocation();
            
            
            const hotels = [];
            const hotelBlocks = aiText.split('---').filter(b => b.trim());
            
            for (const block of hotelBlocks) {
                const lines = block.trim().split('\n');
                const hotel = {};
                
                for (const line of lines) {
                    if (line.startsWith('HOTEL:')) hotel.name = line.substring(6).trim();
                    else if (line.startsWith('DESC:')) hotel.desc = line.substring(5).trim();
                    else if (line.startsWith('PRICE:')) hotel.price = line.substring(6).trim();
                    else if (line.startsWith('FOOD:')) hotel.food = line.substring(5).trim();
                    else if (line.startsWith('SPECIALTY:')) hotel.specialty = line.substring(10).trim();
                    else if (line.startsWith('WHY:')) hotel.why = line.substring(4).trim();
                }
                
                if (hotel.name) hotels.push(hotel);
            }
            
            
            const cityMatch = query.match(/in\s+([^,?]+)/i);
            const city = cityMatch ? cityMatch[1].trim() : '';
            
            
            let displayHtml = '<div class="space-y-4">';
            
            for (const hotel of hotels) {
                const mapUrl = location 
                    ? `https://www.google.com/maps/dir/${location.lat},${location.lon}/${encodeURIComponent(hotel.name + ' ' + city)}`
                    : `https://www.google.com/maps/search/${encodeURIComponent(hotel.name + ' ' + city)}`;
                
                const priceColor = hotel.price === 'Budget' ? 'text-green-600' : 
                                  hotel.price === 'Luxury' ? 'text-purple-600' : 'text-blue-600';
                const foodIcon = hotel.food === 'Pure Veg' ? 'ü•¨' : 
                                hotel.food === 'Non-Veg' ? 'üçñ' : 'üçΩÔ∏è';
                
                displayHtml += `
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-4 shadow-md">
                        <div class="flex items-start justify-between mb-2">
                            <h3 class="text-lg font-bold text-gray-900">${hotel.name}</h3>
                            <a href="${mapUrl}" target="_blank" 
                               class="flex items-center gap-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-medium transition-all">
                                üìç Directions
                            </a>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">${hotel.desc}</p>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="px-2 py-1 ${priceColor} bg-white rounded-full text-xs font-semibold border">üí∞ ${hotel.price}</span>
                            <span class="px-2 py-1 text-gray-700 bg-white rounded-full text-xs font-semibold border">${foodIcon} ${hotel.food}</span>
                        </div>
                        <p class="text-sm text-purple-700 font-medium mb-1">üç¥ Try: ${hotel.specialty}</p>
                        <p class="text-xs text-gray-600">‚ú® ${hotel.why}</p>
                    </div>
                `;
            }
            
            displayHtml += '</div>';
            
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start items-start gap-2 fade-in';
            messageDiv.innerHTML = `
                <div class="max-w-2xl">
                    ${displayHtml}
                    <p class="text-sm text-gray-600 mt-3 text-center">I hope you have a comfortable stay!</p>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            speak("I've found some great hotels for you. Check out the recommendations!");
        }

        function showFastFoodBox() {
            const chatContainer = document.getElementById('chat-container');
            
            
            let region = 'international'; 
            
            if (userLocation) {
                const country = userLocation.country?.toLowerCase() || '';
                const state = userLocation.state?.toLowerCase() || '';
                
                
                if (country.includes('india') && (
                    state.includes('tamil nadu') || state.includes('karnataka') || 
                    state.includes('kerala') || state.includes('andhra') || 
                    state.includes('telangana') || state.includes('pondicherry')
                )) {
                    region = 'south-india';
                }
                
                else if (country.includes('india')) {
                    region = 'north-india';
                }
                
                else if (country.includes('united states') || country.includes('usa')) {
                    region = 'usa';
                }
                
                else if (country.includes('united kingdom') || country.includes('uk') || country.includes('england')) {
                    region = 'uk';
                }
                
                else if (country.includes('uae') || country.includes('saudi') || country.includes('qatar') || country.includes('kuwait')) {
                    region = 'middle-east';
                }
            }
            
            
            const regionalButtons = {
                'south-india': [
                    { emoji: 'üçî', title: 'Fast Food', query: 'fast food near me' },
                    { emoji: 'üçõ', title: 'Biryani', query: 'biryani near me' },
                    { emoji: '‚òï', title: 'Filter Coffee', query: 'filter coffee near me' }
                ],
                'north-india': [
                    { emoji: 'üçî', title: 'Fast Food', query: 'fast food near me' },
                    { emoji: 'üçõ', title: 'Biryani', query: 'biryani near me' },
                    { emoji: 'ü´ì', title: 'Dhaba', query: 'dhaba near me' }
                ],
                'usa': [
                    { emoji: '‚òï', title: 'Coffee Shops', query: 'coffee shops near me' },
                    { emoji: 'üçî', title: 'Fast Food', query: 'fast food near me' },
                    { emoji: 'üçï', title: 'Pizza', query: 'pizza near me' }
                ],
                'uk': [
                    { emoji: '‚òï', title: 'Coffee', query: 'coffee shops near me' },
                    { emoji: 'üçî', title: 'Fast Food', query: 'fast food near me' },
                    { emoji: 'üçü', title: 'Fish & Chips', query: 'fish and chips near me' }
                ],
                'middle-east': [
                    { emoji: 'ü•ô', title: 'Shawarma', query: 'shawarma near me' },
                    { emoji: '‚òï', title: 'Coffee', query: 'coffee shops near me' },
                    { emoji: 'üçî', title: 'Fast Food', query: 'fast food near me' }
                ],
                'international': [
                    { emoji: 'üçî', title: 'Fast Food', query: 'fast food near me' },
                    { emoji: '‚òï', title: 'Coffee', query: 'coffee shops near me' },
                    { emoji: 'üçï', title: 'Pizza', query: 'pizza near me' }
                ]
            };
            
            const buttons = regionalButtons[region] || regionalButtons['international'];
            
            const boxDiv = document.createElement('div');
            boxDiv.className = 'flex flex-wrap justify-center gap-4 my-6 px-4 fade-in';
            
            let buttonsHTML = '';
            buttons.forEach(btn => {
                buttonsHTML += `
                    <a href="https://www.google.com/search?q=${encodeURIComponent(btn.query)}" target="_blank"
                       class="flex items-center gap-3 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white px-6 py-3 rounded-xl shadow-lg transition-all transform hover:scale-105 min-w-[160px]">
                        <span class="text-2xl">${btn.emoji}</span>
                        <div class="text-left">
                            <div class="font-bold text-sm">${btn.title}</div>
                            <div class="text-xs opacity-80">Search nearby</div>
                        </div>
                    </a>
                `;
            });
            
            boxDiv.innerHTML = `
                <div class="w-full text-center mb-3 mt-4">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">üéØ Quick Access</span>
                </div>
                <div class="flex flex-wrap justify-center gap-4">
                    ${buttonsHTML}
                </div>
                <div class="w-full text-center mt-2">
                    <span class="text-xs text-gray-400">Click to search on Google Maps</span>
                </div>
            `;
            
            chatContainer.appendChild(boxDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTransportSuggestion() {
            const chatContainer = document.getElementById('chat-container');
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'flex justify-center my-3 fade-in';
            suggestionDiv.innerHTML = `
                <button onclick="askAboutTransport()"
                   class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-5 py-2 rounded-full shadow-md transition-all text-sm font-medium">
                    üöå Need transport info?
                </button>
            `;
            chatContainer.appendChild(suggestionDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function askAboutTransport() {
            const msg = "Where do you need transport information for?";
            addChatMessage(msg, false);
            speak(msg);
            window.waitingForTransportLocation = true;
        }

        
        
        let isProcessing = false; 
        let speechTimeout = null; 
        
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                addChatMessage("Sorry, speech recognition is not supported in your browser. Please try Chrome, Edge, or Safari.", false);
                return;
            }

            
            continuousRecognition = new SpeechRecognition();
            continuousRecognition.continuous = true;  
            continuousRecognition.interimResults = true;  
            continuousRecognition.lang = 'en-US';
            
            
            continuousRecognition.onstart = () => {
                stopSpeaking();
            };

            continuousRecognition.onresult = async (event) => {
                
                const last = event.results.length - 1;
                const result = event.results[last];
                const text = result[0].transcript.trim().toLowerCase();
                
                if (!text) return;
                
                
                if (wakeWordMode && !commandMode) {
                    
                    if (text.includes('hey jarvis') || text.includes('hey davis')) {
                        
                        commandMode = true;
                        wakeWordMode = false;
                        
                        
                        const response = "Yes, sir?";
                        addChatMessage("üé§ Hey JARVIS", true);
                        addChatMessage(response, false);
                        speak(response);
                        
                        
                        return;
                    }
                    
                    
                    if (result.isFinal) {
                        
                        wakeWordMode = false;
                        commandMode = false;
                        
                    } else {
                        return; 
                    }
                }
                
                
                
                if (speechTimeout) {
                    clearTimeout(speechTimeout);
                }
                
                
                if (result.isFinal) {
                    
                    
                    commandMode = false;
                    wakeWordMode = false;
                    
                    
                    stopListening();
                    
                    
                    if (isProcessing) {
                        return;
                    }
                    
                    isProcessing = true;
                    
                    addChatMessage(result[0].transcript.trim(), true);
                
                try {
                    if (waitingForLocation) {
                        
                        const cleanLocation = text.replace(/[?!]/g, '').trim();
                        
                        if (cleanLocation.length < 2) {
                            const msg = "I didn't catch that. Please tell me a city or location name.";
                            addChatMessage(msg, false);
                            speak(msg);
                            return;
                        }
                        
                        const fillerWords = ['he', 'she', 'it', 'a', 'an', 'the', 'um', 'uh', 'er', 'oh', 'weather'];
                        if (fillerWords.includes(cleanLocation.toLowerCase())) {
                            const msg = "I didn't quite catch the location. Could you say it again?";
                            addChatMessage(msg, false);
                            speak(msg);
                            return;
                        }
                        
                        waitingForLocation = false;
                        await getWeatherByCity(cleanLocation);
                        return;
                    }
                    
                    if (waitingForReminder) {
                        waitingForReminder = false;
                        await createReminderFromText(text);
                        return;
                    }
                    
                    if (waitingForName) {
                        await handleNameInput(text);
                        return;
                    }
                    
                    
                    await processCommand(text);
                } finally {
                    
                    isProcessing = false;
                }
                } 
            };

            continuousRecognition.onerror = (event) => {
                stopListening();
            };

            continuousRecognition.onend = () => {
                stopListening();
            };
        }

        function toggleListening() {
            if (isListening && wakeWordMode) {
                
                stopListening();
                wakeWordMode = false;
                addChatMessage("Wake word mode disabled", false);
            } else if (isListening) {
                stopListening();
            } else {
                
                wakeWordMode = true;
                commandMode = false;
                startListening();
                addChatMessage('üé§ Listening... (Say "Hey JARVIS" or speak directly)', false);
            }
        }

        function startListening() {
            if (!continuousRecognition) {
                addChatMessage("Speech recognition not available. Please use text input.", false);
                return;
            }
            
            try {
                isListening = true;
                continuousRecognition.start();
                
                
                document.getElementById('mic-icon-bottom').classList.add('hidden');
                document.getElementById('waveform-bottom').classList.remove('hidden');
                document.getElementById('voice-btn').classList.add('bg-purple-600', 'ring-4', 'ring-purple-200');
                document.getElementById('voice-btn').classList.remove('bg-gray-900');
                
            } catch (e) {
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            
            if (continuousRecognition) {
                try {
                    continuousRecognition.stop();
                } catch (e) {
                }
            }
            
            
            document.getElementById('mic-icon-bottom')?.classList.remove('hidden');
            document.getElementById('waveform-bottom')?.classList.add('hidden');
            document.getElementById('voice-btn')?.classList.remove('bg-purple-600', 'ring-4', 'ring-purple-200');
            document.getElementById('voice-btn')?.classList.add('bg-gray-900');
        }

        
        recognition = continuousRecognition;

        
        
        
        async function addGPSDirectionsToHotels(responseText, query) {
            // Simply return the response without adding directions
            return responseText;
        }
        
        
        async function enrichHotelSpecialties(responseText, query) {
            
            
            const locationMatch = query.match(/\b(in|at|near)\s+([A-Z][a-z]+(?: [A-Z][a-z]+)*)/i);
            const cityName = locationMatch ? locationMatch[2] : '';
            
            if (!cityName) return responseText;
            
            
            
            const hotelMatches = [...responseText.matchAll(/üè®\s+([^\n\[]+?)(?:\s*\[|$)/gm)];
            
            if (hotelMatches.length === 0) return responseText;
            
            let enrichedResponse = responseText;
            
            
            for (let i = 0; i < Math.min(hotelMatches.length, 5); i++) {
                const match = hotelMatches[i];
                const hotelName = match[1].trim();
                
                try {
                    
                    const searchQuery = `${hotelName} ${cityName} famous for specialty`;
                    
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 300,
                            tools: [{
                                type: 'web_search_20250305',
                                name: 'web_search'
                            }],
                            messages: [{
                                role: 'user',
                                content: `Search for: ${searchQuery}. What is ${hotelName} famous for? Return ONLY the specialty dish/food in 3-5 words. Format: "Famous for: [dish]"`
                            }]
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const content = data.content.find(c => c.type === 'text');
                        
                        if (content && content.text) {
                            const specialty = extractSpecialtyFromResponse(content.text);
                            
                            if (specialty) {
                                
                                
                                const hotelBlockRegex = new RegExp(
                                    `(üè®\\s+${hotelName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}[^‚≠ê]*‚≠ê\\s*Specialty:\\s*)([^\\n]+)`,
                                    'i'
                                );
                                
                                enrichedResponse = enrichedResponse.replace(hotelBlockRegex, `$1${specialty}`);
                            }
                        }
                    }
                } catch (error) {
                    
                }
                
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            return enrichedResponse;
        }
        
        
        function extractSpecialtyFromResponse(text) {
            
            const famousMatch = text.match(/famous for:?\s*([^\n.!?]+)/i);
            if (famousMatch) {
                return cleanSpecialty(famousMatch[1]);
            }
            
            
            const patterns = [
                /(?:known for|specializes in|best known for)[\s:]+([^\n.!?]+)/i,
                /(?:try|must try|signature)[\s:]+([^\n.!?]+)/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    return cleanSpecialty(match[1]);
                }
            }
            
            return null;
        }
        
        
        function cleanSpecialty(text) {
            let specialty = text.trim()
                .replace(/^(their|its|the|a|an)\s+/i, '')
                .replace(/\.$/, '')
                .trim();
            
            
            specialty = specialty.charAt(0).toUpperCase() + specialty.slice(1);
            
            
            if (specialty.length > 60) {
                specialty = specialty.substring(0, 60).trim() + '...';
            }
            
            return specialty;
        }
        
        
        function addFastFoodSuggestionBox() {
            const chatContainer = document.getElementById('chat-container');
            const fastFoodBox = document.createElement('div');
            fastFoodBox.className = 'flex justify-center my-4 fade-in';
            
            const bgClass = darkMode ? 'bg-gray-800 border-gray-600' : 'bg-orange-50 border-orange-300';
            const textClass = darkMode ? 'text-gray-200' : 'text-orange-900';
            const buttonClass = darkMode ? 'bg-orange-600 hover:bg-orange-700' : 'bg-orange-500 hover:bg-orange-600';
            
            fastFoodBox.innerHTML = `
                <div class="${bgClass} border-2 rounded-xl p-4 max-w-md shadow-md">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">üçî</span>
                        <h3 class="font-bold ${textClass}">Quick Bite?</h3>
                    </div>
                    <p class="text-sm ${textClass} mb-3">Looking for fast food nearby?</p>
                    <a href="https://www.google.com/search?q=fast+food+near+me" target="_blank" 
                       class="${buttonClass} text-white px-4 py-2 rounded-lg text-sm font-medium inline-block transition-all hover:scale-105">
                        üîç Search Fast Food Near Me
                    </a>
                </div>
            `;
            
            chatContainer.appendChild(fastFoodBox);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        
        function addTransportSuggestionButton(query) {
            const locationMatch = query.match(/\b(in|at|near|to)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/i);
            const cityName = locationMatch ? locationMatch[2] : '';
            
            if (!cityName) return;
            
            const chatContainer = document.getElementById('chat-container');
            const transportBox = document.createElement('div');
            transportBox.className = 'flex justify-start my-3 fade-in';
            
            const bgClass = darkMode ? 'bg-gray-800' : 'bg-blue-50';
            const textClass = darkMode ? 'text-gray-200' : 'text-blue-900';
            const buttonClass = darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600';
            
            transportBox.innerHTML = `
                <button onclick="getTransportInfo('${cityName}')" 
                        class="${bgClass} border-2 ${darkMode ? 'border-gray-600' : 'border-blue-300'} rounded-xl p-3 shadow-sm hover:shadow-md transition-all flex items-center gap-2">
                    <span class="text-xl">üöå</span>
                    <span class="text-sm font-medium ${textClass}">How to get around ${cityName}?</span>
                </button>
            `;
            
            chatContainer.appendChild(transportBox);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        
        async function getTransportInfo(cityName) {
            
            const metroCities = [
                'chennai', 'bangalore', 'bengaluru', 'delhi', 'mumbai', 'kolkata', 'hyderabad', 'pune', 'ahmedabad',
                'new york', 'nyc', 'boston', 'los angeles', 'chicago', 'san francisco', 'london', 'paris', 'tokyo', 
                'singapore', 'dubai', 'hong kong', 'sydney', 'melbourne', 'toronto', 'vancouver', 'coimbatore',
                'madurai', 'trichy', 'tiruchirappalli', 'salem', 'kochi', 'cochin', 'thiruvananthapuram', 'trivandrum',
                'mysore', 'mysuru', 'mangalore', 'mangaluru', 'vizag', 'visakhapatnam', 'vijayawada', 'jaipur',
                'lucknow', 'kanpur', 'nagpur', 'indore', 'bhopal', 'patna', 'ranchi', 'bhubaneswar', 'guwahati',
                'chandigarh', 'ludhiana', 'amritsar', 'surat', 'vadodara', 'rajkot'
            ];
            
            
            const tier2Cities = [
                'pondicherry', 'puducherry', 'ooty', 'kodaikanal', 'munnar', 'alleppey', 'alappuzha',
                'tirupati', 'thanjavur', 'kumbakonam', 'mahabalipuram', 'kanyakumari', 'rameswaram',
                'vellore', 'erode', 'tirunelveli', 'dindigul', 'hosur', 'nagercoil', 'karur',
                'udaipur', 'jodhpur', 'pushkar', 'mount abu', 'ajmer', 'shimla', 'manali', 'dharamshala',
                'rishikesh', 'haridwar', 'varanasi', 'agra', 'mathura', 'vrindavan', 'khajuraho',
                'goa', 'panaji', 'margao', 'puri', 'konark', 'darjeeling', 'gangtok', 'shillong'
            ];
            
            const isMetro = metroCities.some(city => cityName.toLowerCase().includes(city));
            const isTier2 = tier2Cities.some(city => cityName.toLowerCase().includes(city));
            
            showThinkingIndicator('üöå Checking transport options...');
            
            if (isMetro) {
                
                const transportPrompt = `Provide public transportation information for ${cityName}. 

CRITICAL FORMATTING - READ CAREFULLY:
- NEVER use asterisks (*) or bold markers (**) 
- Use bullet points with dash (-)
- Use simple text only
- Organize by category with emoji headers

Format (NO ASTERISKS):

üöá Metro/Subway:
- Main lines and routes
- Operating hours
- Average frequency
                
üöå Bus System:
- Main bus operators
- Coverage areas
- Typical timings
                
üöï Ride-Sharing & Taxis:
- Uber and Ola availability
- Auto-rickshaw availability
- Typical fare ranges
                
Keep it concise and practical. Focus on what tourists need to know.

CRITICAL: Do NOT use ** or * anywhere in your response. Use plain text with dashes for bullets.`;
                
                const aiResponse = await askGeminiAI(transportPrompt);
                hideThinkingIndicator();
                addChatMessage(aiResponse.response, false);
                speak("Here's the transport information!");
            } else if (isTier2) {
                
                hideThinkingIndicator();
                const tier2Msg = `üöå Transport in ${cityName}:

${cityName} is a tourist-friendly town with decent transport options.

üöï Ride-Sharing:
- Uber/Ola may be available but with limited drivers
- Wait times can be longer (10-20 mins)
- Better availability during tourist season

üõ∫ Local Options:
- Auto-rickshaws are the most reliable option
- Negotiate fare before starting (or insist on meter)
- Available throughout the town

üöå Public Transport:
- Local and intercity buses available at bus stand
- Check timings at the local bus depot
- State transport buses connect to major cities

üí° Best Advice for ${cityName}:
- For sightseeing: Hire an auto for half-day/full-day (negotiate beforehand)
- For short trips: Use auto-rickshaws
- For intercity: Book bus tickets in advance during peak season
- Download Ola/Uber apps as backup but don't rely solely on them`;
                
                addChatMessage(tier2Msg, false);
                speak(`${cityName} has auto-rickshaws and some ride-sharing options. Auto-rickshaws are your most reliable choice here.`);
            } else {
                
                hideThinkingIndicator();
                const smallTownMsg = `üöå Transport in ${cityName}:

${cityName} is a smaller town without major ride-sharing services like Uber or Ola.

üõ∫ What's Available:
- Auto-rickshaws (most common and reliable)
- Cycle rickshaws in some areas
- Local shared autos/vans for specific routes
- Town buses (limited schedules)

üöå Intercity Travel:
- State transport buses from the bus stand
- Private buses to nearby cities
- Shared taxis/vans to neighboring towns

üí° Pro Tips for ${cityName}:
- Ask your hotel to arrange a trusted auto driver
- Negotiate auto fare before starting your trip
- For temple visits, many autos offer package rates
- Local drivers often double as guides - utilize their knowledge!
- Keep cash handy as digital payments may not work everywhere

üöó Best Option:
If visiting multiple places, consider hiring a local taxi/auto for the full day. Ask your accommodation for recommendations - they usually know trustworthy drivers.`;
                
                addChatMessage(smallTownMsg, false);
                speak(`${cityName} is a smaller town. Uber and Ola are not available here. Auto-rickshaws are your best option, and I'd recommend hiring one for the day through your hotel.`);
            }
            
            saveToHistory(`Transport in ${cityName}`, 'Provided transport information');
        }
        
        
        function processSuggestion(text) {
            document.getElementById('text-input').value = text;
            sendTextInput();
        }

        async function processCommand(text) {
            const lower = text.toLowerCase();
            
            
            if (!localStorage.getItem('unify_has_visited')) {
                localStorage.setItem('unify_has_visited', 'true');
                const suggestionsBox = document.getElementById('initial-suggestions');
                if (suggestionsBox) {
                    suggestionsBox.style.display = 'none';
                }
            }
            
            
            const isWeatherQuery = lower.includes('weather') || lower.includes('temperature') || 
                                   lower.includes('rain') || lower.includes('snow') || 
                                   lower.includes('forecast') || lower.includes('hot') || lower.includes('cold');
            
            const isShoppingQuery = lower.includes('shopping') || lower.includes('grocery') || 
                                    (lower.includes('add') && lower.includes('list'));
            
            const isReminderQuery = lower.includes('remind') || lower.includes('reminder');
            
            
            if (!isWeatherQuery && !waitingForLocation) {
                const weatherCard = document.getElementById('weather-card');
                if (weatherCard && !weatherCard.classList.contains('hidden')) {
                    weatherCard.classList.add('hidden');
                }
            }
            
            
            if (!isShoppingQuery) {
                const shoppingReceipt = document.getElementById('shopping-receipt');
                if (shoppingReceipt && !shoppingReceipt.classList.contains('hidden')) {
                    shoppingReceipt.classList.add('hidden');
                }
            }
            
            
            if (!isReminderQuery) {
                const remindersSection = document.getElementById('reminders-section');
                if (remindersSection && !remindersSection.classList.contains('hidden')) {
                    remindersSection.classList.add('hidden');
                }
            }
            
            
            let cleanText = text;
            const prefixes = ['hey', 'hi', 'hello', 'ok', 'okay', 'well', 'so', 'um', 'uh'];
            for (const prefix of prefixes) {
                const regex = new RegExp(`^${prefix}[,\\s]+`, 'i');
                cleanText = cleanText.replace(regex, '');
            }

            if (waitingForLocation) {
                const cleanLocation = cleanText.replace(/[?!]/g, '').trim();
                
                
                if (cleanLocation.length < 2) {
                    const msg = "I didn't catch that. Please tell me a city or location name.";
                    addChatMessage(msg, false);
                    speak(msg);
                    return;
                }
                
                
                const fillerWords = ['he', 'she', 'it', 'a', 'an', 'the', 'um', 'uh', 'er', 'oh', 'weather'];
                if (fillerWords.includes(cleanLocation.toLowerCase())) {
                    const msg = "I didn't quite catch the location. Could you say it again?";
                    addChatMessage(msg, false);
                    speak(msg);
                    return;
                }
                
                waitingForLocation = false;
                getWeatherByCity(cleanLocation);
                return;
            }

            if (waitingForReminder) {
                waitingForReminder = false;
                createReminderFromText(cleanText);
                return;
            }

            // Handle transport location follow-up
            if (window.waitingForTransportLocation) {
                window.waitingForTransportLocation = false;
                const cityName = cleanText.replace(/[?!]/g, '').trim();

                if (cityName.length < 2) {
                    const msg = "I didn't catch the location. Please tell me which city or town you need transport info for.";
                    addChatMessage(msg, false);
                    speak(msg);
                    window.waitingForTransportLocation = true;
                    return;
                }

                // Major cities with metro/extensive public transport
                const majorCities = [
                    'chennai', 'bangalore', 'bengaluru', 'delhi', 'mumbai', 'kolkata', 'hyderabad',
                    'pune', 'ahmedabad', 'jaipur', 'lucknow', 'kanpur', 'nagpur', 'kochi', 'cochin',
                    'new york', 'nyc', 'los angeles', 'chicago', 'san francisco', 'boston', 'seattle',
                    'london', 'paris', 'tokyo', 'singapore', 'dubai', 'hong kong', 'sydney', 'toronto'
                ];

                const cityLower = cityName.toLowerCase();
                const isMajorCity = majorCities.some(city => cityLower.includes(city));

                let transportMsg;

                if (isMajorCity) {
                    // Major city - show Google Maps transit embed
                    const transitQuery = encodeURIComponent(`transit in ${cityName}`);
                    transportMsg = `üöå **Transport in ${cityName}**

${cityName} has excellent public transportation options!

<div class="map-container" style="margin: 10px 0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
<iframe
  src="https://maps.google.com/maps?q=metro+stations+${transitQuery}&output=embed"
  width="100%"
  height="300"
  style="border:0; display:block;"
  allowfullscreen=""
  loading="lazy">
</iframe>
</div>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîç **Find transit options:**

üöá [Metro/Subway Stations](https://www.google.com/maps/search/metro+station+${encodeURIComponent(cityName)}) - Find nearest stations

üöå [Bus Stops](https://www.google.com/maps/search/bus+stop+${encodeURIComponent(cityName)}) - Local bus routes

üöï [Book a Ride](https://www.google.com/search?q=uber+ola+${encodeURIComponent(cityName)}) - Uber/Ola available

üìç [Google Maps Transit](https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(cityName)}&travelmode=transit) - Plan your route`;

                    speak(`${cityName} has good public transport including metro and buses. Check the map for stations!`);
                } else {
                    // Small town - auto-rickshaws and local transport
                    transportMsg = `üöå **Transport in ${cityName}**

${cityName} is a smaller town. Here's how to get around:

üõ∫ **Auto-Rickshaws** (Most Reliable)
- Available throughout town
- Negotiate fare before starting OR insist on meter
- Typical fare: ‚Çπ20-50 for short trips

üöå **Local Buses**
- Available from the bus stand
- Ask locals for routes and timings
- Very affordable option

üöó **Taxi/Cab Services**
- Uber/Ola may have limited availability
- Ask your hotel to arrange a trusted driver
- Consider hiring for full-day sightseeing

üí° **Pro Tips:**
- Download Ola/Uber as backup but don't rely on them
- Ask hotel staff for trusted auto drivers
- For temple visits, autos often offer package rates
- Keep cash handy - digital payments may not work everywhere

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîç **More info:**

üîé [Search Transport Options](https://www.google.com/search?q=how+to+get+around+${encodeURIComponent(cityName)}) - Local guides

üìç [Find Bus Stand](https://www.google.com/maps/search/bus+stand+${encodeURIComponent(cityName)}) - Main bus terminal`;

                    speak(`${cityName} is a smaller town. Auto-rickshaws are your best bet. I've listed all your options.`);
                }

                addChatMessage(transportMsg, false);
                saveToHistory(text, `Transport info for ${cityName}`);
                return;
            }

            if (window.waitingForLocationChoice && window.pendingLocationChoices) {
                window.waitingForLocationChoice = false;
                const choices = window.pendingLocationChoices;
                
                
                const numberMatch = cleanText.match(/\b([1-9])\b/);
                if (numberMatch) {
                    const choice = parseInt(numberMatch[1]) - 1;
                    if (choice >= 0 && choice < choices.length) {
                        const selected = choices[choice];
                        const lat = parseFloat(selected.lat);
                        const lon = parseFloat(selected.lon);

                        const addr = selected.address;
                        // Prefer city/town over smaller localities
                        let locationName = addr.city || addr.town || addr.municipality || addr.county || addr.village || addr.hamlet || selected.display_name.split(',')[0];
                        if (addr.country_code === 'us' && addr.state) {
                            locationName += `, ${addr.state}`;
                        } else if (addr.state && addr.state !== locationName) {
                            locationName += `, ${addr.state}`;
                            if (addr.country) locationName += `, ${addr.country}`;
                        } else if (addr.country) {
                            locationName += `, ${addr.country}`;
                        }
                        
                        window.pendingLocationChoices = null;
                        await fetchWeather(lat, lon, locationName);
                        return;
                    }
                }
                
                
                for (const loc of choices) {
                    const addr = loc.address;
                    const country = addr.country ? addr.country.toLowerCase() : '';
                    const state = addr.state ? addr.state.toLowerCase() : '';

                    if (cleanText.toLowerCase().includes(country) || cleanText.toLowerCase().includes(state)) {
                        const lat = parseFloat(loc.lat);
                        const lon = parseFloat(loc.lon);

                        // Prefer city/town over smaller localities
                        let locationName = addr.city || addr.town || addr.municipality || addr.county || addr.village || addr.hamlet || loc.display_name.split(',')[0];
                        if (addr.country_code === 'us' && addr.state) {
                            locationName += `, ${addr.state}`;
                        } else if (addr.state && addr.state !== locationName) {
                            locationName += `, ${addr.state}`;
                            if (addr.country) locationName += `, ${addr.country}`;
                        } else if (addr.country) {
                            locationName += `, ${addr.country}`;
                        }
                        
                        window.pendingLocationChoices = null;
                        await fetchWeather(lat, lon, locationName);
                        return;
                    }
                }
                
                
                const msg = "I didn't catch which one you meant. Could you say the number or the country name?";
                addChatMessage(msg, false);
                speak(msg);
                window.waitingForLocationChoice = true;
                return;
            }
            
            
            if (lower.includes('change') && (lower.includes('name') || lower.includes('my name'))) {
                const msg = "What would you like me to call you?";
                addChatMessage(msg, false);
                speak(msg);
                waitingForName = true;
                return;
            }
            
            
            if (lower.match(/^(my name is|i'm|i am|call me|it's)\s+/i)) {
                handleNameInput(cleanText);
                return;
            }
            
            
            if (userName && /^(no|nah|nope|actually|wrong)/i.test(cleanText)) {
                handleNameCorrection(cleanText);
                return;
            }

            
            else if (cleanText.toLowerCase().includes('weather') || cleanText.toLowerCase().includes('temperature') || cleanText.toLowerCase().includes('rain') || cleanText.toLowerCase().includes('snow')) {
                const location = extractLocationFromSentence(cleanText);
                
                if (location) {
                    
                    getWeatherByCity(location);
                } else if (weather && weather.current) {
                    
                    
                    if (cleanText.toLowerCase().includes('rain')) {
                        const willRain = willItRain(weather.current.weather_code);
                        const celsius = Math.round(weather.current.temperature_2m);
                        const fahrenheit = Math.round((celsius * 9/5) + 32);
                        
                        let rainMsg;
                        if (willRain) {
                            rainMsg = `Yes, it looks like rain is expected today. ${getWeatherAdvice(weather)}`;
                        } else {
                            rainMsg = `No, it won't rain today. The temperature is ${fahrenheit}¬∞F (${celsius}¬∞C). ${getWeatherAdvice(weather)}`;
                        }
                        addChatMessage(rainMsg, false);
                        speak(rainMsg);
                    } 
                    
                    else if (cleanText.toLowerCase().includes('snow')) {
                        const willSnow = willItSnow(weather.current.weather_code);
                        const celsius = Math.round(weather.current.temperature_2m);
                        const fahrenheit = Math.round((celsius * 9/5) + 32);
                        
                        let snowMsg;
                        if (willSnow) {
                            snowMsg = `Yes, snow is expected! ${getWeatherAdvice(weather)}`;
                        } else {
                            snowMsg = `No, it won't snow today. The temperature is ${fahrenheit}¬∞F (${celsius}¬∞C). ${getWeatherAdvice(weather)}`;
                        }
                        addChatMessage(snowMsg, false);
                        speak(snowMsg);
                    }
                    
                    else {
                        const celsius = Math.round(weather.current.temperature_2m);
                        const fahrenheit = Math.round((celsius * 9/5) + 32);
                        const advice = getWeatherAdvice(weather);
                        const weatherMsg = `The temperature is ${fahrenheit}¬∞F (${celsius}¬∞C). ${advice}`;
                        addChatMessage(weatherMsg, false);
                        speak(weatherMsg);
                    }
                } else {
                    
                    showThinkingIndicator();
                    
                    if (navigator.geolocation) {
                        
                        navigator.geolocation.getCurrentPosition(
                            async (position) => {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                
                                
                                
                                try {
                                    const reverseResponse = await fetch(
                                        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`,
                                        { headers: { 'User-Agent': 'JARVISVoiceAssistant/1.0' } }
                                    );
                                    const reverseData = await reverseResponse.json();
                                    
                                    
                                    
                                    const addr = reverseData.address;

                                    // Prefer city/town over smaller localities (suburb, village, hamlet, neighbourhood)
                                    // This ensures "Mason, Ohio" instead of "Socialville, Ohio"
                                    let cityName = addr.city ||
                                                   addr.town ||
                                                   addr.municipality ||
                                                   addr.county ||
                                                   addr.village ||
                                                   addr.hamlet ||
                                                   addr.suburb ||
                                                   addr.neighbourhood ||
                                                   addr.state_district ||
                                                   null;

                                    // Format location name based on country
                                    if (cityName) {
                                        // For US: City, State format
                                        if (addr.country_code === 'us' && addr.state) {
                                            cityName = `${cityName}, ${addr.state}`;
                                        } else if (addr.state && addr.state !== cityName) {
                                            // For international: City, State, Country
                                            cityName = `${cityName}, ${addr.state}, ${addr.country}`;
                                        } else if (addr.country && addr.country_code !== 'us') {
                                            cityName = `${cityName}, ${addr.country}`;
                                        }
                                    } else {
                                        // Fallback
                                        cityName = addr.state || addr.country || "your location";
                                    }
                                    
                                    fetchWeather(lat, lon, cityName);
                                } catch (error) {
                                    
                                    fetchWeather(lat, lon, "your location");
                                }
                            },
                            (error) => {
                                
                                hideThinkingIndicator();
                                let askMsg;
                                if (error.code === 1) {
                                    
                                    askMsg = "üìç Location permission was denied. Please tell me your city, or check your browser settings to enable location access.";
                                } else if (error.code === 2) {
                                    
                                    askMsg = "I couldn't determine your location. Where are you? Just say your city!";
                                } else if (error.code === 3) {
                                    
                                    askMsg = "Location detection is taking too long. Where are you located?";
                                } else {
                                    askMsg = "I couldn't detect your location. Where are you?";
                                }
                                addChatMessage(askMsg, false);
                                speak(askMsg);
                                waitingForLocation = true;
                            },
                            {
                                enableHighAccuracy: false, 
                                timeout: 15000, 
                                maximumAge: 300000 
                            }
                        );
                    } else {
                        
                        const askMsg = "Your browser doesn't support location detection. Just tell me your city or town!";
                        addChatMessage(askMsg, false);
                        speak(askMsg);
                        waitingForLocation = true;
                    }
                }
                return; 
            }
            
            if (cleanText.toLowerCase().includes('add') && (cleanText.toLowerCase().includes('shopping list') || cleanText.toLowerCase().includes('shopping') || cleanText.toLowerCase().includes('to my list') || cleanText.toLowerCase().includes('to list'))) {
                handleAddToShoppingList(cleanText);
            }
            
            else if (cleanText.toLowerCase().match(/\b(also|and|plus)\s+add\b/i) || cleanText.toLowerCase().match(/\badd\s+(also|too)\b/i)) {
                handleAddToShoppingList(cleanText);
            }
            
            else if (cleanText.toLowerCase().startsWith('add ') && shoppingList.length > 0) {
                handleAddToShoppingList(cleanText);
            }
            else if (cleanText.toLowerCase().includes('remove') && (cleanText.toLowerCase().includes('shopping list') || cleanText.toLowerCase().includes('from shopping'))) {
                handleRemoveFromShoppingList(cleanText);
            }
            else if ((cleanText.toLowerCase().includes('show') || cleanText.toLowerCase().includes('what') || cleanText.toLowerCase().includes('read')) && cleanText.toLowerCase().includes('shopping')) {
                showShoppingList();
            }
            else if (cleanText.toLowerCase().includes('clear') && cleanText.toLowerCase().includes('shopping')) {
                clearShoppingList();
            }
            
            else if (cleanText.toLowerCase().includes('remind')) {
                createReminderFromText(cleanText);
            }
            
            else if ((cleanText.toLowerCase().includes('show') || cleanText.toLowerCase().includes('my reminder') || cleanText.toLowerCase().includes('list reminder')) && 
                     !cleanText.toLowerCase().includes('shopping')) {
                if (reminders.length === 0) {
                    const msg = "You haven't set any reminders yet. Would you like me to remind you of something?";
                    addChatMessage(msg, false);
                    speak(msg);
                    waitingForReminder = true;
                } else {
                    const msg = `You have ${reminders.length} reminder${reminders.length > 1 ? 's' : ''}. Check the list below.`;
                    addChatMessage(msg, false);
                    speak(msg);
                    document.getElementById('reminders-section').classList.remove('hidden');
                }
            }
            
            else if (cleanText.toLowerCase().includes('clear') && cleanText.toLowerCase().includes('reminder')) {
                clearAllReminders();
            }
            
            else if (
                
                (cleanText.toLowerCase().match(/^where\s+(is|are)\s+my\s+\w+/i) && 
                 !cleanText.toLowerCase().includes('location')) ||
                
                cleanText.toLowerCase().match(/^where\s+did\s+i\s+(put|leave)\s+(my|the)\s+/i) ||
                
                (cleanText.toLowerCase().match(/^find\s+my\s+\w+/i) && 
                 !cleanText.toLowerCase().includes('location'))
            ) {
                handleMemoryRecall(cleanText);
                return; 
            }
            
            else if (
                (cleanText.toLowerCase().includes('my ') || 
                 cleanText.toLowerCase().includes('i put') || 
                 cleanText.toLowerCase().includes('i left')) && 
                (cleanText.toLowerCase().includes(' is ') || 
                 cleanText.toLowerCase().includes(' are ') || 
                 cleanText.toLowerCase().includes(' in ') || 
                 cleanText.toLowerCase().includes(' on ') || 
                 cleanText.toLowerCase().includes(' at ')) &&
                
                !cleanText.toLowerCase().includes('weather') &&
                !cleanText.toLowerCase().includes('location') &&
                !cleanText.toLowerCase().includes('temperature')
            ) {
                handleMemoryStorage(cleanText);
                return; 
            }
            
            else if (cleanText.toLowerCase().match(/\b(who (created|made|built|developed) (you|this|unify)|who (is|are) (your|the) (creator|developer|maker|author)|tell me about (your|the) creator|who owns (you|this))\b/i)) {
                const creatorMsg = `I was created by Prithviraju Venkataraman, a developer passionate about AI and voice interfaces. I was built to help his family mainly with travel planning, weather updates, shopping lists, reminders, and more but later on thought, why not make this as a Vibe Coded Project! Cool isn't it? If you see any bugs or room for improvement, click on Request feature.`;
                addChatMessage(creatorMsg, false);
                speak("I was created by Prithviraju Venkataraman. This started as a family project and became a Vibe Coded Project!");
                return; 
            }
            
            else if (cleanText.toLowerCase().match(/what (can you do|are your features?|features?|do you have|is your feature)/i) ||
                     cleanText.toLowerCase().match(/\b(help|capabilities|what are you)\b/i) ||
                     cleanText.toLowerCase().match(/what (do|can) you (do|offer|provide)/i)) {
                const helpMsg = `Hey! I'm here to make your life easier. Here's what I can help with:

‚úàÔ∏è Travel Planning - Complete trip assistance!
  ‚Üí "Plan a 3-day trip to Tokyo"
  ‚Üí "Create an itinerary for NYC"
  ‚Üí "Hotels in Chennai with non-veg"
  ‚Üí "Best restaurants in Paris"
  ‚Üí Dynamic suggestions (Biryani in India, Pizza in NYC, etc.)
  ‚Üí Share recommendations via SMS/WhatsApp

üöå Transport Info - Get around easily!
  ‚Üí "How to get around Chennai?"
  ‚Üí "Transport in Long Beach"
  ‚Üí Smart advice for big cities vs small towns

üå§Ô∏è Weather - Check weather anywhere!
  ‚Üí "What's the weather?"
  ‚Üí "Will it rain in Seattle?"
  ‚Üí "Temperature in Paris?"

üõí Shopping Lists - Add items with quantities!
  ‚Üí "Add 2 pounds of chicken to my list"
  ‚Üí "Add 1 gallon of milk"
  ‚Üí "Show my shopping list"

‚è∞ Reminders - Never forget again!
  ‚Üí "Remind me to call mom at 5pm"
  ‚Üí "Remind me tomorrow to buy groceries"

üîë Memory - I'll remember where you put things!
  ‚Üí "My car keys are on the counter"
  ‚Üí "Where are my keys?"

üí° Pro Tips:
  ‚Ä¢ Ask for local specialties (Biryani, Pizza, Pasta, etc.)
  ‚Ä¢ Use "Share" button to send to your phone
  ‚Ä¢ Get nightlife, photo spots, shopping suggestions
  ‚Ä¢ I remember your name and preferences!

Just talk to me naturally!`;
                addChatMessage(helpMsg, false);
                speak("I can help with travel planning, transport, weather, shopping lists, reminders, memory, and much more. I even suggest local food based on where you're going!");
                return; 
            }
            
            else if (cleanText.toLowerCase().includes('trip') || 
                     cleanText.toLowerCase().includes('itinerary') || 
                     cleanText.toLowerCase().includes('itenarary') ||
                     cleanText.toLowerCase().includes('itenary') ||
                     cleanText.toLowerCase().includes('vacation') ||
                     cleanText.toLowerCase().includes('visit') && cleanText.toLowerCase().match(/\b(to|in|for)\b/) ||
                     (cleanText.toLowerCase().includes('plan') && (cleanText.toLowerCase().includes('travel') || cleanText.toLowerCase().includes('visit')))) {
                
                // Extract location for web search
                const locationMatch = text.match(/(?:in|to|for|at)\s+([^,?.!]+)/i);
                const itineraryLocation = locationMatch ? locationMatch[1].trim() : '';
                
                // Do web search first to get real places
                let placeSearchResults = '';
                if (itineraryLocation) {
                    try {
                        const searchQueries = [
                            `top tourist places in ${itineraryLocation}`,
                            `things to do in ${itineraryLocation}`,
                            `${itineraryLocation} attractions must visit`
                        ];
                        
                        const searchPromises = searchQueries.map(async (query) => {
                            try {
                                const response = await fetch('/api/search', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ query })
                                });
                                const data = await response.json();
                                return data.results || [];
                            } catch (e) {
                                return [];
                            }
                        });
                        
                        const allResults = await Promise.all(searchPromises);
                        const combinedResults = allResults.flat().slice(0, 8);
                        
                        if (combinedResults.length > 0) {
                            placeSearchResults = '\n\nWEB SEARCH RESULTS - USE THESE REAL PLACES:\n' + 
                                combinedResults.map((r, i) => `${i+1}. ${r.title}: ${r.description}`).join('\n');
                        }
                    } catch (e) {}
                }
                
                const itineraryPrompt = `${userName ? `The user's name is ${userName}.` : ''} Create a day-by-day itinerary for: "${text}".

LOCATION: ${itineraryLocation || 'Extract from user query'}
${placeSearchResults}

‚õî CRITICAL: EVERY ENTRY MUST BE A SPECIFIC, NAMED PLACE
Each activity must have a real, proper name - not generic descriptions.

‚úÖ GOOD (specific names):
- "Eiffel Tower" NOT "famous tower"
- "Central Park" NOT "a park in the city"
- "Taj Mahal" NOT "historic monument"
- "Marina Beach" NOT "visit the beach"
- "Meenakshi Temple" NOT "local temple"
- "Grand Bazaar" NOT "local market"
- "Louvre Museum" NOT "art museum"

‚ùå FORBIDDEN - NEVER INCLUDE THESE:
- Generic activities: "take a walk", "explore the area", "get familiar"
- Transportation as activities: "ride the subway", "take a bus tour"
- Vague suggestions: "visit local shops", "grab lunch", "try street food"
- Unnamed places: "a local temple", "nearby park", "famous monument"
- Filler content: "relax", "reflect on trip", "enjoy the views", "take a break"
- Rest time: "rest at hotel", "unwind", "free time"

‚õî NO REPETITION:
- Each place appears ONLY ONCE across all days
- For week-long trips, include day trips to nearby areas

‚õî EXCLUDE:
- Sports matches, concerts, date-specific events

‚úÖ INCLUDE (always with SPECIFIC NAMES):
- Landmarks and monuments (actual names)
- Museums and galleries (specific names)
- Historic sites (proper names)
- Named parks and gardens
- Famous markets (by name)
- Viewpoints and observation decks (specific names)
- Religious sites (specific temple/church names)
- Notable neighborhoods (by name)

FORMAT (no ** markers):

Day 1 in ${itineraryLocation || '[City]'}:

9:00am: üèõÔ∏è [SPECIFIC PLACE NAME]
   - What to see/do there
   - Duration: X hours

12:00pm: üóΩ [ANOTHER SPECIFIC PLACE]
   - Key highlights
   - Duration: X hours

3-4 NAMED attractions per day. NO generic filler.

End with: "Enjoy exploring ${itineraryLocation || 'the area'}! Ask me about hotels or restaurants separately."

BEFORE RESPONDING: Check that EVERY entry has a specific place name, not generic text!`;
                
                const aiResponse = await callAIWithTyping(itineraryPrompt, 'üó∫Ô∏è Planning your itinerary...');
                addChatMessage(aiResponse.response, false);
                speak("I've created an itinerary for you. Check the chat for details!");
                
                
                saveToHistory(text, aiResponse.response);
                return; 
            }
            
            
            else if (
                
                (cleanText.toLowerCase().match(/\b(food|cuisine|dishes?|specialt(y|ies))\s+(in|of|from)\s+\w+/i)) ||
                
                (cleanText.toLowerCase().match(/\w+\s+(food|cuisine|dishes?|specialt(y|ies))/i) && cleanText.split(' ').length <= 6) ||
                
                (cleanText.toLowerCase().match(/what\s+(to|should|can|do)\s+(eat|try|have)/i)) ||
                
                (cleanText.toLowerCase().match(/\b(famous|special|local|traditional|authentic|signature|must.try|typical)\b/i) && 
                 cleanText.toLowerCase().match(/\b(food|dish|dishes|cuisine|eat)\b/i)) ||
                
                (cleanText.toLowerCase().match(/\b(food|cuisine)\b/i) && !cleanText.toLowerCase().match(/\b(restaurant|hotel|where|best)\b/i))
            ) {
                
                
                
                const specialtyPrompt = `${userName ? `The user's name is ${userName}.` : ''} Answer this question about local food and specialties: "${text}"

‚õî ANTI-HALLUCINATION RULES:
1. ONLY mention dishes that are REAL and ACTUALLY from the region
2. DO NOT invent dish names
3. Stick to well-known, verifiable regional dishes
4. If unsure about a dish, DO NOT include it

Provide information about the LOCAL FOOD CULTURE and FAMOUS DISHES of the region mentioned.

Format:
üçΩÔ∏è Famous Local Dishes:
- Dish name - Brief description and what makes it special
- Where it's typically served (occasion/context)

Include 5-7 REAL signature dishes that represent the local cuisine.

Example for Tamil Nadu region:
üçΩÔ∏è Famous Tamil Nadu Dishes:
- Idli & Sambar - Soft steamed rice cakes with lentil stew, breakfast staple
- Dosa - Crispy rice crepe, served with chutneys and sambar
- Chettinad Chicken - Fiery red curry with aromatic spices, regional specialty
- Pongal - Savory rice and lentil dish, comfort food
- Filter Coffee - Strong South Indian coffee, cultural icon

üå∂Ô∏è What Makes It Special:
[Brief description of the cuisine's characteristics]

üí° Pro Tip: [One helpful tip about trying local food]

DO NOT make up dish names! Only include dishes you're 100% sure exist in that region.`;
                
                const aiResponse = await callAIWithTyping(specialtyPrompt);
                addChatMessage(aiResponse.response, false);
                speak("Let me tell you about the local food specialties!");
                
                
                saveToHistory(text, aiResponse.response);
                return; 
            }
            
            // Hotel/Restaurant/Transport queries
            const isRestaurantMatch = cleanText.toLowerCase().match(/\b(restaurants?|eat|eating|dining|meals?|lunch|dinner|breakfast|cafes?|place to eat|places to eat)\b/i);
            const isHotelMatch = cleanText.toLowerCase().match(/\b(hotel|hotels|stay|staying|accommodation|accommodations|lodge|resort|hostel|place to stay|places to stay|where can i stay|where should i stay)\b/i);
            const isTransportMatch = cleanText.toLowerCase().match(/\b(transport|transportation|bus|train|taxi|uber|ola|auto|rickshaw|metro|subway|getting around|get around|how to reach|how do i get|travel to)\b/i);

            if (isRestaurantMatch || isHotelMatch || isTransportMatch) {

                const queryType = cleanText.toLowerCase().match(/\b(hotel|hotels|stay|staying|accommodation)\b/i) ? 'hotel' : 
                                  cleanText.toLowerCase().match(/\b(transport|bus|train|taxi)\b/i) ? 'transport' : 'food';
                
                // Extract location
                let cityName = '';
                let stateName = '';
                let fullLocation = '';
                
                try {
                    // Extract full location including state/country
                    const fullLocationMatch = text.match(/in\s+([^?.!]+?)(?:\?|$|\.)/i);
                    if (fullLocationMatch) {
                        fullLocation = fullLocationMatch[1].trim();
                        const parts = fullLocation.split(',').map(p => p.trim());
                        cityName = parts[0];
                        stateName = parts.slice(1).join(', ');
                    } else {
                        // Try to extract from current text
                        cityName = text.match(/in\s+([^,?.!]+)/i)?.[1] || 
                                   text.match(/at\s+([^,?.!]+)/i)?.[1] ||
                                   text.match(/for\s+([^,?.!]+)/i)?.[1] || '';
                        
                        // If no city in current text, check conversation context
                        if (!cityName) {
                            const contextText = conversationContext.slice(-6).map(m => m.text).join(' ');
                            // Look for city patterns in context
                            const contextMatch = contextText.match(/(?:hotels?|restaurants?|trip|itinerary|visit)\s+(?:in|to|for|at)\s+([A-Za-z][a-z]+(?:[\s,]+[A-Za-z][a-z]+)*)/i) ||
                                                 contextText.match(/in\s+([A-Za-z][a-z]+(?:,\s*[A-Za-z][a-z]+)*)/i);
                            if (contextMatch) {
                                cityName = contextMatch[1].split(',')[0].trim();
                            }
                        }
                        fullLocation = cityName;
                    }
                    
                    cityName = cityName.trim().replace(/[?.!,]$/, '');
                    fullLocation = fullLocation.trim().replace(/[?.!]$/, '');
                    
                    // Capitalize city name properly
                    const capitalizeWords = (str) => str.split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join(' ');
                    
                    if (cityName) {
                        cityName = capitalizeWords(cityName);
                        fullLocation = capitalizeWords(fullLocation);
                    }
                    
                    // If still no city, ask for it
                    if (!cityName) {
                        if (queryType === 'transport') {
                            const askMsg = "Which city do you need transport information for?";
                            addChatMessage(askMsg, false);
                            speak(askMsg);
                            window.waitingForTransportLocation = true;
                        } else {
                            const askMsg = queryType === 'hotel'
                                ? "Which city would you like hotel recommendations for?"
                                : "Which city would you like restaurant recommendations for?";
                            addChatMessage(askMsg, false);
                            speak(askMsg);
                        }
                        return;
                    }
                    // Show Google Maps embed - FREE, no API needed!
                    if (queryType === 'hotel') {
                        const searchQuery = encodeURIComponent(`hotels in ${fullLocation || cityName}`);
                        const hotelMsg = `üè® **Hotels in ${cityName}**

<div class="map-container" style="margin: 10px 0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
<iframe 
  src="https://maps.google.com/maps?q=hotels+in+${searchQuery}&output=embed"
  width="100%" 
  height="300"
  style="border:0; display:block;" 
  allowfullscreen=""
  loading="lazy"
  referrerpolicy="no-referrer-when-downgrade">
</iframe>
</div>

üìç Click on markers to see ratings, reviews & directions!`;

                        addChatMessage(hotelMsg, false);
                        speak(`Here are hotels in ${cityName}. You can see them on the map!`);
                        
                        saveToHistory(text, `Hotel search for ${cityName}`);
                        showFastFoodBox();
                        return;
                    }
                    
                    // Transport query handling
                    if (queryType === 'transport') {
                        // Major cities with metro/extensive public transport
                        const majorCities = [
                            'chennai', 'bangalore', 'bengaluru', 'delhi', 'mumbai', 'kolkata', 'hyderabad',
                            'pune', 'ahmedabad', 'jaipur', 'lucknow', 'kanpur', 'nagpur', 'kochi', 'cochin',
                            'new york', 'nyc', 'los angeles', 'chicago', 'san francisco', 'boston', 'seattle',
                            'london', 'paris', 'tokyo', 'singapore', 'dubai', 'hong kong', 'sydney', 'toronto'
                        ];

                        const cityLower = cityName.toLowerCase();
                        const isMajorCity = majorCities.some(city => cityLower.includes(city));

                        let transportMsg;

                        if (isMajorCity) {
                            // Major city - show Google Maps transit embed
                            const transitQuery = encodeURIComponent(`transit in ${cityName}`);
                            transportMsg = `üöå **Transport in ${cityName}**

${cityName} has excellent public transportation options!

<div class="map-container" style="margin: 10px 0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
<iframe
  src="https://maps.google.com/maps?q=metro+stations+${transitQuery}&output=embed"
  width="100%"
  height="300"
  style="border:0; display:block;"
  allowfullscreen=""
  loading="lazy">
</iframe>
</div>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîç **Find transit options:**

üöá [Metro/Subway Stations](https://www.google.com/maps/search/metro+station+${encodeURIComponent(cityName)}) - Find nearest stations

üöå [Bus Stops](https://www.google.com/maps/search/bus+stop+${encodeURIComponent(cityName)}) - Local bus routes

üöï [Book a Ride](https://www.google.com/search?q=uber+ola+${encodeURIComponent(cityName)}) - Uber/Ola available

üìç [Google Maps Transit](https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(cityName)}&travelmode=transit) - Plan your route`;

                            speak(`${cityName} has good public transport including metro and buses. Check the map for stations!`);
                        } else {
                            // Small town - auto-rickshaws and local transport
                            transportMsg = `üöå **Transport in ${cityName}**

${cityName} is a smaller town. Here's how to get around:

üõ∫ **Auto-Rickshaws** (Most Reliable)
- Available throughout town
- Negotiate fare before starting OR insist on meter
- Typical fare: ‚Çπ20-50 for short trips

üöå **Local Buses**
- Available from the bus stand
- Ask locals for routes and timings
- Very affordable option

üöó **Taxi/Cab Services**
- Uber/Ola may have limited availability
- Ask your hotel to arrange a trusted driver
- Consider hiring for full-day sightseeing

üí° **Pro Tips:**
- Download Ola/Uber as backup but don't rely on them
- Ask hotel staff for trusted auto drivers
- For temple visits, autos often offer package rates
- Keep cash handy - digital payments may not work everywhere

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîç **More info:**

üîé [Search Transport Options](https://www.google.com/search?q=how+to+get+around+${encodeURIComponent(cityName)}) - Local guides

üìç [Find Bus Stand](https://www.google.com/maps/search/bus+stand+${encodeURIComponent(cityName)}) - Main bus terminal`;

                            speak(`${cityName} is a smaller town. Auto-rickshaws are your best bet. I've listed all your options.`);
                        }

                        addChatMessage(transportMsg, false);
                        saveToHistory(text, `Transport info for ${cityName}`);
                        return;
                    }

                    // Restaurant query - Use AI + Google Search links
                    const restaurantPrompt = `List restaurants and food places in ${fullLocation || cityName}.

IMPORTANT RULES:
1. ONLY mention restaurants you are 100% CERTAIN exist - well-known chains or famous local spots
2. If you're not sure about specific restaurant names in ${cityName}, focus on:
   - Types of restaurants available (vegetarian, non-veg, multi-cuisine)
   - Local food specialties to try
   - What to search for on Google Maps
3. DO NOT invent restaurant names

FORMAT (no ** bold markers, use plain text):

üçΩÔ∏è Restaurants in ${cityName}

[If you know real restaurant names, list 3-5 with brief descriptions]
[If unsure, describe the food scene and what to look for]

üçõ Local Specialties to Try:
- List 3-4 famous dishes of this region

üí° Search Tips:
- What terms to search on Google Maps (e.g., "Mess" for local meals in Tamil Nadu)

Keep response concise - under 200 words.`;

                    const aiResponse = await callAIWithTyping(restaurantPrompt, 'üçΩÔ∏è Finding restaurants...');

                    // Build response with clickable search links
                    const mapsQuery = encodeURIComponent(`restaurants in ${fullLocation || cityName}`);
                    const googleQuery = encodeURIComponent(`best restaurants in ${fullLocation || cityName}`);
                    const tripadvisorQuery = encodeURIComponent(`${fullLocation || cityName} restaurants tripadvisor`);

                    let foodMsg = aiResponse.response + `

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîç **Search for restaurants:**

üìç [Open Google Maps](https://www.google.com/maps/search/${mapsQuery}) - See nearby places with ratings

üîé [Search on Google](https://www.google.com/search?q=${googleQuery}) - Read reviews and articles

‚≠ê [Check TripAdvisor](https://www.google.com/search?q=${tripadvisorQuery}) - Tourist recommendations`;

                    addChatMessage(foodMsg, false);
                    speak(`Here are restaurant suggestions for ${cityName}. I've included search links to find more options!`);

                    saveToHistory(text, `Restaurant search for ${cityName}`);
                    showFastFoodBox();
                    showTransportSuggestion();
                    return;
                } catch (error) {
                    hideThinkingIndicator();
                    // If anything fails, show search links
                    const mapsQuery = encodeURIComponent(`restaurants in ${cityName || 'your area'}`);
                    const googleQuery = encodeURIComponent(`best restaurants in ${cityName || 'your area'}`);

                    const fallbackMsg = `üçΩÔ∏è **Restaurants in ${cityName || 'your area'}**

I had trouble getting specific recommendations, but you can search directly:

üìç [Open Google Maps](https://www.google.com/maps/search/${mapsQuery}) - See nearby restaurants with ratings

üîé [Search on Google](https://www.google.com/search?q=${googleQuery}) - Find reviews and articles

üí° **Tip:** Look for places with 4+ stars and recent reviews!`;
                    addChatMessage(fallbackMsg, false);
                    speak(`Check the search links to find restaurants in ${cityName}!`);
                    return;
                }
            }
            
            else {

                const aiResponse = await callAIWithTyping(text);
                addChatMessage(aiResponse.response, false);
                speak(aiResponse.response);


                saveToHistory(text, aiResponse.response);


                suggestQuickReplies(aiResponse.response);

                // Add feedback buttons for learning
                addFeedbackButtons(text, aiResponse.response);
            }
        }


        function createWeatherEffect(weatherCode, temperature) {
            
            const container = document.getElementById('weather-card');
            
            
            let effectsDiv = container.querySelector('.weather-effect-local');
            if (!effectsDiv) {
                effectsDiv = document.createElement('div');
                effectsDiv.className = 'weather-effect-local';
                container.insertBefore(effectsDiv, container.firstChild);
            }
            
            effectsDiv.innerHTML = ''; 
            
            
            
            
            if (weatherCode >= 71 && weatherCode <= 77) {
                for (let i = 0; i < 20; i++) { 
                    const snowflake = document.createElement('div');
                    snowflake.className = 'snowflake';
                    snowflake.textContent = '‚ùÑ';
                    snowflake.style.left = Math.random() * 100 + '%';
                    snowflake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    snowflake.style.animationDelay = Math.random() * 5 + 's';
                    snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                    effectsDiv.appendChild(snowflake);
                }
                container.style.background = 'linear-gradient(to bottom, #5A6D82, #8B98A8)';
                container.style.color = 'white';
            }
            
            else if ((weatherCode >= 51 && weatherCode <= 67) || (weatherCode >= 80 && weatherCode <= 82)) {
                for (let i = 0; i < 30; i++) { 
                    const raindrop = document.createElement('div');
                    raindrop.className = 'raindrop';
                    raindrop.style.left = Math.random() * 100 + '%';
                    raindrop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                    raindrop.style.animationDelay = Math.random() * 2 + 's';
                    effectsDiv.appendChild(raindrop);
                }
                container.style.background = 'linear-gradient(to bottom, #4A5568, #718096)';
                container.style.color = 'white';
            }
            
            else if (weatherCode >= 95 && weatherCode <= 99) {
                for (let i = 0; i < 25; i++) { 
                    const raindrop = document.createElement('div');
                    raindrop.className = 'raindrop';
                    raindrop.style.left = Math.random() * 100 + '%';
                    raindrop.style.animationDuration = (Math.random() * 0.3 + 0.3) + 's';
                    raindrop.style.animationDelay = Math.random() * 1 + 's';
                    effectsDiv.appendChild(raindrop);
                }
                container.style.background = 'linear-gradient(to bottom, #2D3748, #4A5568)';
                container.style.color = 'white';
            }
            
            else if (weatherCode >= 0 && weatherCode <= 3) {
                const sun = document.createElement('div');
                sun.className = 'sun';
                sun.style.position = 'absolute';
                sun.style.top = '20px';
                sun.style.right = '30px';
                sun.style.width = '60px';
                sun.style.height = '60px';
                effectsDiv.appendChild(sun);
                
                
                if (temperature > 30) {
                    const heatWave = document.createElement('div');
                    heatWave.className = 'heat-wave';
                    effectsDiv.appendChild(heatWave);
                    container.style.background = 'linear-gradient(to bottom, #F59E0B, #FBBF24)';
                    container.style.color = 'white';
                } else {
                    container.style.background = 'linear-gradient(to bottom right, #3B82F6, #60A5FA, #93C5FD)';
                    container.style.color = 'white';
                }
            }
            
            else {
                container.style.background = 'linear-gradient(to bottom, #6B7280, #9CA3AF)';
                container.style.color = 'white';
            }
        }

        function extractLocationFromSentence(text) {
            const lower = text.toLowerCase();
            
            
            const currentLocationKeywords = ['my location', 'current location', 'my current location', 'here', 'where i am', 'my area', 'this location'];
            for (const keyword of currentLocationKeywords) {
                if (lower.includes(keyword)) {
                    return null; 
                }
            }
            
            
            let cleanText = text;
            const timeWords = ['right now', 'now', 'today', 'tomorrow', 'tonight', 'currently', 'at the moment'];
            timeWords.forEach(word => {
                cleanText = cleanText.replace(new RegExp(word, 'gi'), '');
            });
            
            const patterns = [
                /(?:weather|temperature|rain|snow|hot|cold|forecast)\s+(?:in|at|for)\s+([^?]+)/i,
                /(?:in|at)\s+([^?]+?)\s*(?:weather|temperature|rain|snow|hot|cold)/i,
                /(?:how'?s?|what'?s?|how is|what is)\s+(?:the\s+)?(?:weather|temperature)\s+(?:in|at|for)\s+([^?]+)/i,
            ];
            
            for (const pattern of patterns) {
                const match = cleanText.match(pattern);
                if (match && match[1]) {
                    let location = match[1].trim();
                    
                    location = location.replace(/[?.!,;]$/g, '').trim();
                    
                    
                    const locationLower = location.toLowerCase();
                    for (const keyword of currentLocationKeywords) {
                        if (locationLower.includes(keyword)) {
                            return null; 
                        }
                    }
                    
                    if (location.length > 0) return location;
                }
            }
            return null;
        }

        async function getWeatherByCity(cityName) {
            hideThinkingIndicator(); 
            try {
                const searchName = expandStateAbbreviation(cityName.trim());
                
                
                const nominatimResponse = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchName)}&format=json&limit=5&addressdetails=1`,
                    { headers: { 'User-Agent': 'JARVISVoiceAssistant/1.0' } }
                );
                
                const nominatimData = await nominatimResponse.json();
                
                if (!nominatimData || nominatimData.length === 0) {
                    const errorMsg = `Hmm, I couldn't find "${cityName}". Could you try saying it a different way? Like "Boston" or "Paris, France"?`;
                    addChatMessage(errorMsg, false);
                    speak(errorMsg);
                    return;
                }
                
                
                const uniqueLocations = [];
                const seenCountries = new Set();
                
                for (const loc of nominatimData) {
                    const addr = loc.address;
                    const country = addr.country;
                    const state = addr.state || '';
                    const key = `${country}-${state}`;
                    
                    
                    if (!seenCountries.has(key) && uniqueLocations.length < 3) {
                        seenCountries.add(key);
                        uniqueLocations.push(loc);
                    }
                }
                
                
                if (uniqueLocations.length > 1 && !cityName.includes(',')) {
                    const options = uniqueLocations.map((loc, index) => {
                        const addr = loc.address;
                        let name = addr.city || addr.town || addr.village || addr.hamlet || loc.display_name.split(',')[0];
                        if (addr.state) name += `, ${addr.state}`;
                        if (addr.country) name += `, ${addr.country}`;
                        return `${index + 1}. ${name}`;
                    }).join('\n');
                    
                    const disambigMsg = `I found multiple places called "${cityName}":\n\n${options}\n\nWhich one did you mean? You can say the full name or just the number.`;
                    addChatMessage(disambigMsg, false);
                    speak(`I found multiple places called ${cityName}. Which one did you mean?`);
                    
                    
                    window.pendingLocationChoices = uniqueLocations;
                    window.waitingForLocationChoice = true;
                    return;
                }
                
                
                const location = nominatimData[0];
                const latitude = parseFloat(location.lat);
                const longitude = parseFloat(location.lon);
                
                const addr = location.address;
                // Prefer city/town over smaller localities (suburb, village, hamlet, neighbourhood)
                // This ensures "Mason, Ohio" instead of "Socialville, Ohio"
                let locationName = addr.city || addr.town || addr.municipality || addr.county || addr.village || addr.hamlet || location.display_name.split(',')[0];

                // For US locations: City, State format
                // For international: City, State, Country format (skip state if same as city)
                if (addr.country_code === 'us' && addr.state) {
                    locationName += `, ${addr.state}`;
                } else if (addr.state && addr.state !== locationName) {
                    locationName += `, ${addr.state}`;
                    if (addr.country) locationName += `, ${addr.country}`;
                } else if (addr.country) {
                    locationName += `, ${addr.country}`;
                }


                await fetchWeather(latitude, longitude, locationName, cityName.trim());
                
            } catch (error) {
                const errorMsg = `Sorry, I'm having trouble looking that up right now. Mind trying again?`;
                addChatMessage(errorMsg, false);
                speak(errorMsg);
            }
        }

        async function fetchWeather(lat, lon, resolvedLocation, originalQuery = null) {
            hideThinkingIndicator(); 
            showLoading('Checking weather...');
            try {
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,precipitation&timezone=auto`
                );
                weather = await weatherResponse.json();
                
                const celsius = Math.round(weather.current.temperature_2m);
                const fahrenheit = Math.round((celsius * 9/5) + 32);
                const advice = getWeatherAdvice(weather);
                
                
                createWeatherEffect(weather.current.weather_code, celsius);
                
                
                
                let displayLocation = resolvedLocation;
                
                document.getElementById('weather-card').classList.remove('hidden');
                document.getElementById('location-name').textContent = displayLocation;
                document.getElementById('temperature').textContent = `${fahrenheit}¬∞F / ${celsius}¬∞C`;
                document.getElementById('weather-advice').textContent = advice;
                
                hideLoading();
                const weatherMsg = `The temperature in ${displayLocation} is ${fahrenheit}¬∞F (${celsius}¬∞C). ${advice}`;
                addChatMessage(weatherMsg, false);
                speak(weatherMsg);
                
            } catch (error) {
                hideLoading();
                const errorMsg = "Sorry, I couldn't fetch the weather data right now. Please try again later.";
                addChatMessage(errorMsg, false);
                speak(errorMsg);
            }
        }

        function getWeatherAdvice(weatherData) {
            const code = weatherData.current.weather_code;
            const temp = weatherData.current.temperature_2m;
            
            if (code >= 51 && code <= 67) return "It's going to rain. Don't forget your umbrella!";
            if (code >= 71 && code <= 77) return "Snow expected! Dress warm and stay safe!";
            if (code >= 80 && code <= 99) return "Thunderstorms possible. Stay indoors if you can!";
            if (temp < 5) return "It's freezing outside! Bundle up with warm layers!";
            if (temp > 30) return "Hot day ahead! Stay hydrated and seek shade!";
            if (code === 0) return "Perfect weather! Great day to be outside!";
            return "Have a wonderful day!";
        }

        function willItRain(weatherCode) {
            
            return (weatherCode >= 51 && weatherCode <= 67) || 
                   (weatherCode >= 80 && weatherCode <= 82) || 
                   (weatherCode >= 95 && weatherCode <= 99);
        }

        function willItSnow(weatherCode) {
            
            return (weatherCode >= 71 && weatherCode <= 77) || 
                   (weatherCode >= 85 && weatherCode <= 86);
        }

        function expandStateAbbreviation(location) {
            const states = {
                'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California','CO':'Colorado',
                'CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia','HI':'Hawaii','ID':'Idaho',
                'IL':'Illinois','IN':'Indiana','IA':'Iowa','KS':'Kansas','KY':'Kentucky','LA':'Louisiana',
                'ME':'Maine','MD':'Maryland','MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi',
                'MO':'Missouri','MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey',
                'NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio',
                'OK':'Oklahoma','OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
                'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont','VA':'Virginia',
                'WA':'Washington','WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming'
            };
            
            for (const [abbr, full] of Object.entries(states)) {
                const regex = new RegExp(`\\b${abbr}\\b`, 'gi');
                if (regex.test(location)) return location.replace(regex, full);
            }
            return location;
        }

        
        function createReminderFromText(text) {
            const reminder = {
                id: Date.now(),
                text: text,
                time: extractTime(text),
                created: new Date().toLocaleString(),
                alarmTime: calculateAlarmTime(text)
            };
            reminders.push(reminder);
            saveRemindersToStorage();
            updateRemindersList();
            const reminderMsg = `Got it! I'll remind you: ${text}`;
            addChatMessage(reminderMsg, false);
            speak(reminderMsg);
            
            if (reminder.alarmTime) setAlarm(reminder);
        }

        function extractTime(text) {
            const lower = text.toLowerCase();
            if (lower.includes('tomorrow')) return 'tomorrow';
            if (lower.includes('today')) return 'today';
            if (lower.includes('tonight')) return 'tonight';
            const match = lower.match(/(\d{1,2})\s*(am|pm)/);
            if (match) return match[0];
            return 'later';
        }

        function calculateAlarmTime(text) {
            const lower = text.toLowerCase();
            const now = new Date();
            
            if (lower.includes('tomorrow')) {
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0, 0, 0);
                return tomorrow;
            }
            
            const match = lower.match(/(\d{1,2})\s*(am|pm)/);
            if (match) {
                let hour = parseInt(match[1]);
                const isPM = match[2] === 'pm';
                if (isPM && hour !== 12) hour += 12;
                if (!isPM && hour === 12) hour = 0;
                const alarmTime = new Date(now);
                alarmTime.setHours(hour, 0, 0, 0);
                if (alarmTime < now) alarmTime.setDate(alarmTime.getDate() + 1);
                return alarmTime;
            }
            return null;
        }

        function setAlarm(reminder) {
            if (!reminder.alarmTime) return;
            const timeUntilAlarm = reminder.alarmTime - new Date();
            if (timeUntilAlarm > 0) {
                setTimeout(() => triggerAlarm(reminder), timeUntilAlarm);
            }
        }

        function triggerAlarm(reminder) {
            const overlay = document.getElementById('alarm-overlay');
            const notification = document.getElementById('alarm-notification');
            
            overlay.classList.remove('hidden');
            notification.className = 'alarm-notification bg-white rounded-3xl shadow-2xl p-8 max-w-md';
            notification.innerHTML = `
                <div class="text-center">
                    <div class="mb-4">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600 mx-auto animate-bounce">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">‚è∞ Reminder!</h2>
                    <p class="text-lg text-gray-700 mb-6">${escapeHtml(reminder.text)}</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="snoozeAlarm(${reminder.id})" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl transition-all">
                            Snooze 5min
                        </button>
                        <button onclick="dismissAlarm(${reminder.id})" class="px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-xl transition-all">
                            Dismiss
                        </button>
                    </div>
                </div>
            `;
            speak(`Reminder: ${reminder.text}`);
        }

        function snoozeAlarm(id) {
            const reminder = reminders.find(r => r.id === id);
            if (reminder) {
                reminder.alarmTime = new Date(Date.now() + 5 * 60 * 1000);
                setAlarm(reminder);
                saveRemindersToStorage();
            }
            dismissAlarm(id);
        }

        function dismissAlarm(id) {
            document.getElementById('alarm-overlay').classList.add('hidden');
            document.getElementById('alarm-notification').classList.add('hidden');
        }

        function checkReminders() {
            setInterval(() => {
                const now = new Date();
                reminders.forEach(reminder => {
                    if (reminder.alarmTime && reminder.alarmTime <= now && !reminder.triggered) {
                        reminder.triggered = true;
                        triggerAlarm(reminder);
                    }
                });
            }, 1000);
        }

        function updateRemindersList() {
            const list = document.getElementById('reminders-list');
            list.innerHTML = '';
            
            if (reminders.length === 0) {
                document.getElementById('reminders-section').classList.add('hidden');
                return;
            }
            
            reminders.forEach(r => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl shadow flex justify-between items-start';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="text-gray-800 font-medium mb-1">${escapeHtml(r.text)}</p>
                        <p class="text-sm text-gray-500">${escapeHtml(r.time)} ‚Ä¢ ${escapeHtml(r.created)}</p>
                    </div>
                    <button onclick="deleteReminder(${r.id})" class="text-red-500 hover:text-red-700 font-medium ml-4 transition-all">Delete</button>
                `;
                list.appendChild(div);
            });
            document.getElementById('reminders-section').classList.remove('hidden');
        }

        function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            saveRemindersToStorage();
            updateRemindersList();
        }

        function clearAllReminders() {
            if (reminders.length === 0) {
                const msg = "You don't have any reminders to clear.";
                addChatMessage(msg, false);
                speak(msg);
                return;
            }
            reminders = [];
            saveRemindersToStorage();
            updateRemindersList();
            const msg = "All reminders have been cleared.";
            addChatMessage(msg, false);
            speak(msg);
        }

        
        function handleNameInput(text) {
            waitingForName = false;
            
            let name = text.trim();
            
            name = name.replace(/^(my name is|i'm|i am|it's|call me)\s+/i, '');
            name = name.replace(/[?.!,]$/g, '');
            
            name = name.charAt(0).toUpperCase() + name.slice(1);
            
            userName = name;
            saveUserData();
            
            const response = `Nice to meet you, ${userName}! How can I help you today?`;
            addChatMessage(response, false);
            speak(response);
        }

        
        function handleAddToShoppingList(text) {
            const lower = text.toLowerCase();
            
            let items = text;
            
            
            const match1 = text.match(/add\s+(.+?)\s+to\s+(?:my\s+)?shopping/i);
            if (match1) {
                items = match1[1];
            } else {
                
                const match2 = text.match(/(?:add|also|and|plus)\s+(.+)/i);
                if (match2) {
                    items = match2[1];
                }
            }
            
            
            items = items.replace(/to (?:my )?shopping list/gi, '');
            items = items.replace(/please/gi, '');
            items = items.replace(/\s+also$/gi, ''); 
            items = items.replace(/\s+too$/gi, ''); 
            
            
            const itemArray = items.split(/,| and |\n/).map(item => item.trim()).filter(item => item.length > 0);
            
            itemArray.forEach(item => {
                
                const formattedItem = item.charAt(0).toUpperCase() + item.slice(1);
                
                if (!shoppingList.some(existing => existing.toLowerCase() === item.toLowerCase())) {
                    shoppingList.push(formattedItem);
                }
            });
            
            saveUserData();
            updateShoppingListUI(true); 
            
            const msg = itemArray.length === 1 
                ? `Added ${itemArray[0]} to your shopping list!` 
                : `Added ${itemArray.join(', ')} to your shopping list!`;
            addChatMessage(msg, false);
            speak(msg);
        }

        function handleRemoveFromShoppingList(text) {
            const lower = text.toLowerCase();
            let item = text;
            
            
            const match1 = text.match(/remove\s+(.+?)\s+from\s+(?:my\s+)?shopping/i);
            if (match1) {
                item = match1[1];
            } else {
                const match2 = text.match(/remove\s+(.+)/i);
                if (match2) {
                    item = match2[1];
                }
            }
            
            item = item.replace(/from (?:my )?shopping list/gi, '').trim();
            
            const index = shoppingList.findIndex(i => i.toLowerCase().includes(item.toLowerCase()));
            if (index !== -1) {
                const removed = shoppingList.splice(index, 1)[0];
                saveUserData();
                updateShoppingListUI(shoppingList.length > 0); 
                const msg = `Removed ${removed} from your shopping list!`;
                addChatMessage(msg, false);
                speak(msg);
            } else {
                const msg = `I couldn't find "${item}" in your shopping list.`;
                addChatMessage(msg, false);
                speak(msg);
            }
        }

        function showShoppingList() {
            if (shoppingList.length === 0) {
                const msg = "Your shopping list is empty. Would you like to add something?";
                addChatMessage(msg, false);
                speak(msg);
            } else {
                const items = shoppingList.join(', ');
                const msg = `You have ${shoppingList.length} item${shoppingList.length > 1 ? 's' : ''} on your shopping list: ${items}`;
                addChatMessage(msg, false);
                speak(msg);
                
                
                document.getElementById('shopping-receipt').classList.remove('hidden');
            }
        }

        function closeShoppingList() {
            const receipt = document.getElementById('shopping-receipt');
            receipt.classList.add('hidden');
        }
        
        function clearShoppingList() {
            if (shoppingList.length === 0) {
                const msg = "Your shopping list is already empty.";
                addChatMessage(msg, false);
                speak(msg);
                return;
            }
            
            shoppingList = [];
            saveUserData();
            updateShoppingListUI(false); 
            
            const msg = "Shopping list cleared!";
            addChatMessage(msg, false);
            speak(msg);
        }

        function updateShoppingListUI(autoShow = false) {
            const receipt = document.getElementById('shopping-receipt');
            const itemsContainer = document.getElementById('receipt-items');
            const countSpan = document.getElementById('receipt-count');
            const dateSpan = document.getElementById('receipt-date');
            
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            dateSpan.textContent = `${dateStr} ${timeStr}`;
            
            if (shoppingList.length === 0) {
                itemsContainer.innerHTML = '<div style="text-align: center; color: #999; font-size: 12px; padding: 20px;">No items yet</div>';
                receipt.classList.add('hidden');
            } else {
                
                if (autoShow) {
                    receipt.classList.remove('hidden');
                }
                itemsContainer.innerHTML = shoppingList.map((item, index) => `
                    <div class="receipt-item">
                        <div class="receipt-item-text">
                            <span class="receipt-bullet">‚Ä¢</span>
                            <span>${escapeHtml(item)}</span>
                        </div>
                        <button onclick="removeShoppingItem(${index})" class="receipt-delete" title="Remove item">‚úï</button>
                    </div>
                `).join('');
            }
            
            countSpan.textContent = shoppingList.length;
            
            
            if (darkMode) {
                receipt.classList.add('dark-mode');
            } else {
                receipt.classList.remove('dark-mode');
            }
        }

        function removeShoppingItem(index) {
            const removed = shoppingList.splice(index, 1)[0];
            saveUserData();
            updateShoppingListUI(shoppingList.length > 0); 
            const msg = `Removed ${removed}`;
            speak(msg);
        }

        
        function handleMemoryStorage(text) {
            const lower = text.toLowerCase();
            
            
            
            let thing = null;
            let location = null;
            let preposition = null;
            
            const patterns = [
                /my\s+(.+?)\s+(?:is|are)\s+(in|on|at)\s+(.+)/i,
                /i\s+put\s+(?:my\s+)?(.+?)\s+(in|on|at)\s+(.+)/i,
                /i\s+left\s+(?:my\s+)?(.+?)\s+(in|on|at)\s+(.+)/i,
                /(?:my\s+)?(.+?)\s+(?:is|are)\s+(in|on|at)\s+(.+)/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match.length === 4) {
                        thing = match[1].trim();
                        preposition = match[2].trim();
                        location = match[3].trim();
                    } else {
                        thing = match[1].trim();
                        location = match[2].trim();
                    }
                    break;
                }
            }
            
            if (thing && location) {
                
                thing = thing.replace(/^(the|my|a|an)\s+/i, '');
                location = location.replace(/[?.!,]$/g, '');
                
                
                const fullLocation = preposition ? `${preposition} ${location}` : location;
                
                
                const normalizedThing = normalizeThing(thing);
                
                memoryStore[normalizedThing] = fullLocation;
                saveUserData();
                
                const msg = `Got it! I'll remember that your ${normalizedThing} ${normalizedThing.endsWith('s') ? 'are' : 'is'} ${fullLocation}.`;
                addChatMessage(msg, false);
                speak(msg);
            } else {
                const msg = "I didn't quite catch that. Try saying something like 'My car keys are on the kitchen counter'";
                addChatMessage(msg, false);
                speak(msg);
            }
        }

        
        function normalizeThing(thing) {
            thing = thing.toLowerCase().trim();
            
            
            const singularToPlural = {
                'key': 'keys',
                'glass': 'glasses',
                'sunglass': 'sunglasses',
                'headphone': 'headphones',
                'earbud': 'earbuds'
            };
            
            
            if (thing.endsWith('s')) {
                return thing;
            }
            
            
            if (singularToPlural[thing]) {
                return singularToPlural[thing];
            }
            
            
            const words = thing.split(' ');
            const lastWord = words[words.length - 1];
            
            if (singularToPlural[lastWord]) {
                words[words.length - 1] = singularToPlural[lastWord];
                return words.join(' ');
            }
            
            
            if (!lastWord.endsWith('s') && words.length > 0) {
                words[words.length - 1] = lastWord + 's';
                return words.join(' ');
            }
            
            return thing;
        }

        function handleMemoryRecall(text) {
            const lower = text.toLowerCase();
            
            
            
            let thing = null;
            
            const patterns = [
                /(?:do you know )?where\s+(?:is|are)\s+(?:my\s+|the\s+)?(.+)/i,
                /(?:do you know )?where\s+did\s+i\s+(?:put|leave)\s+(?:my\s+|the\s+)?(.+)/i,
                /(?:do you know )?where'?s\s+(?:my\s+|the\s+)?(.+)/i,
                /where\s+(?:my\s+|the\s+)?(.+?)\s+(?:is|are)/i,
                /(?:my\s+|the\s+)?(.+)\s+where/i,
                /^(?:my\s+|the\s+)?(.+)\?$/i  
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    thing = match[1].trim();
                    break;
                }
            }
            
            if (thing) {
                thing = thing.replace(/[?.!,]$/g, '');
                thing = thing.replace(/^(the|my|a|an)\s+/i, '');
                
                
                let location = memoryStore[thing.toLowerCase()];
                
                
                if (!location) {
                    const match = findBestMemoryMatch(thing);
                    if (match) {
                        location = match.location;
                        thing = match.thing; 
                    }
                }
                
                if (location) {
                    const msg = `You told me your ${thing} ${thing.endsWith('s') ? 'are' : 'is'} ${location}.`;
                    addChatMessage(msg, false);
                    speak(msg);
                } else {
                    const msg = `I don't remember where your ${thing} ${thing.endsWith('s') ? 'are' : 'is'}. You haven't told me about that yet.`;
                    addChatMessage(msg, false);
                    speak(msg);
                }
            } else {
                const msg = "What are you looking for?";
                addChatMessage(msg, false);
                speak(msg);
            }
        }

        
        function findBestMemoryMatch(query) {
            query = query.toLowerCase();
            const keys = Object.keys(memoryStore);
            
            
            for (const key of keys) {
                
                if (key === query) {
                    return { thing: key, location: memoryStore[key] };
                }
                
                
                if (key === query + 's' || key + 's' === query) {
                    return { thing: key, location: memoryStore[key] };
                }
                
                
                const keySingular = key.replace(/s$/, '');
                const querySingular = query.replace(/s$/, '');
                if (keySingular === querySingular) {
                    return { thing: key, location: memoryStore[key] };
                }
                
                
                if (key.includes(query) || query.includes(key)) {
                    return { thing: key, location: memoryStore[key] };
                }
                
                
                const keyWords = key.split(' ');
                const queryWords = query.split(' ');
                const matchCount = keyWords.filter(kw => queryWords.some(qw => 
                    kw === qw || qw === kw + 's' || kw === qw + 's' ||
                    kw.replace(/s$/, '') === qw.replace(/s$/, '')
                )).length;
                if (matchCount >= Math.min(keyWords.length, queryWords.length)) {
                    return { thing: key, location: memoryStore[key] };
                }
            }
            
            
            let bestMatch = null;
            let bestDistance = Infinity;
            const maxDistance = Math.floor(query.length / 3); 
            
            for (const key of keys) {
                const distance = levenshteinDistance(query, key);
                if (distance < bestDistance && distance <= maxDistance) {
                    bestDistance = distance;
                    bestMatch = key;
                }
            }
            
            if (bestMatch) {
                return { thing: bestMatch, location: memoryStore[bestMatch] };
            }
            
            return null;
        }

        
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, 
                            matrix[i][j - 1] + 1,     
                            matrix[i - 1][j] + 1      
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        
        function getUserStorageKey() {
            
            const safeUserName = (userName || 'default_user').replace(/[^a-zA-Z0-9]/g, '_');
            return `unify_user_data_${safeUserName}`;
        }
        
        function saveUserData() {
            try {
                const data = {
                    userName: userName,
                    shoppingList: shoppingList,
                    memoryStore: memoryStore,
                    reminders: reminders
                };
                const storageKey = getUserStorageKey();
                localStorage.setItem(storageKey, JSON.stringify(data));
            } catch (e) {
            }
        }

        function loadUserData() {
            try {
                const storageKey = getUserStorageKey();
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    const data = JSON.parse(stored);
                    userName = data.userName || null;
                    shoppingList = data.shoppingList || [];
                    memoryStore = data.memoryStore || {};
                    reminders = data.reminders || [];
                    
                    
                    reminders.forEach(r => {
                        if (r.alarmTime) {
                            r.alarmTime = new Date(r.alarmTime);
                            setAlarm(r);
                        }
                    });
                    
                    
                    if (reminders.length > 0) updateRemindersList();
                    if (shoppingList.length > 0) updateShoppingListUI(false); 
                }
            } catch (e) {
            }
        }

        function saveRemindersToStorage() {
            saveUserData(); 
        }

        function loadRemindersFromStorage() {
            
        }

        
        let currentUtterance = null; 
        let currentSpeakerButton = null; 
        
        function toggleSpeak(text, button) {
            
            if (synth.speaking || (typeof responsiveVoice !== 'undefined' && responsiveVoice.isPlaying())) {
                stopSpeaking();
                
                document.querySelectorAll('.speaker-btn').forEach(btn => {
                    btn.querySelector('.play-icon')?.classList.remove('hidden');
                    btn.querySelector('.stop-icon')?.classList.add('hidden');
                });
                currentSpeakerButton = null;
                return;
            }
            
            
            currentSpeakerButton = button;
            button.querySelector('.play-icon')?.classList.add('hidden');
            button.querySelector('.stop-icon')?.classList.remove('hidden');
            speak(text, true); 
        }
        
        function speak(text, force = false) {
            
            if (!autoSpeak && !force) return;
            
            const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
            
            
            if (typeof responsiveVoice !== 'undefined') {
                responsiveVoice.cancel();
                responsiveVoice.speak(cleanText, "UK English Male", { pitch: 0.9, rate: 0.95, volume: 1 });
                return;
            }
            
            synth.cancel();
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(cleanText);
                
                
                const voices = synth.getVoices();
                
                
                const preferredVoice = voices.find(v => 
                    
                    v.name.includes('Daniel') ||         
                    v.name.includes('Alex') ||           
                    v.name.includes('Oliver') ||         
                    (v.name.includes('Google') && v.lang.includes('en-GB') && v.name.includes('Male')) ||
                    
                    (v.lang.includes('en-GB') && !v.name.toLowerCase().includes('female')) ||
                    
                    (v.lang.includes('en-US') && !v.name.toLowerCase().includes('female'))
                ) || voices.find(v => v.lang.startsWith('en')) || voices[0];
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                
                utterance.rate = 0.95;      
                utterance.pitch = 0.9;      
                utterance.volume = 1.0;
                
                
                currentUtterance = utterance;
                
                
                utterance.onend = () => {
                    currentUtterance = null;
                    if (currentSpeakerButton) {
                        currentSpeakerButton.querySelector('.play-icon')?.classList.remove('hidden');
                        currentSpeakerButton.querySelector('.stop-icon')?.classList.add('hidden');
                        currentSpeakerButton = null;
                    }
                };
                
                synth.speak(utterance);
            }, 100);
        }
        
        
        function stopSpeaking() {
            if (typeof responsiveVoice !== 'undefined') {
                responsiveVoice.cancel();
            }
            synth.cancel();
            currentUtterance = null;
        }

function showTypingIndicator() {
    const chatContainer = document.getElementById('chat-container');
    
    
    hideTypingIndicator();
    
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'flex justify-start items-start gap-2 fade-in';
    typingDiv.innerHTML = `
        <div class="bg-gray-200 rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
            </div>
        </div>
    `;
    chatContainer.appendChild(typingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function deleteMessage(button) {
    if (confirm('Delete this message?')) {
        const messageDiv = button.closest('.flex');
        messageDiv.style.transition = 'all 0.2s';
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'scale(0.8)';
        setTimeout(() => messageDiv.remove(), 200);
    }
}

let conversationHistory = [];

function getHistoryStorageKey() {
    const safeUserName = (userName || 'default_user').replace(/[^a-zA-Z0-9]/g, '_');
    return `unify_history_${safeUserName}`;
}

function saveToHistory(userMessage, aiResponse) {
    conversationHistory.push({
        timestamp: new Date().toISOString(),
        user: userMessage,
        ai: aiResponse,
        date: new Date().toLocaleDateString()
    });
    
    
    const historyKey = getHistoryStorageKey();
    localStorage.setItem(historyKey, JSON.stringify(conversationHistory));
}

function loadHistory() {
    const historyKey = getHistoryStorageKey();
    const saved = localStorage.getItem(historyKey);
    if (saved) {
        conversationHistory = JSON.parse(saved);
    }
}

function searchHistory(query) {
    const results = conversationHistory.filter(conv => 
        conv.user.toLowerCase().includes(query.toLowerCase()) ||
        conv.ai.toLowerCase().includes(query.toLowerCase())
    );
    return results;
}

/*

function showHistoryPanel() {
    
    const panel = document.createElement('div');
    panel.id = 'history-panel';
    panel.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    panel.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">Conversation History</h2>
                <button onclick="closeHistoryPanel()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            <div class="p-4 border-b border-gray-200">
                <input 
                    type="text" 
                    id="history-search" 
                    placeholder="Search conversations..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    oninput="filterHistory(this.value)"
                />
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-4">
                ${renderHistoryList()}
            </div>
            <div class="p-4 border-t border-gray-200 flex gap-2">
                <button onclick="exportHistory()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">Export</button>
                <button onclick="clearHistory()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Clear All</button>
            </div>
        </div>
    `;
    document.body.appendChild(panel);
}

function renderHistoryList(filtered = conversationHistory) {
    if (filtered.length === 0) {
        return '<p class="text-gray-500 text-center">No conversations yet</p>';
    }
    
    return filtered.map((conv, index) => `
        <div class="bg-gray-50 rounded-lg p-3 space-y-2">
            <div class="text-xs text-gray-500">${conv.date} ${new Date(conv.timestamp).toLocaleTimeString()}</div>
            <div class="text-sm">
                <div class="font-semibold text-purple-600">You:</div>
                <div class="text-gray-700">${escapeHtml(conv.user)}</div>
            </div>
            <div class="text-sm">
                <div class="font-semibold text-blue-600">JARVIS:</div>
                <div class="text-gray-700">${escapeHtml(conv.ai.substring(0, 150))}${conv.ai.length > 150 ? '...' : ''}</div>
            </div>
        </div>
    `).join('');
}

function filterHistory(query) {
    const results = query ? searchHistory(query) : conversationHistory;
    document.getElementById('history-list').innerHTML = renderHistoryList(results);
}

function closeHistoryPanel() {
    const panel = document.getElementById('history-panel');
    if (panel) panel.remove();
}

function exportHistory() {
    const dataStr = JSON.stringify(conversationHistory, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `unify-history-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

function clearHistory() {
    if (confirm('Clear all conversation history? This cannot be undone.')) {
        conversationHistory = [];
        localStorage.removeItem('unify_history');
        closeHistoryPanel();
        alert('History cleared!');
    }
}
*/

function showThinkingIndicator(message = 'Thinking...') {
    const chatContainer = document.getElementById('chat-container');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.id = 'thinking-indicator';
    thinkingDiv.className = 'flex justify-start items-start gap-2 fade-in';
    
    const bgClass = darkMode ? 'bg-gray-700' : 'bg-gray-100';
    const textClass = darkMode ? 'text-gray-300' : 'text-gray-600';
    
    thinkingDiv.innerHTML = `
        <div class="${bgClass} rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm flex items-center gap-2">
            <div class="flex gap-1">
                <div class="w-2 h-2 ${bgClass === 'bg-gray-700' ? 'bg-purple-400' : 'bg-purple-600'} rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                <div class="w-2 h-2 ${bgClass === 'bg-gray-700' ? 'bg-purple-400' : 'bg-purple-600'} rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                <div class="w-2 h-2 ${bgClass === 'bg-gray-700' ? 'bg-purple-400' : 'bg-purple-600'} rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
            </div>
            <p class="text-sm ${textClass}">${message}</p>
        </div>
    `;
    
    chatContainer.appendChild(thinkingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function hideThinkingIndicator() {
    const thinkingDiv = document.getElementById('thinking-indicator');
    if (thinkingDiv) {
        thinkingDiv.remove();
    }
}

function showError(message) {
    const chatContainer = document.getElementById('chat-container');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'flex justify-center items-center fade-in';
    errorDiv.innerHTML = `
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-sm flex items-center gap-2 animate-shake">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span class="text-sm">${escapeHtml(message)}</span>
        </div>
    `;
    chatContainer.appendChild(errorDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    
    setTimeout(() => {
        errorDiv.style.opacity = '0';
        setTimeout(() => errorDiv.remove(), 300);
    }, 5000);
}

const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .animate-shake {
        animation: shake 0.5s;
    }
`;
document.head.appendChild(style);

loadHistory();

/*
1. TYPING INDICATOR:
   - Call showTypingIndicator() before AI response
   - Call hideTypingIndicator() before showing response

2. DELETE MESSAGES:
   - Already integrated in addChatMessage() with delete button
   - Shows on hover over user messages

3. CONVERSATION HISTORY:
   - Call saveToHistory(userMsg, aiMsg) after each exchange
   - Add button to show history panel: <button onclick="showHistoryPanel()">History</button>
   - Search, export, and clear functions included

4. ERROR FEEDBACK:
   - Call showError("Error message") instead of addChatMessage for errors
   - Visual shake animation + auto-dismiss
*/
</script>
</body>
</html>
